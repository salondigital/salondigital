exec("import re;import base64");exec(base64.b64decode("aW1wb3J0IHhibWMsIHhibWNhZGRvbiwgeGJtY2d1aSwgeGJtY3BsdWdpbiwgb3MsIHN5cywgeGJtY3ZmcywgSFRNTFBhcnNlciwgZ2xvYiwgemlwZmlsZSwganNvbgppbXBvcnQgc2h1dGlsCmltcG9ydCBlcnJubwppbXBvcnQgc3RyaW5nCmltcG9ydCByYW5kb20KaW1wb3J0IHVybGxpYjIsdXJsbGliCmltcG9ydCByZQppbXBvcnQgZG93bmxvYWRlcgppbXBvcnQgZXh0cmFjdAppbXBvcnQgc2tpblN3aXRjaAppbXBvcnQgdGltZQppbXBvcnQgcHlxcmNvZGUKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZSwgZGF0ZXRpbWUsIHRpbWVkZWx0YQp0cnk6ICAgIGZyb20gc3FsaXRlMyBpbXBvcnQgZGJhcGkyIGFzIGRhdGFiYXNlCmV4Y2VwdDogZnJvbSBweXNxbGl0ZTIgaW1wb3J0IGRiYXBpMiBhcyBkYXRhYmFzZQpmcm9tIHN0cmluZyBpbXBvcnQgZGlnaXRzCgpBRERPTl9JRCAgICAgICA9IHhibWNhZGRvbi5BZGRvbigpLmdldEFkZG9uSW5mbygnaWQnKQpBRERPTlRJVExFICAgICA9ICdTYWxvbkRpZ2l0YWwnCkFERE9OICAgICAgICAgID0geGJtY2FkZG9uLkFkZG9uKEFERE9OX0lEKQpWRVJTSU9OICAgICAgICA9IEFERE9OLmdldEFkZG9uSW5mbygndmVyc2lvbicpClVTRVJfQUdFTlQgICAgID0gJ01vemlsbGEvNS4wIChXaW5kb3dzIE5UIDYuMSkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzM1LjAuMTkxNi4xNTMgU2FmYXJpLzUzNy4zNiBTRSAyLlggTWV0YVNyIDEuMCcKRElBTE9HICAgICAgICAgPSB4Ym1jZ3VpLkRpYWxvZygpCkRQICAgICAgICAgICAgID0geGJtY2d1aS5EaWFsb2dQcm9ncmVzcygpCkhPTUUgICAgICAgICAgID0geGJtYy50cmFuc2xhdGVQYXRoKCdzcGVjaWFsOi8vaG9tZS8nKQpYQk1DICAgICAgICAgICA9IHhibWMudHJhbnNsYXRlUGF0aCgnc3BlY2lhbDovL3hibWMvJykKTE9HICAgICAgICAgICAgPSB4Ym1jLnRyYW5zbGF0ZVBhdGgoJ3NwZWNpYWw6Ly9sb2dwYXRoLycpClBST0ZJTEUgICAgICAgID0geGJtYy50cmFuc2xhdGVQYXRoKCdzcGVjaWFsOi8vcHJvZmlsZS8nKQpTT1VSQ0UgICAgICAgICA9IHhibWMudHJhbnNsYXRlUGF0aCgnc291cmNlOi8vJykKQURET05TICAgICAgICAgPSBvcy5wYXRoLmpvaW4oSE9NRSwgICAgICAnYWRkb25zJykKVVNFUkRBVEEgICAgICAgPSBvcy5wYXRoLmpvaW4oSE9NRSwgICAgICAndXNlcmRhdGEnKQpQTFVHSU4gICAgICAgICA9IG9zLnBhdGguam9pbihBRERPTlMsICAgIEFERE9OX0lEKQpQQUNLQUdFUyAgICAgICA9IG9zLnBhdGguam9pbihBRERPTlMsICAgICdwYWNrYWdlcycpCkhJREVTUEFDRVJTICAgID0gJ05vJwpTUEFDRVIgICAgICAgICA9ICc9JwpBRERPTkQgICAgICAgICA9IG9zLnBhdGguam9pbihVU0VSREFUQSwgICdhZGRvbl9kYXRhJykKQURET05EQVRBICAgICAgPSBvcy5wYXRoLmpvaW4oVVNFUkRBVEEsICAnYWRkb25fZGF0YScsIEFERE9OX0lEKQpBRFZBTkNFRCAgICAgICA9IG9zLnBhdGguam9pbihVU0VSREFUQSwgICdhZHZhbmNlZHNldHRpbmdzLnhtbCcpClNPVVJDRVMgICAgICAgID0gb3MucGF0aC5qb2luKFVTRVJEQVRBLCAgJ3NvdXJjZXMueG1sJykKR1VJU0VUVElOR1MgICAgPSBvcy5wYXRoLmpvaW4oVVNFUkRBVEEsICAnZ3Vpc2V0dGluZ3MueG1sJykKRkFWT1VSSVRFUyAgICAgPSBvcy5wYXRoLmpvaW4oVVNFUkRBVEEsICAnZmF2b3VyaXRlcy54bWwnKQpQUk9GSUxFUyAgICAgICA9IG9zLnBhdGguam9pbihVU0VSREFUQSwgICdwcm9maWxlcy54bWwnKQpUSFVNQlMgICAgICAgICA9IG9zLnBhdGguam9pbihVU0VSREFUQSwgICdUaHVtYm5haWxzJykKREFUQUJBU0UgICAgICAgPSBvcy5wYXRoLmpvaW4oVVNFUkRBVEEsICAnRGF0YWJhc2UnKQpGQU5BUlQgICAgICAgICA9IG9zLnBhdGguam9pbihQTFVHSU4sICAgICdmYW5hcnQuanBnJykKSUNPTiAgICAgICAgICAgPSBvcy5wYXRoLmpvaW4oUExVR0lOLCAgICAnaWNvbi5wbmcnKQpBUlQgICAgICAgICAgICA9IG9zLnBhdGguam9pbihQTFVHSU4sICAgICdyZXNvdXJjZXMnLCAnYXJ0JykKV0laTE9HICAgICAgICAgPSBvcy5wYXRoLmpvaW4oQURET05EQVRBLCAnd2l6YXJkLmxvZycpCldISVRFTElTVCAgICAgID0gb3MucGF0aC5qb2luKEFERE9OREFUQSwgJ3doaXRlbGlzdC50eHQnKQpRUkNPREVTICAgICAgICA9IG9zLnBhdGguam9pbihBRERPTkRBVEEsICdRUkNvZGVzJykKU0tJTiAgICAgICAgICAgPSB4Ym1jLmdldFNraW5EaXIoKQpUT0RBWSAgICAgICAgICA9IGRhdGUudG9kYXkoKQpUT01PUlJPVyAgICAgICA9IFRPREFZICsgdGltZWRlbHRhKGRheXM9MSkKVFdPREFZUyAgICAgICAgPSBUT0RBWSArIHRpbWVkZWx0YShkYXlzPTIpClRIUkVFREFZUyAgICAgID0gVE9EQVkgKyB0aW1lZGVsdGEoZGF5cz0zKQpPTkVXRUVLICAgICAgICA9IFRPREFZICsgdGltZWRlbHRhKGRheXM9NykKS09ESVYgICAgICAgICAgPSBmbG9hdCh4Ym1jLmdldEluZm9MYWJlbCgiU3lzdGVtLkJ1aWxkVmVyc2lvbiIpWzo0XSkKRVhDTFVERVMgICAgICAgPSBbQURET05fSUQgLCAncmVwb3NpdG9yeS5zYWxvbmRpZ2l0YWwnXQpCVUlMREZJTEUgICAgICA9ICdodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vcGVkcm9qdWFuYW1lbGllL3VuaXZlcnNpZGFkcGFsL21hc3Rlci9tZmhnMi50eHQnCkFQS0ZJTEUgICAgICAgID0gJ2h0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9wZWRyb2p1YW5hbWVsaWUvdW5pdmVyc2lkYWRwYWwvbWFzdGVyL2FsbXBrLnR4dCcKWU9VVFVCRUZJTEUgICAgPSAnJwpBRERPTkZJTEUgICAgICA9ICdodHRwOi8vJwpBRFZBTkNFREZJTEUgICA9ICdodHRwOi8vJwpBVVRPVVBEQVRFICAgICA9ICdObycKV0laQVJERklMRSAgICAgPSAnaHR0cHM6Ly9zYWxvbmRpZ2l0YWwuZXMvd2l6YXJkLnBocCcKTk9USUZJQ0FUSU9OICAgPSAnaHR0cDovLycKRU5BQkxFICAgICAgICAgPSAnTm8nCkFVVE9JTlNUQUxMICAgID0gJ05vJwpSRVBPQURET05YTUwgICA9ICcnClJFUE9aSVBVUkwgICAgID0gJycKQ09OVEFDVCAgICAgICAgPSAnR3JhY2lhcyBwb3IgYWRxdWlyaXIgdW5vIGRlIG51ZXN0cm9zIHByb2R1Y3RvcywgcGFyYSBkdWRhcyB5IHNvcG9ydGUgZGlyaWphc2UgYWwgZm9ybyBkZSBjbGllbnRlcyAtLT4gd3d3LnNhbG9uZGlnaXRhbC5lcy9mb3JvJwpDT0xPUjEgICAgICAgICA9ICdyZWQnCkNPTE9SMiAgICAgICAgID0gJ3doaXRlJwpJTkNMVURFVklERU8gICA9IEFERE9OLmdldFNldHRpbmcoJ2luY2x1ZGV2aWRlbycpCklOQ0xVREVBTEwgICAgID0gQURET04uZ2V0U2V0dGluZygnaW5jbHVkZWFsbCcpCklOQ0xVREVCT0IgICAgID0gQURET04uZ2V0U2V0dGluZygnaW5jbHVkZWJvYicpCklOQ0xVREVQSE9FTklYID0gQURET04uZ2V0U2V0dGluZygnaW5jbHVkZXBob2VuaXgnKQpJTkNMVURFU1BFQ1RPICA9IEFERE9OLmdldFNldHRpbmcoJ2luY2x1ZGVzcGVjdG8nKQpJTkNMVURFR0VORVNJUyA9IEFERE9OLmdldFNldHRpbmcoJ2luY2x1ZGVnZW5lc2lzJykKSU5DTFVERUVYT0RVUyAgPSBBRERPTi5nZXRTZXR0aW5nKCdpbmNsdWRlZXhvZHVzJykKSU5DTFVERU9ORUNIQU4gPSBBRERPTi5nZXRTZXR0aW5nKCdpbmNsdWRlb25lY2hhbicpCklOQ0xVREVTQUxUUyAgID0gQURET04uZ2V0U2V0dGluZygnaW5jbHVkZXNhbHRzJykKSU5DTFVERVNBTFRTSEQgPSBBRERPTi5nZXRTZXR0aW5nKCdpbmNsdWRlc2FsdHNsaXRlJykKU0hPV0FEVUxUICAgICAgPSBBRERPTi5nZXRTZXR0aW5nKCdhZHVsdCcpCldJWkRFQlVHR0lORyAgID0gQURET04uZ2V0U2V0dGluZygnYWRkb25fZGVidWcnKQpERUJVR0xFVkVMICAgICA9IEFERE9OLmdldFNldHRpbmcoJ2RlYnVnbGV2ZWwnKQpFTkFCTEVXSVpMT0cgICA9IEFERE9OLmdldFNldHRpbmcoJ3dpemFyZGxvZycpCkNMRUFOV0laTE9HICAgID0gQURET04uZ2V0U2V0dGluZygnYXV0b2NsZWFud2l6JykKQ0xFQU5XSVpMT0dCWSAgPSBBRERPTi5nZXRTZXR0aW5nKCd3aXpsb2djbGVhbmJ5JykKQ0xFQU5EQVlTICAgICAgPSBBRERPTi5nZXRTZXR0aW5nKCd3aXpsb2djbGVhbmRheXMnKQpDTEVBTlNJWkUgICAgICA9IEFERE9OLmdldFNldHRpbmcoJ3dpemxvZ2NsZWFuc2l6ZScpCkNMRUFOTElORVMgICAgID0gQURET04uZ2V0U2V0dGluZygnd2l6bG9nY2xlYW5saW5lcycpCklOU1RBTExNRVRIT0QgID0gQURET04uZ2V0U2V0dGluZygnaW5zdGFsbG1ldGhvZCcpCkRFVkVMT1BFUiAgICAgID0gQURET04uZ2V0U2V0dGluZygnZGV2ZWxvcGVyJykKI1RISVJEUEFSVFkgICAgID0gQURET04uZ2V0U2V0dGluZygnZW5hYmxlM3JkJykKI1RISVJEMU5BTUUgICAgID0gQURET04uZ2V0U2V0dGluZygnd2l6YXJkMW5hbWUnKQojVEhJUkQxVVJMICAgICAgPSBBRERPTi5nZXRTZXR0aW5nKCd3aXphcmQxdXJsJykKI1RISVJEMk5BTUUgICAgID0gQURET04uZ2V0U2V0dGluZygnd2l6YXJkMm5hbWUnKQojVEhJUkQyVVJMICAgICAgPSBBRERPTi5nZXRTZXR0aW5nKCd3aXphcmQydXJsJykKI1RISVJEM05BTUUgICAgID0gQURET04uZ2V0U2V0dGluZygnd2l6YXJkM25hbWUnKQojVEhJUkQzVVJMICAgICAgPSBBRERPTi5nZXRTZXR0aW5nKCd3aXphcmQzdXJsJykKQkFDS1VQTE9DQVRJT04gPSBBRERPTi5nZXRTZXR0aW5nKCdwYXRoJykgaWYgbm90IEFERE9OLmdldFNldHRpbmcoJ3BhdGgnKSA9PSAnJyBlbHNlICdzcGVjaWFsOi8vaG9tZS8nCk1ZQlVJTERTICAgICAgID0gb3MucGF0aC5qb2luKEJBQ0tVUExPQ0FUSU9OLCAnU2Fsb25EaWdpdGFsX0JhY2t1cCcsICcnKQpMT0dGSUxFUyAgICAgICA9IFsnbG9nJywgJ3hibWMub2xkLmxvZycsICdrb2RpLmxvZycsICdrb2RpLm9sZC5sb2cnLCAnc3BtYy5sb2cnLCAnc3BtYy5vbGQubG9nJywgJ3R2bWMubG9nJywgJ3R2bWMub2xkLmxvZyddCkRFRkFVTFRQTFVHSU5TID0gWydtZXRhZGF0YS5hbGJ1bS51bml2ZXJzYWwnLCAnbWV0YWRhdGEuYXJ0aXN0cy51bml2ZXJzYWwnLCAnbWV0YWRhdGEuY29tbW9uLmZhbmFydC50dicsICdtZXRhZGF0YS5jb21tb24uaW1kYi5jb20nLCAnbWV0YWRhdGEuY29tbW9uLm11c2ljYnJhaW56Lm9yZycsICdtZXRhZGF0YS50aGVtb3ZpZWRiLm9yZycsICdtZXRhZGF0YS50dmRiLmNvbScsICdzZXJ2aWNlLnhibWMudmVyc2lvbmNoZWNrJ10KTUFYV0laU0laRSAgICAgPSBbMTAwLCAyMDAsIDMwMCwgNDAwLCA1MDAsIDEwMDBdCk1BWFdJWkxJTkVTICAgID0gWzEwMCwgMjAwLCAzMDAsIDQwMCwgNTAwXQpNQVhXSVpEQVRFUyAgICA9IFsxLCAyLCAzLCA3XQoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIE9iamV0b3MgZGUgT3BjaW9uZXMgIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKZGVmIGdldFMobmFtZSk6CiAgICB0cnk6IHJldHVybiBBRERPTi5nZXRTZXR0aW5nKG5hbWUpCiAgICBleGNlcHQ6IHJldHVybiBGYWxzZQoKZGVmIHNldFMobmFtZSwgdmFsdWUpOgogICAgdHJ5OiBBRERPTi5zZXRTZXR0aW5nKG5hbWUsIHZhbHVlKQogICAgZXhjZXB0OiByZXR1cm4gRmFsc2UKCmRlZiBvcGVuUyhuYW1lPSIiKToKICAgIEFERE9OLm9wZW5TZXR0aW5ncygpCgpkZWYgY2xlYXJTKHR5cGUpOgogICAgYnVpbGQgICAgPSB7J2J1aWxkbmFtZSc6JycsICdidWlsZHZlcnNpb24nOicnLCAnYnVpbGR0aGVtZSc6JycsICdsYXRlc3R2ZXJzaW9uJzonJywgJ2xhc3RidWlsZGNoZWNrJzonMjAxNi0wMS0wMSd9CiAgICBpbnN0YWxsICA9IHsnaW5zdGFsbGVkJzonZmFsc2UnLCAnZXh0cmFjdCc6JycsICdlcnJvcnMnOicnfQogICAgZGVmYXVsdCAgPSB7J2RlZmF1bHRza2luaWdub3JlJzonZmFsc2UnLCAnZGVmYXVsdHNraW4nOicnLCAnZGVmYXVsdHNraW5uYW1lJzonJ30KICAgIGxvb2tmZWVsID0gWydkZWZhdWx0LmVuYWJsZXJzc2ZlZWRzJywgJ2RlZmF1bHQuZm9udCcsICdkZWZhdWx0LnJzc2VkaXQnLCAnZGVmYXVsdC5za2luY29sb3JzJywgJ2RlZmF1bHQuc2tpbnRoZW1lJywgJ2RlZmF1bHQuc2tpbnpvb20nLCAnZGVmYXVsdC5zb3VuZHNraW4nLCAnZGVmYXVsdC5zdGFydHVwd2luZG93JywgJ2RlZmF1bHQuc3RlcmVvc3RyZW5ndGgnXQogICAgaWYgdHlwZSA9PSAnYnVpbGQnOgogICAgICAgIGZvciBzZXQgaW4gYnVpbGQ6CiAgICAgICAgICAgIHNldFMoc2V0LCBidWlsZFtzZXRdKQogICAgICAgIGZvciBzZXQgaW4gaW5zdGFsbDoKICAgICAgICAgICAgc2V0UyhzZXQsIGluc3RhbGxbc2V0XSkKICAgICAgICBmb3Igc2V0IGluIGRlZmF1bHQ6CiAgICAgICAgICAgIHNldFMoc2V0LCBkZWZhdWx0W3NldF0pCiAgICAgICAgZm9yIHNldCBpbiBsb29rZmVlbDoKICAgICAgICAgICAgc2V0UyhzZXQsICcnKQogICAgZWxpZiB0eXBlID09ICdkZWZhdWx0JzoKICAgICAgICBmb3Igc2V0IGluIGRlZmF1bHQ6CiAgICAgICAgICAgIHNldFMoc2V0LCBkZWZhdWx0W3NldF0pCiAgICAgICAgZm9yIHNldCBpbiBsb29rZmVlbDoKICAgICAgICAgICAgc2V0UyhzZXQsICcnKQogICAgZWxpZiB0eXBlID09ICdpbnN0YWxsJzoKICAgICAgICBmb3Igc2V0IGluIGluc3RhbGw6CiAgICAgICAgICAgIHNldFMoc2V0LCBpbnN0YWxsW3NldF0pCiAgICBlbGlmIHR5cGUgPT0gJ2xvb2tmZWVsJzoKICAgICAgICBmb3Igc2V0IGluIGxvb2tmZWVsOgogICAgICAgICAgICBzZXRTKHNldCwgJycpCgojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyMjIyMjIEl0ZW1zIGFjdGl2b3MgIyMjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKIyBkZWYgVGV4dEJveGVzKGhlYWRpbmcsYW5ub3VuY2UpOgogICAgIyBjbGFzcyBUZXh0Qm94KCk6CiAgICAgICAgIyBXSU5ET1c9MTAxNDcKICAgICAgICAjIENPTlRST0xfTEFCRUw9MQogICAgICAgICMgQ09OVFJPTF9URVhUQk9YPTUKICAgICAgICAjIGRlZiBfX2luaXRfXyhzZWxmLCphcmdzLCoqa3dhcmdzKToKICAgICAgICAgICAgIyBlYmkoIkFjdGl2YXRlV2luZG93KCVkKSIgJSAoc2VsZi5XSU5ET1csICkpICMgYWN0aXZhdGUgdGhlIHRleHQgdmlld2VyIHdpbmRvdwogICAgICAgICAgICAjIHNlbGYud2luPXhibWNndWkuV2luZG93KHNlbGYuV0lORE9XKSAjIGdldCB3aW5kb3cKICAgICAgICAgICAgIyB4Ym1jLnNsZWVwKDUwMCkgIyBnaXZlIHdpbmRvdyB0aW1lIHRvIGluaXRpYWxpemUKICAgICAgICAgICAgIyBzZWxmLnNldENvbnRyb2xzKCkKICAgICAgICAjIGRlZiBzZXRDb250cm9scyhzZWxmKToKICAgICAgICAgICAgIyBzZWxmLndpbi5nZXRDb250cm9sKHNlbGYuQ09OVFJPTF9MQUJFTCkuc2V0TGFiZWwoaGVhZGluZykgIyBzZXQgaGVhZGluZwogICAgICAgICAgICAjIHRyeTogZj1vcGVuKGFubm91bmNlKTsgdGV4dD1mLnJlYWQoKQogICAgICAgICAgICAjIGV4Y2VwdDogdGV4dD1hbm5vdW5jZQogICAgICAgICAgICAjIHNlbGYud2luLmdldENvbnRyb2woc2VsZi5DT05UUk9MX1RFWFRCT1gpLnNldFRleHQoc3RyKHRleHQpKQogICAgICAgICAgICAjIHJldHVybgogICAgIyBUZXh0Qm94KCkKICAgICMgd2hpbGUgeGJtYy5nZXRDb25kVmlzaWJpbGl0eSgnV2luZG93LklzVmlzaWJsZSgxMDE0NyknKToKICAgICAgICAjIHhibWMuc2xlZXAoNTAwKQoKCkFDVElPTl9QUkVWSU9VU19NRU5VICAgICAgICAgICAgPSAgMTAgICAjIyBFU0MgYWN0aW9uCkFDVElPTl9OQVZfQkFDSyAgICAgICAgICAgICAgICAgPSAgOTIgICAjIyBCYWNrc3BhY2UgYWN0aW9uCkFDVElPTl9NT1ZFX0xFRlQgICAgICAgICAgICAgICAgPSAgIDEgICAjIyBMZWZ0IGFycm93IGtleQpBQ1RJT05fTU9WRV9SSUdIVCAgICAgICAgICAgICAgID0gICAyICAgIyMgUmlnaHQgYXJyb3cga2V5CkFDVElPTl9NT1ZFX1VQICAgICAgICAgICAgICAgICAgPSAgIDMgICAjIyBVcCBhcnJvdyBrZXkKQUNUSU9OX01PVkVfRE9XTiAgICAgICAgICAgICAgICA9ICAgNCAgICMjIERvd24gYXJyb3cga2V5CkFDVElPTl9NT1VTRV9XSEVFTF9VUCAgICAgICAgICAgPSAxMDQgICAjIyBNb3VzZSB3aGVlbCB1cApBQ1RJT05fTU9VU0VfV0hFRUxfRE9XTiAgICAgICAgID0gMTA1ICAgIyMgTW91c2Ugd2hlZWwgZG93bgpBQ1RJT05fTU9WRV9NT1VTRSAgICAgICAgICAgICAgID0gMTA3ICAgIyMgRG93biBhcnJvdyBrZXkKQUNUSU9OX1NFTEVDVF9JVEVNICAgICAgICAgICAgICA9ICAgNyAgICMjIE51bWJlciBQYWQgRW50ZXIKQUNUSU9OX0JBQ0tTUEFDRSAgICAgICAgICAgICAgICA9IDExMCAgICMjID8KQUNUSU9OX01PVVNFX0xFRlRfQ0xJQ0sgICAgICAgICA9IDEwMApBQ1RJT05fTU9VU0VfTE9OR19DTElDSyAgICAgICAgID0gMTA4CmRlZiBUZXh0Qm94KHRpdGxlLCBtc2cpOgogICAgY2xhc3MgVGV4dEJveGVzKHhibWNndWkuV2luZG93WE1MRGlhbG9nKToKICAgICAgICBkZWYgb25Jbml0KHNlbGYpOgogICAgICAgICAgICBzZWxmLnRpdGxlICAgICAgPSAxMDEKICAgICAgICAgICAgc2VsZi5tc2cgICAgICAgID0gMTAyCiAgICAgICAgICAgIHNlbGYuc2Nyb2xsYmFyICA9IDEwMwogICAgICAgICAgICBzZWxmLm9rYnV0dG9uICAgPSAyMDEKICAgICAgICAgICAgc2VsZi5zaG93ZGlhbG9nKCkKCiAgICAgICAgZGVmIHNob3dkaWFsb2coc2VsZik6CiAgICAgICAgICAgIHNlbGYuZ2V0Q29udHJvbChzZWxmLnRpdGxlKS5zZXRMYWJlbCh0aXRsZSkKICAgICAgICAgICAgc2VsZi5nZXRDb250cm9sKHNlbGYubXNnKS5zZXRUZXh0KG1zZykKICAgICAgICAgICAgc2VsZi5zZXRGb2N1c0lkKHNlbGYuc2Nyb2xsYmFyKQogICAgICAgICAgICAKICAgICAgICBkZWYgb25DbGljayhzZWxmLCBjb250cm9sSWQpOgogICAgICAgICAgICBpZiAoY29udHJvbElkID09IHNlbGYub2tidXR0b24pOgogICAgICAgICAgICAgICAgc2VsZi5jbG9zZSgpCiAgICAgICAgCiAgICAgICAgZGVmIG9uQWN0aW9uKHNlbGYsIGFjdGlvbik6CiAgICAgICAgICAgIGlmICAgYWN0aW9uID09IEFDVElPTl9QUkVWSU9VU19NRU5VOiBzZWxmLmNsb3NlKCkKICAgICAgICAgICAgZWxpZiBhY3Rpb24gPT0gQUNUSU9OX05BVl9CQUNLOiBzZWxmLmNsb3NlKCkKICAgICAgICAgICAgCiAgICB0YiA9IFRleHRCb3hlcyggIlRleHRib3gueG1sIiAsIEFERE9OLmdldEFkZG9uSW5mbygncGF0aCcpLCAnRGVmYXVsdFNraW4nLCB0aXRsZT10aXRsZSwgbXNnPW1zZykKICAgIHRiLmRvTW9kYWwoKQogICAgZGVsIHRiCgpkZWYgaGlnaGxpZ2h0VGV4dChtc2cpOgogICAgbXNnID0gbXNnLnJlcGxhY2UoJ1xuJywgJ1tOTF0nKQogICAgbWF0Y2hlcyA9IHJlLmNvbXBpbGUoIi0tPlB5dGhvbiBjYWxsYmFjay9zY3JpcHQgcmV0dXJuZWQgdGhlIGZvbGxvd2luZyBlcnJvcjwtLSguKz8pLS0+RW5kIG9mIFB5dGhvbiBzY3JpcHQgZXJyb3IgcmVwb3J0PC0tIikuZmluZGFsbChtc2cpCiAgICBmb3IgaXRlbSBpbiBtYXRjaGVzOgogICAgICAgIHN0cmluZyA9ICctLT5QeXRob24gY2FsbGJhY2svc2NyaXB0IHJldHVybmVkIHRoZSBmb2xsb3dpbmcgZXJyb3I8LS0lcy0tPkVuZCBvZiBQeXRob24gc2NyaXB0IGVycm9yIHJlcG9ydDwtLScgJSBpdGVtCiAgICAgICAgbXNnICAgID0gbXNnLnJlcGxhY2Uoc3RyaW5nLCAnW0NPTE9SIHJlZF0lc1svQ09MT1JdJyAlIHN0cmluZykKICAgIG1zZyA9IG1zZy5yZXBsYWNlKCdXQVJOSU5HJywgJ1tDT0xPUiB5ZWxsb3ddV0FSTklOR1svQ09MT1JdJykucmVwbGFjZSgnRVJST1InLCAnW0NPTE9SIHJlZF1FUlJPUlsvQ09MT1JdJykucmVwbGFjZSgnW05MXScsICdcbicpLnJlcGxhY2UoJzogRVhDRVBUSU9OIFRocm93biAoUHl0aG9uVG9DcHBFeGNlcHRpb24pIDonLCAnW0NPTE9SIHJlZF06IEVYQ0VQVElPTiBUaHJvd24gKFB5dGhvblRvQ3BwRXhjZXB0aW9uKSA6Wy9DT0xPUl0nKQogICAgbXNnID0gbXNnLnJlcGxhY2UoJ1xcXFwnLCAnXFwnKS5yZXBsYWNlKEhPTUUsICcnKQogICAgcmV0dXJuIG1zZwoKZGVmIExvZ05vdGlmeSh0aXRsZSwgbWVzc2FnZSwgdGltZXM9MjAwMCwgaWNvbj1JQ09OLHNvdW5kPUZhbHNlKToKICAgIERJQUxPRy5ub3RpZmljYXRpb24odGl0bGUsIG1lc3NhZ2UsIGljb24sIGludCh0aW1lcyksIHNvdW5kKQogICAgI2ViaSgnWEJNQy5Ob3RpZmljYXRpb24oJXMsICVzLCAlcywgJXMpJyAlICh0aXRsZSwgbWVzc2FnZSwgdGltZXMsIGljb24pKQoKZGVmIHBlcmNlbnRhZ2UocGFydCwgd2hvbGUpOgogICAgcmV0dXJuIDEwMCAqIGZsb2F0KHBhcnQpL2Zsb2F0KHdob2xlKQoKZGVmIGFkZG9uVXBkYXRlcyhkbz1Ob25lKToKICAgIHNldHRpbmcgPSAnImdlbmVyYWwuYWRkb251cGRhdGVzIicKICAgIGlmIGRvID09ICdzZXQnOgogICAgICAgIHF1ZXJ5ID0gJ3sianNvbnJwYyI6IjIuMCIsICJtZXRob2QiOiJTZXR0aW5ncy5HZXRTZXR0aW5nVmFsdWUiLCJwYXJhbXMiOnsic2V0dGluZyI6JXN9LCAiaWQiOjF9JyAlIChzZXR0aW5nKQogICAgICAgIHJlc3BvbnNlID0geGJtYy5leGVjdXRlSlNPTlJQQyhxdWVyeSkKICAgICAgICBtYXRjaCA9IHJlLmNvbXBpbGUoJ3sidmFsdWUiOiguKz8pfScpLmZpbmRhbGwocmVzcG9uc2UpCiAgICAgICAgaWYgbGVuKG1hdGNoKSA+IDA6IGRlZmF1bHQgPSBtYXRjaFswXQogICAgICAgIGVsc2U6IGRlZmF1bHQgPSAwCiAgICAgICAgc2V0UygnZGVmYXVsdC5hZGRvbnVwZGF0ZScsIHN0cihkZWZhdWx0KSkKICAgICAgICBxdWVyeSA9ICd7Impzb25ycGMiOiIyLjAiLCAibWV0aG9kIjoiU2V0dGluZ3MuU2V0U2V0dGluZ1ZhbHVlIiwicGFyYW1zIjp7InNldHRpbmciOiVzLCJ2YWx1ZSI6JXN9LCAiaWQiOjF9JyAlIChzZXR0aW5nLCAnMicpCiAgICAgICAgcmVzcG9uc2UgPSB4Ym1jLmV4ZWN1dGVKU09OUlBDKHF1ZXJ5KQogICAgZWxpZiBkbyA9PSAncmVzZXQnOgogICAgICAgIHRyeToKICAgICAgICAgICAgdmFsdWUgPSBpbnQoZmxvYXQoZ2V0UygnZGVmYXVsdC5hZGRvbnVwZGF0ZScpKSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHZhbHVlID0gMAogICAgICAgIGlmIG5vdCB2YWx1ZSBpbiBbMCwgMSwgMl06IHZhbHVlID0gMAogICAgICAgIHF1ZXJ5ID0gJ3sianNvbnJwYyI6IjIuMCIsICJtZXRob2QiOiJTZXR0aW5ncy5TZXRTZXR0aW5nVmFsdWUiLCJwYXJhbXMiOnsic2V0dGluZyI6JXMsInZhbHVlIjolc30sICJpZCI6MX0nICUgKHNldHRpbmcsIHZhbHVlKQogICAgICAgIHJlc3BvbnNlID0geGJtYy5leGVjdXRlSlNPTlJQQyhxdWVyeSkKCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwojIyMjIEluZm8gZGUgdmVyc2lvbmVzICMjIyMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCgpkZWYgY2hlY2tCdWlsZChuYW1lLCByZXQpOgogICAgaWYgbm90IHdvcmtpbmdVUkwoQlVJTERGSUxFKSA9PSBUcnVlOiByZXR1cm4gRmFsc2UKICAgIGxpbmsgPSBvcGVuVVJMKEJVSUxERklMRSkucmVwbGFjZSgnXG4nLCcnKS5yZXBsYWNlKCdccicsJycpLnJlcGxhY2UoJ1x0JywnJykucmVwbGFjZSgnZ3VpPSIiJywgJ2d1aT0iaHR0cDovLyInKS5yZXBsYWNlKCd0aGVtZT0iIicsICd0aGVtZT0iaHR0cDovLyInKQogICAgbWF0Y2ggPSByZS5jb21waWxlKCduYW1lPSIlcyIuKz9lcnNpb249IiguKz8pIi4rP3JsPSIoLis/KSIuKz91aT0iKC4rPykiLis/b2RpPSIoLis/KSIuKz9oZW1lPSIoLis/KSIuKz9jb249IiguKz8pIi4rP2FuYXJ0PSIoLis/KSIuKz9yZXZpZXc9IiguKz8pIi4rP2R1bHQ9IiguKz8pIi4rP2VzY3JpcHRpb249IiguKz8pIicgJSBuYW1lKS5maW5kYWxsKGxpbmspCiAgICBpZiBsZW4obWF0Y2gpID4gMDoKICAgICAgICBmb3IgdmVyc2lvbiwgdXJsLCBndWksIGtvZGksIHRoZW1lLCBpY29uLCBmYW5hcnQsIHByZXZpZXcsIGFkdWx0LCBkZXNjcmlwdGlvbiBpbiBtYXRjaDoKICAgICAgICAgICAgaWYgcmV0ICAgPT0gJ3ZlcnNpb24nOiAgICAgICByZXR1cm4gdmVyc2lvbgogICAgICAgICAgICBlbGlmIHJldCA9PSAndXJsJzogICAgICAgICAgIHJldHVybiB1cmwKICAgICAgICAgICAgZWxpZiByZXQgPT0gJ2d1aSc6ICAgICAgICAgICByZXR1cm4gZ3VpCiAgICAgICAgICAgIGVsaWYgcmV0ID09ICdrb2RpJzogICAgICAgICAgcmV0dXJuIGtvZGkKICAgICAgICAgICAgZWxpZiByZXQgPT0gJ3RoZW1lJzogICAgICAgICByZXR1cm4gdGhlbWUKICAgICAgICAgICAgZWxpZiByZXQgPT0gJ2ljb24nOiAgICAgICAgICByZXR1cm4gaWNvbgogICAgICAgICAgICBlbGlmIHJldCA9PSAnZmFuYXJ0JzogICAgICAgIHJldHVybiBmYW5hcnQKICAgICAgICAgICAgZWxpZiByZXQgPT0gJ3ByZXZpZXcnOiAgICAgICByZXR1cm4gcHJldmlldwogICAgICAgICAgICBlbGlmIHJldCA9PSAnYWR1bHQnOiAgICAgICAgIHJldHVybiBhZHVsdAogICAgICAgICAgICBlbGlmIHJldCA9PSAnZGVzY3JpcHRpb24nOiAgIHJldHVybiBkZXNjcmlwdGlvbgogICAgICAgICAgICBlbGlmIHJldCA9PSAnYWxsJzogICAgICAgICAgIHJldHVybiBuYW1lLCB2ZXJzaW9uLCB1cmwsIGd1aSwga29kaSwgdGhlbWUsIGljb24sIGZhbmFydCwgcHJldmlldywgYWR1bHQsIGRlc2NyaXB0aW9uCiAgICBlbHNlOiByZXR1cm4gRmFsc2UKCmRlZiBjaGVja1RoZW1lKG5hbWUsIHRoZW1lLCByZXQpOgogICAgdGhlbWV1cmwgPSBjaGVja0J1aWxkKG5hbWUsICd0aGVtZScpCiAgICBpZiBub3Qgd29ya2luZ1VSTCh0aGVtZXVybCkgPT0gVHJ1ZTogcmV0dXJuIEZhbHNlCiAgICBsaW5rID0gb3BlblVSTCh0aGVtZXVybCkucmVwbGFjZSgnXG4nLCcnKS5yZXBsYWNlKCdccicsJycpLnJlcGxhY2UoJ1x0JywnJykKICAgIG1hdGNoID0gcmUuY29tcGlsZSgnbmFtZT0iJXMiLis/cmw9IiguKz8pIi4rP2Nvbj0iKC4rPykiLis/YW5hcnQ9IiguKz8pIi4rP2R1bHQ9KC4rPykuKz9lc2NyaXB0aW9uPSIoLis/KSInICUgdGhlbWUpLmZpbmRhbGwobGluaykKICAgIGlmIGxlbihtYXRjaCkgPiAwOgogICAgICAgIGZvciB1cmwsIGljb24sIGZhbmFydCwgYWR1bHQsIGRlc2NyaXB0aW9uIGluIG1hdGNoOgogICAgICAgICAgICBpZiByZXQgICA9PSAndXJsJzogICAgICAgICAgIHJldHVybiB1cmwKICAgICAgICAgICAgZWxpZiByZXQgPT0gJ2ljb24nOiAgICAgICAgICByZXR1cm4gaWNvbgogICAgICAgICAgICBlbGlmIHJldCA9PSAnZmFuYXJ0JzogICAgICAgIHJldHVybiBmYW5hcnQKICAgICAgICAgICAgZWxpZiByZXQgPT0gJ2FkdWx0JzogICAgICAgICByZXR1cm4gYWR1bHQKICAgICAgICAgICAgZWxpZiByZXQgPT0gJ2Rlc2NyaXB0aW9uJzogICByZXR1cm4gZGVzY3JpcHRpb24KICAgICAgICAgICAgZWxpZiByZXQgPT0gJ2FsbCc6ICAgICAgICAgICByZXR1cm4gbmFtZSwgdGhlbWUsIHVybCwgaWNvbiwgZmFuYXJ0LCBhZHVsdCwgZGVzY3JpcHRpb24KICAgIGVsc2U6IHJldHVybiBGYWxzZQoKZGVmIGNoZWNrV2l6YXJkKHJldCk6CiAgICBpZiBub3Qgd29ya2luZ1VSTChXSVpBUkRGSUxFKSA9PSBUcnVlOiByZXR1cm4gRmFsc2UKICAgIGxpbmsgPSBvcGVuVVJMKFdJWkFSREZJTEUpLnJlcGxhY2UoJ1xuJywnJykucmVwbGFjZSgnXHInLCcnKS5yZXBsYWNlKCdcdCcsJycpCiAgICBtYXRjaCA9IHJlLmNvbXBpbGUoJ2lkPSIlcyIuKz9lcnNpb249IiguKz8pIi4rP2lwPSIoLis/KSInICUgQURET05fSUQpLmZpbmRhbGwobGluaykKICAgIGlmIGxlbihtYXRjaCkgPiAwOgogICAgICAgIGZvciB2ZXJzaW9uLCB6aXAgaW4gbWF0Y2g6CiAgICAgICAgICAgIGlmIHJldCAgID09ICd2ZXJzaW9uJzogICAgICAgcmV0dXJuIHZlcnNpb24KICAgICAgICAgICAgZWxpZiByZXQgPT0gJ3ppcCc6ICAgICAgICAgICByZXR1cm4gemlwCiAgICAgICAgICAgIGVsaWYgcmV0ID09ICdhbGwnOiAgICAgICAgICAgcmV0dXJuIEFERE9OX0lELCB2ZXJzaW9uLCB6aXAKICAgIGVsc2U6IHJldHVybiBGYWxzZQoKZGVmIGJ1aWxkQ291bnQodmVyPU5vbmUpOgogICAgbGluayAgPSBvcGVuVVJMKEJVSUxERklMRSkucmVwbGFjZSgnXG4nLCcnKS5yZXBsYWNlKCdccicsJycpLnJlcGxhY2UoJ1x0JywnJykKICAgIG1hdGNoID0gcmUuY29tcGlsZSgnbmFtZT0iKC4rPykiLis/b2RpPSIoLis/KSIuKz9kdWx0PSIoLis/KSInKS5maW5kYWxsKGxpbmspCiAgICB0b3RhbCA9IDA7IGNvdW50MTUgPSAwOyBjb3VudDE2ID0gMDsgY291bnQxNyA9IDA7IGNvdW50MTggPSAwOyBoaWRkZW4gPSAwOyBhZHVsdGNvdW50ID0gMAogICAgaWYgbGVuKG1hdGNoKSA+IDA6CiAgICAgICAgZm9yIG5hbWUsIGtvZGksIGFkdWx0IGluIG1hdGNoOgogICAgICAgICAgICBpZiBub3QgU0hPV0FEVUxUID09ICd0cnVlJyBhbmQgYWR1bHQubG93ZXIoKSA9PSAneWVzJzogaGlkZGVuICs9IDE7IGFkdWx0Y291bnQgKz0xOyBjb250aW51ZQogICAgICAgICAgICBpZiBub3QgREVWRUxPUEVSID09ICd0cnVlJyBhbmQgc3RyVGVzdChuYW1lKTogaGlkZGVuICs9IDE7IGNvbnRpbnVlCiAgICAgICAgICAgIGtvZGkgPSBpbnQoZmxvYXQoa29kaSkpCiAgICAgICAgICAgIHRvdGFsICs9IDEKICAgICAgICAgICAgaWYga29kaSA9PSAxODogY291bnQxOCArPSAxCiAgICAgICAgICAgIGVsaWYga29kaSA9PSAxNzogY291bnQxNyArPSAxCiAgICAgICAgICAgIGVsaWYga29kaSA9PSAxNjogY291bnQxNiArPSAxCiAgICAgICAgICAgIGVsaWYga29kaSA8PSAxNTogY291bnQxNSArPSAxCiAgICByZXR1cm4gdG90YWwsIGNvdW50MTUsIGNvdW50MTYsIGNvdW50MTcsIGNvdW50MTgsIGFkdWx0Y291bnQsIGhpZGRlbgoKZGVmIHN0clRlc3Qoc3RyaW5nKToKICAgIGEgPSAoc3RyaW5nLmxvd2VyKCkpLnNwbGl0KCcgJykKICAgIGlmICd0ZXN0JyBpbiBhOiByZXR1cm4gVHJ1ZQogICAgZWxzZTogcmV0dXJuIEZhbHNlCgpkZWYgdGhlbWVDb3VudChuYW1lLCBjb3VudD1UcnVlKToKICAgIHRoZW1lZmlsZSA9IGNoZWNrQnVpbGQobmFtZSwgJ3RoZW1lJykKICAgIGlmIHRoZW1lZmlsZSA9PSAnaHR0cDovLyc6IHJldHVybiBGYWxzZQogICAgbGluayA9IG9wZW5VUkwodGhlbWVmaWxlKS5yZXBsYWNlKCdcbicsJycpLnJlcGxhY2UoJ1xyJywnJykucmVwbGFjZSgnXHQnLCcnKQogICAgbWF0Y2ggPSByZS5jb21waWxlKCduYW1lPSIoLis/KSIuKz9kdWx0PSIoLis/KSInKS5maW5kYWxsKGxpbmspCiAgICBpZiBsZW4obWF0Y2gpID09IDA6IHJldHVybiBGYWxzZQogICAgdGhlbWVzID0gW10KICAgIGZvciBpdGVtLCBhZHVsdCBpbiBtYXRjaDoKICAgICAgICBpZiBub3QgU0hPV0FEVUxUID09ICd0cnVlJyBhbmQgYWR1bHQubG93ZXIoKSA9PSAneWVzJzogY29udGludWUKICAgICAgICB0aGVtZXMuYXBwZW5kKGl0ZW0pCiAgICBpZiBsZW4odGhlbWVzKSA+IDA6CiAgICAgICAgaWYgY291bnQgPT0gVHJ1ZTogcmV0dXJuIGxlbih0aGVtZXMpCiAgICAgICAgZWxzZTogcmV0dXJuIHRoZW1lcwogICAgZWxzZTogcmV0dXJuIEZhbHNlCgojZGVmIHRoaXJkUGFydHkodXJsPU5vbmUpOgojICAgaWYgdXJsID09IE5vbmU6IHJldHVybgojICAgbGluayA9IG9wZW5VUkwodXJsKS5yZXBsYWNlKCdcbicsJycpLnJlcGxhY2UoJ1xyJywnJykucmVwbGFjZSgnXHQnLCcnKQojICAgbWF0Y2ggID0gcmUuY29tcGlsZSgnbmFtZT0iKC4rPykiLis/ZXJzaW9uPSIoLis/KSIuKz9ybD0iKC4rPykiLis/b2RpPSIoLis/KSIuKz9jb249IiguKz8pIi4rP2FuYXJ0PSIoLis/KSIuKz9kdWx0PSIoLis/KSIuKz9lc2NyaXB0aW9uPSIoLis/KSInKS5maW5kYWxsKGxpbmspCiMgICBtYXRjaDIgPSByZS5jb21waWxlKCduYW1lPSIoLis/KSIuKz9ybD0iKC4rPykiLis/bWc9IiguKz8pIi4rP2FuYXJ0PSIoLis/KSIuKz9lc2NyaXB0aW9uPSIoLis/KSInKS5maW5kYWxsKGxpbmspCiMgICBpZiBsZW4obWF0Y2gpID4gMDoKIyAgICAgICByZXR1cm4gVHJ1ZSwgbWF0Y2gKIyAgIGVsaWYgbGVuKG1hdGNoMikgPiAwOgojICAgICAgIHJldHVybiBGYWxzZSwgbWF0Y2gyCiMgICBlbHNlOgojICAgICAgIHJldHVybiBGYWxzZSwgW10KCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwojIyMgQ29tcHJvYmFjaW9uIGRlIFVSTCAjIyMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiAKZGVmIHdvcmtpbmdVUkwodXJsKToKICAgIGlmIHVybCBpbiBbJ2h0dHA6Ly8nLCAnaHR0cHM6Ly8nLCAnJ106IHJldHVybiBGYWxzZQogICAgY2hlY2sgPSAwOyBzdGF0dXMgPSAnJwogICAgd2hpbGUgY2hlY2sgPCAzOgogICAgICAgIGNoZWNrICs9IDEKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlcSA9IHVybGxpYjIuUmVxdWVzdCh1cmwpCiAgICAgICAgICAgIHJlcS5hZGRfaGVhZGVyKCdVc2VyLUFnZW50JywgVVNFUl9BR0VOVCkKICAgICAgICAgICAgcmVzcG9uc2UgPSB1cmxsaWIyLnVybG9wZW4ocmVxKQogICAgICAgICAgICByZXNwb25zZS5jbG9zZSgpCiAgICAgICAgICAgIHN0YXR1cyA9IFRydWUKICAgICAgICAgICAgYnJlYWsKICAgICAgICBleGNlcHQgRXhjZXB0aW9uLCBlOgogICAgICAgICAgICBzdGF0dXMgPSBzdHIoZSkKICAgICAgICAgICAgbG9nKCJFcnJvciBkZSBVUkw6ICVzIFslc10iICUgKGUsIHVybCkpCiAgICAgICAgICAgIHhibWMuc2xlZXAoNTAwKQogICAgcmV0dXJuIHN0YXR1cwogCmRlZiBvcGVuVVJMKHVybCk6CiAgICByZXEgPSB1cmxsaWIyLlJlcXVlc3QodXJsKQogICAgcmVxLmFkZF9oZWFkZXIoJ1VzZXItQWdlbnQnLCBVU0VSX0FHRU5UKQogICAgcmVzcG9uc2UgPSB1cmxsaWIyLnVybG9wZW4ocmVxKQogICAgbGluaz1yZXNwb25zZS5yZWFkKCkKICAgIHJlc3BvbnNlLmNsb3NlKCkKICAgIHJldHVybiBsaW5rCgojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyMjIyMjIEZ1bmNpb25lcyBNaXNjICMjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKZGVmIGdldEtleWJvYXJkKCBkZWZhdWx0PSIiLCBoZWFkaW5nPSIiLCBoaWRkZW49RmFsc2UgKToKICAgIGtleWJvYXJkID0geGJtYy5LZXlib2FyZCggZGVmYXVsdCwgaGVhZGluZywgaGlkZGVuICkKICAgIGtleWJvYXJkLmRvTW9kYWwoKQogICAgaWYga2V5Ym9hcmQuaXNDb25maXJtZWQoKToKICAgICAgICByZXR1cm4gdW5pY29kZSgga2V5Ym9hcmQuZ2V0VGV4dCgpLCAidXRmLTgiICkKICAgIHJldHVybiBkZWZhdWx0CgpkZWYgZ2V0U2l6ZShwYXRoLCB0b3RhbD0wKToKICAgIGZvciBkaXJwYXRoLCBkaXJuYW1lcywgZmlsZW5hbWVzIGluIG9zLndhbGsocGF0aCk6CiAgICAgICAgZm9yIGYgaW4gZmlsZW5hbWVzOgogICAgICAgICAgICBmcCA9IG9zLnBhdGguam9pbihkaXJwYXRoLCBmKQogICAgICAgICAgICB0b3RhbCArPSBvcy5wYXRoLmdldHNpemUoZnApCiAgICByZXR1cm4gdG90YWwKCmRlZiBjb252ZXJ0U2l6ZShudW0sIHN1ZmZpeD0nQicpOgogICAgZm9yIHVuaXQgaW4gWycnLCAnSycsICdNJywgJ0cnXToKICAgICAgICBpZiBhYnMobnVtKSA8IDEwMjQuMDoKICAgICAgICAgICAgcmV0dXJuICIlMy4wMmYgJXMlcyIgJSAobnVtLCB1bml0LCBzdWZmaXgpCiAgICAgICAgbnVtIC89IDEwMjQuMAogICAgcmV0dXJuICIlLjAyZiAlcyVzIiAlIChudW0sICdHJywgc3VmZml4KQoKZGVmIGdldENhY2hlU2l6ZSgpOgogICAgUFJPRklMRUFERE9OREFUQSA9IG9zLnBhdGguam9pbihQUk9GSUxFLCdhZGRvbl9kYXRhJykKICAgIGRiZmlsZXMgICA9IFsKICAgICAgICAob3MucGF0aC5qb2luKEFERE9OREFUQSwgJ3BsdWdpbi52aWRlby5waHN0cmVhbXMnLCAnY2FjaGUuZGInKSksCiAgICAgICAgKG9zLnBhdGguam9pbihBRERPTkRBVEEsICdwbHVnaW4udmlkZW8uYm9iJywgJ2NhY2hlLmRiJykpLAogICAgICAgIChvcy5wYXRoLmpvaW4oQURET05EQVRBLCAncGx1Z2luLnZpZGVvLnNwZWN0bycsICdjYWNoZS5kYicpKSwKICAgICAgICAob3MucGF0aC5qb2luKEFERE9OREFUQSwgJ3BsdWdpbi52aWRlby5nZW5lc2lzJywgJ2NhY2hlLmRiJykpLAogICAgICAgIChvcy5wYXRoLmpvaW4oQURET05EQVRBLCAncGx1Z2luLnZpZGVvLmV4b2R1cycsICdjYWNoZS5kYicpKSwKICAgICAgICAob3MucGF0aC5qb2luKERBVEFCQVNFLCAgJ29uZWNoYW5uZWxjYWNoZS5kYicpKSwKICAgICAgICAob3MucGF0aC5qb2luKERBVEFCQVNFLCAgJ3NhbHRzY2FjaGUuZGInKSksCiAgICAgICAgKG9zLnBhdGguam9pbihEQVRBQkFTRSwgICdzYWx0c2hkLmxpdGUuZGInKSldCiAgICBjYWNoZWxpc3QgPSBbCiAgICAgICAgKFBST0ZJTEVBRERPTkRBVEEpLAogICAgICAgIChBRERPTkRBVEEpLAogICAgICAgIChvcy5wYXRoLmpvaW4oSE9NRSwnY2FjaGUnKSksCiAgICAgICAgKG9zLnBhdGguam9pbihIT01FLCd0ZW1wJykpLAogICAgICAgIChvcy5wYXRoLmpvaW4oJy9wcml2YXRlL3Zhci9tb2JpbGUvTGlicmFyeS9DYWNoZXMvQXBwbGVUVi9WaWRlby8nLCAnT3RoZXInKSksCiAgICAgICAgKG9zLnBhdGguam9pbignL3ByaXZhdGUvdmFyL21vYmlsZS9MaWJyYXJ5L0NhY2hlcy9BcHBsZVRWL1ZpZGVvLycsICdMb2NhbEFuZFJlbnRhbCcpKSwKICAgICAgICAob3MucGF0aC5qb2luKEFERE9OREFUQSwnc2NyaXB0Lm1vZHVsZS5zaW1wbGUuZG93bmxvYWRlcicpKSwKICAgICAgICAob3MucGF0aC5qb2luKEFERE9OREFUQSwncGx1Z2luLnZpZGVvLml0dicsJ0ltYWdlcycpKSwKICAgICAgICAob3MucGF0aC5qb2luKFBST0ZJTEVBRERPTkRBVEEsJ3NjcmlwdC5tb2R1bGUuc2ltcGxlLmRvd25sb2FkZXInKSksCiAgICAgICAgKG9zLnBhdGguam9pbihQUk9GSUxFQURET05EQVRBLCdwbHVnaW4udmlkZW8uaXR2JywnSW1hZ2VzJykpXQogICAgICAgIAogICAgdG90YWxzaXplID0gMAoKICAgIGZvciBpdGVtIGluIGNhY2hlbGlzdDoKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhpdGVtKSBhbmQgbm90IGl0ZW0gaW4gW0FERE9OREFUQSwgUFJPRklMRUFERE9OREFUQV06CiAgICAgICAgICAgIHRvdGFsc2l6ZSA9IGdldFNpemUoaXRlbSwgdG90YWxzaXplKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGZvciByb290LCBkaXJzLCBmaWxlcyBpbiBvcy53YWxrKGl0ZW0pOgogICAgICAgICAgICAgICAgZm9yIGQgaW4gZGlyczoKICAgICAgICAgICAgICAgICAgICBpZiAnY2FjaGUnIGluIGQubG93ZXIoKSBhbmQgbm90IGQubG93ZXIoKSA9PSAnbWV0YV9jYWNoZSc6IHRvdGFsc2l6ZSA9IGdldFNpemUob3MucGF0aC5qb2luKHJvb3QsIGQpLCB0b3RhbHNpemUpCiAgICAKICAgIGlmIElOQ0xVREVWSURFTyA9PSAndHJ1ZSc6CiAgICAgICAgZmlsZXMgPSBbXQogICAgICAgIGlmIElOQ0xVREVBTEwgPT0gJ3RydWUnOiBmaWxlcyA9IGRiZmlsZXMKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBJTkNMVURFQk9CID09ICd0cnVlJzogICAgIGZpbGVzLmFwcGVuZChvcy5wYXRoLmpvaW4oQURET05EQVRBLCAncGx1Z2luLnZpZGVvLmJvYicsICdjYWNoZS5kYicpKQogICAgICAgICAgICBpZiBJTkNMVURFUEhPRU5JWCA9PSAndHJ1ZSc6IGZpbGVzLmFwcGVuZChvcy5wYXRoLmpvaW4oQURET05EQVRBLCAncGx1Z2luLnZpZGVvLnBoc3RyZWFtcycsICdjYWNoZS5kYicpKQogICAgICAgICAgICBpZiBJTkNMVURFU1BFQ1RPID09ICd0cnVlJzogIGZpbGVzLmFwcGVuZChvcy5wYXRoLmpvaW4oQURET05EQVRBLCAncGx1Z2luLnZpZGVvLnNwZWN0bycsICdjYWNoZS5kYicpKQogICAgICAgICAgICBpZiBJTkNMVURFR0VORVNJUyA9PSAndHJ1ZSc6IGZpbGVzLmFwcGVuZChvcy5wYXRoLmpvaW4oQURET05EQVRBLCAncGx1Z2luLnZpZGVvLmdlbmVzaXMnLCAnY2FjaGUuZGInKSkKICAgICAgICAgICAgaWYgSU5DTFVERUVYT0RVUyA9PSAndHJ1ZSc6ICBmaWxlcy5hcHBlbmQob3MucGF0aC5qb2luKEFERE9OREFUQSwgJ3BsdWdpbi52aWRlby5leG9kdXMnLCAnY2FjaGUuZGInKSkKICAgICAgICAgICAgaWYgSU5DTFVERU9ORUNIQU4gPT0gJ3RydWUnOiBmaWxlcy5hcHBlbmQob3MucGF0aC5qb2luKERBVEFCQVNFLCAgJ29uZWNoYW5uZWxjYWNoZS5kYicpKQogICAgICAgICAgICBpZiBJTkNMVURFU0FMVFMgPT0gJ3RydWUnOiAgIGZpbGVzLmFwcGVuZChvcy5wYXRoLmpvaW4oREFUQUJBU0UsICAnc2FsdHNjYWNoZS5kYicpKQogICAgICAgICAgICBpZiBJTkNMVURFU0FMVFNIRCA9PSAndHJ1ZSc6IGZpbGVzLmFwcGVuZChvcy5wYXRoLmpvaW4oREFUQUJBU0UsICAnc2FsdHNoZC5saXRlLmRiJykpCiAgICAgICAgaWYgbGVuKGZpbGVzKSA+IDA6CiAgICAgICAgICAgIGZvciBpdGVtIGluIGZpbGVzOiB0b3RhbHNpemUgPSBnZXRTaXplKGl0ZW0sIHRvdGFsc2l6ZSkKICAgICAgICBlbHNlOiBsb2coIkxpbXBpZXphIGRlIGNhY2hlOiBMaW1waWV6YSBkZSBjYWNoZSBkZSB2aWRlbyBubyBhY3RpdmFkYSIsIHhibWMuTE9HTk9USUNFKQogICAgcmV0dXJuIHRvdGFsc2l6ZQoKZGVmIGdldEluZm8obGFiZWwpOgogICAgdHJ5OiByZXR1cm4geGJtYy5nZXRJbmZvTGFiZWwobGFiZWwpCiAgICBleGNlcHQ6IHJldHVybiBGYWxzZQoKZGVmIHJlbW92ZUZvbGRlcihwYXRoKToKICAgIGxvZygiRWxpbWluYW5kbyBjYXJwZXRhOiAlcyIgJSBwYXRoLCB4Ym1jLkxPR05PVElDRSkKICAgIHRyeTogc2h1dGlsLnJtdHJlZShwYXRoLGlnbm9yZV9lcnJvcnM9VHJ1ZSwgb25lcnJvcj1Ob25lKQogICAgZXhjZXB0OiByZXR1cm4gRmFsc2UKCmRlZiByZW1vdmVGaWxlKHBhdGgpOgogICAgbG9nKCJFbGltaW5hbmRvIGFyY2hpdm86ICVzIiAlIHBhdGgsIHhibWMuTE9HTk9USUNFKQogICAgdHJ5OiAgICBvcy5yZW1vdmUocGF0aCkKICAgIGV4Y2VwdDogcmV0dXJuIEZhbHNlCgpkZWYgY3VyclNraW4oKToKICAgIHJldHVybiB4Ym1jLmdldFNraW5EaXIoKQoKZGVmIGNsZWFuSG91c2UoZm9sZGVyLCBpZ25vcmU9RmFsc2UpOgogICAgbG9nKGZvbGRlcikKICAgIHRvdGFsX2ZpbGVzID0gMDsgdG90YWxfZm9sZHMgPSAwCiAgICBmb3Igcm9vdCwgZGlycywgZmlsZXMgaW4gb3Mud2Fsayhmb2xkZXIpOgogICAgICAgIGlmIGlnbm9yZSA9PSBGYWxzZTogZGlyc1s6XSA9IFtkIGZvciBkIGluIGRpcnMgaWYgZCBub3QgaW4gRVhDTFVERVNdCiAgICAgICAgZmlsZV9jb3VudCA9IDAKICAgICAgICBmaWxlX2NvdW50ICs9IGxlbihmaWxlcykKICAgICAgICBpZiBmaWxlX2NvdW50ID49IDA6CiAgICAgICAgICAgIGZvciBmIGluIGZpbGVzOgogICAgICAgICAgICAgICAgdHJ5OiAKICAgICAgICAgICAgICAgICAgICBvcy51bmxpbmsob3MucGF0aC5qb2luKHJvb3QsIGYpKQogICAgICAgICAgICAgICAgICAgIHRvdGFsX2ZpbGVzICs9IDEKICAgICAgICAgICAgICAgIGV4Y2VwdDogCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBzaHV0aWwucm10cmVlKG9zLnBhdGguam9pbihyb290LCBmKSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZygiRXJyb3IgRWxpbWluYW5kbyAlcyIgJSBmLCB4Ym1jLkxPR0VSUk9SKQogICAgICAgICAgICBmb3IgZCBpbiBkaXJzOgogICAgICAgICAgICAgICAgdG90YWxfZm9sZHMgKz0gMQogICAgICAgICAgICAgICAgdHJ5OiAKICAgICAgICAgICAgICAgICAgICBzaHV0aWwucm10cmVlKG9zLnBhdGguam9pbihyb290LCBkKSkKICAgICAgICAgICAgICAgICAgICB0b3RhbF9mb2xkcyArPSAxCiAgICAgICAgICAgICAgICBleGNlcHQ6IAogICAgICAgICAgICAgICAgICAgIGxvZygiRXJyb3IgRWxpbWluYW5kbyAlcyIgJSBkLCB4Ym1jLkxPR0VSUk9SKQogICAgcmV0dXJuIHRvdGFsX2ZpbGVzLCB0b3RhbF9mb2xkcwoKZGVmIGVtcHR5Zm9sZGVyKGZvbGRlcik6CiAgICB0b3RhbCA9IDAKICAgIGZvciByb290LCBkaXJzLCBmaWxlcyBpbiBvcy53YWxrKGZvbGRlciwgdG9wZG93bj1UcnVlKToKICAgICAgICBkaXJzWzpdID0gW2QgZm9yIGQgaW4gZGlycyBpZiBkIG5vdCBpbiBFWENMVURFU10KICAgICAgICBmaWxlX2NvdW50ID0gMAogICAgICAgIGZpbGVfY291bnQgKz0gbGVuKGZpbGVzKSArIGxlbihkaXJzKQogICAgICAgIGlmIGZpbGVfY291bnQgPT0gMDoKICAgICAgICAgICAgc2h1dGlsLnJtdHJlZShvcy5wYXRoLmpvaW4ocm9vdCkpCiAgICAgICAgICAgIHRvdGFsICs9IDEKICAgICAgICAgICAgbG9nKCJDYXJwZXRhIHZhY2lhOiAlcyIgJSByb290LCB4Ym1jLkxPR05PVElDRSkKICAgIHJldHVybiB0b3RhbAoKZGVmIGxvZyhtc2csIGxldmVsPXhibWMuTE9HREVCVUcpOgogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKEFERE9OREFUQSk6IG9zLm1ha2VkaXJzKEFERE9OREFUQSkKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhXSVpMT0cpOiBmID0gb3BlbihXSVpMT0csICd3Jyk7IGYuY2xvc2UoKQogICAgaWYgV0laREVCVUdHSU5HID09ICdmYWxzZSc6IHJldHVybiBGYWxzZQogICAgaWYgREVCVUdMRVZFTCA9PSAnMCc6IHJldHVybiBGYWxzZQogICAgaWYgREVCVUdMRVZFTCA9PSAnMScgYW5kIG5vdCBsZXZlbCBpbiBbeGJtYy5MT0dOT1RJQ0UsIHhibWMuTE9HRVJST1IsIHhibWMuTE9HU0VWRVJFLCB4Ym1jLkxPR0ZBVEFMXTogcmV0dXJuIEZhbHNlCiAgICBpZiBERUJVR0xFVkVMID09ICcyJzogbGV2ZWwgPSB4Ym1jLkxPR05PVElDRQogICAgdHJ5OgogICAgICAgIGlmIGlzaW5zdGFuY2UobXNnLCB1bmljb2RlKToKICAgICAgICAgICAgbXNnID0gJyVzJyAlIChtc2cuZW5jb2RlKCd1dGYtOCcpKQogICAgICAgIHhibWMubG9nKCclczogJXMnICUgKEFERE9OVElUTEUsIG1zZyksIGxldmVsKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHRyeTogeGJtYy5sb2coJ0ZhbGxvIGRlIGxvZzogJXMnICUgKGUpLCBsZXZlbCkKICAgICAgICBleGNlcHQ6IHBhc3MKICAgIGlmIEVOQUJMRVdJWkxPRyA9PSAndHJ1ZSc6CiAgICAgICAgbGFzdGNoZWNrID0gZ2V0UygnbmV4dGNsZWFuZGF0ZScpIGlmIG5vdCBnZXRTKCduZXh0Y2xlYW5kYXRlJykgPT0gJycgZWxzZSBzdHIoVE9EQVkpCiAgICAgICAgaWYgQ0xFQU5XSVpMT0cgPT0gJ3RydWUnIGFuZCBsYXN0Y2hlY2sgPD0gc3RyKFRPREFZKTogY2hlY2tMb2coKQogICAgICAgIHdpdGggb3BlbihXSVpMT0csICdhJykgYXMgZjoKICAgICAgICAgICAgbGluZSA9ICJbJXMgJXNdICVzIiAlIChkYXRldGltZS5ub3coKS5kYXRlKCksIHN0cihkYXRldGltZS5ub3coKS50aW1lKCkpWzo4XSwgbXNnKQogICAgICAgICAgICBmLndyaXRlKGxpbmUucnN0cmlwKCdcclxuJykrJ1xuJykKCmRlZiBjaGVja0xvZygpOgogICAgbmV4dGNsZWFuID0gZ2V0UygnbmV4dGNsZWFuZGF0ZScpCiAgICBuZXh0ID0gVE9NT1JST1cKICAgIGlmIENMRUFOV0laTE9HQlkgPT0gJzAnOgogICAgICAgIGtlZXAgPSBUT0RBWSAtIHRpbWVkZWx0YShkYXlzPU1BWFdJWkRBVEVTW2ludChmbG9hdChDTEVBTkRBWVMpKV0pCiAgICAgICAgeCAgICA9IDAKICAgICAgICBmICAgID0gb3BlbihXSVpMT0cpOyBhID0gZi5yZWFkKCk7IGYuY2xvc2UoKTsgbGluZXMgPSBhLnNwbGl0KCdcbicpCiAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgIGlmIHN0cihsaW5lWzE6MTFdKSA+PSBzdHIoa2VlcCk6CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB4ICs9IDEKICAgICAgICBuZXdmaWxlID0gbGluZXNbeDpdCiAgICAgICAgd3JpdGluZyA9ICdcbicuam9pbihuZXdmaWxlKQogICAgICAgIGYgPSBvcGVuKFdJWkxPRywgJ3cnKTsgZi53cml0ZSh3cml0aW5nKTsgZi5jbG9zZSgpCiAgICBlbGlmIENMRUFOV0laTE9HQlkgPT0gJzEnOgogICAgICAgIG1heHNpemUgPSBNQVhXSVpTSVpFW2ludChmbG9hdChDTEVBTlNJWkUpKV0qMTAyNAogICAgICAgIGYgICAgPSBvcGVuKFdJWkxPRyk7IGEgPSBmLnJlYWQoKTsgZi5jbG9zZSgpOyBsaW5lcyA9IGEuc3BsaXQoJ1xuJykKICAgICAgICBpZiBvcy5wYXRoLmdldHNpemUoV0laTE9HKSA+PSBtYXhzaXplOgogICAgICAgICAgICBzdGFydCA9IGxlbihsaW5lcykvMgogICAgICAgICAgICBuZXdmaWxlID0gbGluZXNbc3RhcnQ6XQogICAgICAgICAgICB3cml0aW5nID0gJ1xuJy5qb2luKG5ld2ZpbGUpCiAgICAgICAgICAgIGYgPSBvcGVuKFdJWkxPRywgJ3cnKTsgZi53cml0ZSh3cml0aW5nKTsgZi5jbG9zZSgpCiAgICBlbGlmIENMRUFOV0laTE9HQlkgPT0gJzInOgogICAgICAgIGYgICAgICA9IG9wZW4oV0laTE9HKTsgYSA9IGYucmVhZCgpOyBmLmNsb3NlKCk7IGxpbmVzID0gYS5zcGxpdCgnXG4nKQogICAgICAgIG1heGxpbmVzID0gTUFYV0laTElORVNbaW50KGZsb2F0KENMRUFOTElORVMpKV0KICAgICAgICBpZiBsZW4obGluZXMpID4gbWF4bGluZXM6CiAgICAgICAgICAgIHN0YXJ0ID0gbGVuKGxpbmVzKSAtIGludChtYXhsaW5lcy8yKQogICAgICAgICAgICBuZXdmaWxlID0gbGluZXNbc3RhcnQ6XQogICAgICAgICAgICB3cml0aW5nID0gJ1xuJy5qb2luKG5ld2ZpbGUpCiAgICAgICAgICAgIGYgPSBvcGVuKFdJWkxPRywgJ3cnKTsgZi53cml0ZSh3cml0aW5nKTsgZi5jbG9zZSgpCiAgICBzZXRTKCduZXh0Y2xlYW5kYXRlJywgc3RyKG5leHQpKQoKZGVmIGxhdGVzdERCKERCKToKICAgIGlmIERCIGluIFsnQWRkb25zJywgJ0FEU1AnLCAnRXBnJywgJ015TXVzaWMnLCAnTXlWaWRlb3MnLCAnVGV4dHVyZXMnLCAnVFYnLCAnVmlld01vZGVzJ106CiAgICAgICAgbWF0Y2ggPSBnbG9iLmdsb2Iob3MucGF0aC5qb2luKERBVEFCQVNFLCclcyouZGInICUgREIpKQogICAgICAgIGNvbXAgPSAnJXMoLis/KS5kYicgJSBEQlsxOl0KICAgICAgICBoaWdoZXN0ID0gMAogICAgICAgIGZvciBmaWxlIGluIG1hdGNoIDoKICAgICAgICAgICAgdHJ5OiBjaGVjayA9IGludChyZS5jb21waWxlKGNvbXApLmZpbmRhbGwoZmlsZSlbMF0pCiAgICAgICAgICAgIGV4Y2VwdDogY2hlY2sgPSAwCiAgICAgICAgICAgIGlmIGhpZ2hlc3QgPCBjaGVjayA6CiAgICAgICAgICAgICAgICBoaWdoZXN0ID0gY2hlY2sKICAgICAgICByZXR1cm4gJyVzJXMuZGInICUgKERCLCBoaWdoZXN0KQogICAgZWxzZTogcmV0dXJuIEZhbHNlCgpkZWYgYWRkb25JZChhZGQpOgogICAgdHJ5OiAKICAgICAgICByZXR1cm4geGJtY2FkZG9uLkFkZG9uKGlkPWFkZCkKICAgIGV4Y2VwdDoKICAgICAgICByZXR1cm4gRmFsc2UKCmRlZiB0b2dnbGVEZXBlbmRlbmN5KG5hbWUsIERQPU5vbmUpOgogICAgZGVwPW9zLnBhdGguam9pbihBRERPTlMsIG5hbWUsICdhZGRvbi54bWwnKQogICAgaWYgb3MucGF0aC5leGlzdHMoZGVwKToKICAgICAgICBzb3VyY2UgPSBvcGVuKGRlcCxtb2RlPSdyJyk7IGxpbms9c291cmNlLnJlYWQoKTsgc291cmNlLmNsb3NlKCk7IAogICAgICAgIG1hdGNoICA9IHBhcnNlRE9NKGxpbmssICdpbXBvcnQnLCByZXQ9J2FkZG9uJykKICAgICAgICBmb3IgZGVwZW5kcyBpbiBtYXRjaDoKICAgICAgICAgICAgaWYgbm90ICd4Ym1jLnB5dGhvbicgaW4gZGVwZW5kczoKICAgICAgICAgICAgICAgIGRlcGVuZHNwYXRoPW9zLnBhdGguam9pbihBRERPTlMsIGRlcGVuZHMpCiAgICAgICAgICAgICAgICBpZiBub3QgRFAgPT0gTm9uZTogCiAgICAgICAgICAgICAgICAgICAgRFAudXBkYXRlKCIiLCJDb21wcm9iYW5kbyBkZXBlbmRlbmNpYSBbQ09MT1IgeWVsbG93XSVzWy9DT0xPUl0gcGFyYSBbQ09MT1IgeWVsbG93XSVzWy9DT0xPUl0iICUgKGRlcGVuZHMsIG5hbWUpLCIiKQogICAgICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoZGVwZW5kc3BhdGgpOgogICAgICAgICAgICAgICAgICAgIHRvZ2dsZUFkZG9uKG5hbWUsICd0cnVlJykKICAgICAgICAgICAgeGJtYy5zbGVlcCgxMDApCgpkZWYgdG9nZ2xlQWR1bHQoKToKICAgIGRvID0gRElBTE9HLnllc25vKEFERE9OVElUTEUsICJbQ09MT1IgJXNdUXVpZXJlcyBbQ09MT1IgJXNdQWN0aXZhclsvQ09MT1JdIG8gW0NPTE9SICVzXURlc2FjdGl2YXJbL0NPTE9SXSB0b2RvcyBsb3MgYWRkb25zIHBhcmEgYWR1bHRvcz9bL0NPTE9SXSIgJSAoQ09MT1IyLCBDT0xPUjEsIENPTE9SMSksIHllc2xhYmVsPSJbQl1bQ09MT1IgZ3JlZW5dQWN0aXZhclsvQ09MT1JdWy9CXSIsIG5vbGFiZWw9IltCXVtDT0xPUiByZWRdRGVzYWN0aXZhclsvQ09MT1JdWy9CXSIpCiAgICBzdGF0ZSA9ICd0cnVlJyBpZiBkbyA9PSAxIGVsc2UgJ2ZhbHNlJwogICAgZ290byA9ICdFbmFibGluZycgaWYgZG8gPT0gMSBlbHNlICdEaXNhYmxpbmcnCiAgICBsaW5rID0gb3BlblVSTCgnaHR0cDovL25vb2JzYW5kbmVyZHMuY29tL1RJL0FkZG9uUG9ydGFsL2FkdWx0LnBocCcpLnJlcGxhY2UoJ1xuJywnJykucmVwbGFjZSgnXHInLCcnKS5yZXBsYWNlKCdcdCcsJycpCiAgICBsaXN0ID0gcmUuY29tcGlsZSgnaT0iKC4rPykiJykuZmluZGFsbChsaW5rKQogICAgZm91bmQgPSBbXQogICAgZm9yIGl0ZW0gaW4gbGlzdDoKICAgICAgICBmb2xkID0gb3MucGF0aC5qb2luKEFERE9OUywgaXRlbSkKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhmb2xkKToKICAgICAgICAgICAgZm91bmQuYXBwZW5kKGl0ZW0pCiAgICAgICAgICAgIHRvZ2dsZUFkZG9uKGl0ZW0sIHN0YXRlLCBUcnVlKQogICAgICAgICAgICBsb2coIltBZHVsdG9zXSAlcyAlcyIgJSAoZ290bywgaXRlbSksIHhibWMuTE9HTk9USUNFKQogICAgaWYgbGVuKGZvdW5kKSA+IDA6IAogICAgICAgIGlmIERJQUxPRy55ZXNubyhBRERPTlRJVExFLCAiW0NPTE9SICVzXVF1aWVyZXMgdmVyIHVuYSBsaXN0YSBjb21wbGV0YSBkZSB0b2RvcyBsb3MgYWRkb25zIGRlICVzP1svQ09MT1JdIiAlIChDT0xPUjIsIGdvdG8ucmVwbGFjZSgnaW5nJywgJ2VkJykpLCB5ZXNsYWJlbD0iW0JdW0NPTE9SIGdyZWVuXVZlciBsaXN0YVsvQ09MT1JdWy9CXSIsIG5vbGFiZWw9IltCXVtDT0xPUiByZWRdQ2FuY2VsYXJbL0NPTE9SXVsvQl0iKToKICAgICAgICAgICAgZWRpdGxpc3QgPSAnW0NSXScuam9pbihmb3VuZCkKICAgICAgICAgICAgVGV4dEJveChBRERPTlRJVExFLCAiW0NPTE9SICVzXUFxdWkgaGF5IHVuYSBsaXN0YSBkZSAlcyBwYXJhIGFkZG9ucyBkZSBhZHVsdG9zOlsvQ09MT1JdW0NSXVtDUl1bQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBnb3RvLnJlcGxhY2UoJ2luZycsICdlZCcpLCBDT0xPUjIsIGVkaXRsaXN0KSkKICAgICAgICBlbHNlOiBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCAiW0NPTE9SICVzXVtDT0xPUiAlc10lZFsvQ09MT1JdIEFkdWx0IEFkZG9ucyAlc1svQ09MT1JdIiAlIChDT0xPUjIsIENPTE9SMSwgY291bnQsIGdvdG8ucmVwbGFjZSgnaW5nJywgJ2VkJykpKQogICAgICAgIGZvcmNlVXBkYXRlKFRydWUpCiAgICBlbHNlOiBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCAiW0NPTE9SICVzXU5vIHNlIGhhbiBlbmNvbnRyYWRvIGFkZG9ucyBwYXJhIGFkdWx0b3NbL0NPTE9SXSIgJSBDT0xPUjIpCgpkZWYgY3JlYXRlVGVtcChwbHVnaW4pOgogICAgdGVtcCAgID0gb3MucGF0aC5qb2luKFBMVUdJTiwgJ3Jlc291cmNlcycsICd0ZW1wYWRkb24ueG1sJykKICAgIGYgICAgICA9IG9wZW4odGVtcCwgJ3InKTsgciA9IGYucmVhZCgpOyBmLmNsb3NlKCkKICAgIHBsdWdkaXIgPSBvcy5wYXRoLmpvaW4oQURET05TLCBwbHVnaW4pCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMocGx1Z2Rpcik6IG9zLm1ha2VkaXJzKHBsdWdkaXIpCiAgICBhID0gb3Blbihvcy5wYXRoLmpvaW4ocGx1Z2RpciwgJ2FkZG9uLnhtbCcpLCAndycpCiAgICBhLndyaXRlKHIucmVwbGFjZSgndGVzdGlkJywgcGx1Z2luKS5yZXBsYWNlKCd0ZXN0dmVyc2lvbicsICcwLjAuMScpKQogICAgYS5jbG9zZSgpCiAgICBsb2coIiVzOiBlc2NyaXRvIGFkZG9uLnhtbCIgJSBwbHVnaW4pCgpkZWYgZml4bWV0YXMoKToKICAgIGlkbGlzdCA9IFsncGx1Z2luLnZpZGVvLm1ldGFsbGlxJywgJ3BsdWdpbi52aWRlby5tZXRhJywgJ3NjcmlwdC5yZW5lZ2FkZXNtZXRhJ10KICAgIHRlbXAgICA9IG9zLnBhdGguam9pbihQTFVHSU4sICdyZXNvdXJjZXMnLCAndGVtcGFkZG9uLnhtbCcpCiAgICBmICAgICAgPSBvcGVuKHRlbXAsICdyJyk7IHIgPSBmLnJlYWQoKTsgZi5jbG9zZSgpCiAgICBmb3IgaXRlbSBpbiBpZGxpc3Q6CiAgICAgICAgZm9sZCA9IG9zLnBhdGguam9pbihBRERPTlMsIGl0ZW0pCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoZm9sZCk6CiAgICAgICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4oZm9sZCwgJ2FkZG9uLnhtbCcpKTogY29udGludWUKICAgICAgICAgICAgYSA9IG9wZW4ob3MucGF0aC5qb2luKGZvbGQsICdhZGRvbi54bWwnKSwgJ3cnKQogICAgICAgICAgICBhLndyaXRlKHIucmVwbGFjZSgndGVzdGlkJywgaXRlbSkucmVwbGFjZSgndGVzdHZlcnNpb24nLCAnMC4wLjEnKSkKICAgICAgICAgICAgYS5jbG9zZSgpCiAgICAgICAgICAgIGxvZygiJXM6IHJlLWVzY3JpdG8gYWRkb24ueG1sIiAlIGl0ZW0pCgpkZWYgdG9nZ2xlQWRkb24oaWQsIHZhbHVlLCBvdmVyPU5vbmUpOgogICAgaWYgS09ESVYgPj0gMTc6CiAgICAgICAgYWRkb25EYXRhYmFzZShpZCwgdmFsdWUpCiAgICAgICAgcmV0dXJuCiAgICBhZGRvbmlkICA9IGlkCiAgICBhZGRvbnhtbCA9IG9zLnBhdGguam9pbihBRERPTlMsIGlkLCAnYWRkb24ueG1sJykKICAgIGlmIG9zLnBhdGguZXhpc3RzKGFkZG9ueG1sKToKICAgICAgICBmICAgICAgICA9IG9wZW4oYWRkb254bWwpCiAgICAgICAgYiAgICAgICAgPSBmLnJlYWQoKQogICAgICAgIHRpZCAgICAgID0gcGFyc2VET00oYiwgJ2FkZG9uJywgcmV0PSdpZCcpCiAgICAgICAgdG5hbWUgICAgPSBwYXJzZURPTShiLCAnYWRkb24nLCByZXQ9J25hbWUnKQogICAgICAgIHRzZXJ2aWNlID0gcGFyc2VET00oYiwgJ2V4dGVuc2lvbicsIHJldD0nbGlicmFyeScsIGF0dHJzID0geydwb2ludCc6ICd4Ym1jLnNlcnZpY2UnfSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGxlbih0aWQpID4gMDoKICAgICAgICAgICAgICAgIGFkZG9uaWQgPSB0aWRbMF0KICAgICAgICAgICAgaWYgbGVuKHRzZXJ2aWNlKSA+IDA6CiAgICAgICAgICAgICAgICBsb2coIlBhcmFuZG8gc2NyaXB0OiAlcyIgJSBtYXRjaFswXSwgeGJtYy5MT0dERUJVRykKICAgICAgICAgICAgICAgIGViaSgnU3RvcFNjcmlwdCglcyknICUgb3MucGF0aC5qb2luKEFERE9OUywgYWRkb25pZCkpCiAgICAgICAgICAgICAgICBlYmkoJ1N0b3BTY3JpcHQoJXMpJyAlIGFkZG9uaWQpCiAgICAgICAgICAgICAgICBlYmkoJ1N0b3BTY3JpcHQoJXMpJyAlIG9zLnBhdGguam9pbihBRERPTlMsIGFkZG9uaWQsIHRzZXJ2aWNlWzBdKSkKICAgICAgICAgICAgICAgIHhibWMuc2xlZXAoNTAwKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwogICAgcXVlcnkgPSAneyJqc29ucnBjIjoiMi4wIiwgIm1ldGhvZCI6IkFkZG9ucy5TZXRBZGRvbkVuYWJsZWQiLCJwYXJhbXMiOnsiYWRkb25pZCI6IiVzIiwiZW5hYmxlZCI6JXN9LCAiaWQiOjF9JyAlIChhZGRvbmlkLCB2YWx1ZSkKICAgIHJlc3BvbnNlID0geGJtYy5leGVjdXRlSlNPTlJQQyhxdWVyeSkKICAgIGlmICdlcnJvcicgaW4gcmVzcG9uc2UgYW5kIG92ZXIgPT0gTm9uZToKICAgICAgICB2ID0gJ0VuYWJsaW5nJyBpZiB2YWx1ZSA9PSAndHJ1ZScgZWxzZSAnRGlzYWJsaW5nJwogICAgICAgIERJQUxPRy5vayhBRERPTlRJVExFLCAiW0NPTE9SICVzXUVycm9yICVzIFtDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjIsIENPTE9SMSwgdiwgaWQpLCAiQ29tcHJ1ZWJhIHF1ZSBlbCBsaXN0YWRvIGRlIGFkZG9ucyBlcyBmdW5jaW9uYWwgeSBlc3RhIHN1YmlkbyBjb3JyZWN0YW1lbnRlLlsvQ09MT1JdIikKICAgICAgICBmb3JjZVVwZGF0ZSgpCgpkZWYgYWRkb25JbmZvKGFkZCwgaW5mbyk6CiAgICBhZGRvbiA9IGFkZG9uSWQoYWRkKQogICAgaWYgYWRkb246IHJldHVybiBhZGRvbi5nZXRBZGRvbkluZm8oaW5mbykKICAgIGVsc2U6IHJldHVybiBGYWxzZQoKZGVmIHdoaWxlV2luZG93KHdpbmRvdywgYWN0aXZlPUZhbHNlLCBjb3VudD0wLCBjb3VudGVyPTE1KToKICAgIHdpbmRvd29wZW4gPSBnZXRDb25kKCdXaW5kb3cuSXNBY3RpdmUoJXMpJyAlIHdpbmRvdykKICAgIGxvZygiJXMgZXMgJXMiICUgKHdpbmRvdywgd2luZG93b3BlbiksIHhibWMuTE9HREVCVUcpCiAgICB3aGlsZSBub3Qgd2luZG93b3BlbiBhbmQgY291bnQgPCBjb3VudGVyOgogICAgICAgIGxvZygiJXMgZXMgJXMoJXMpIiAlICh3aW5kb3csIHdpbmRvd29wZW4sIGNvdW50KSkKICAgICAgICB3aW5kb3dvcGVuID0gZ2V0Q29uZCgnV2luZG93LklzQWN0aXZlKCVzKScgJSB3aW5kb3cpCiAgICAgICAgY291bnQgKz0gMSAKICAgICAgICB4Ym1jLnNsZWVwKDUwMCkKICAgICAgICAKICAgIHdoaWxlIHdpbmRvd29wZW46CiAgICAgICAgYWN0aXZlID0gVHJ1ZQogICAgICAgIGxvZygiJXMgaXMgJXMiICUgKHdpbmRvdywgd2luZG93b3BlbiksIHhibWMuTE9HREVCVUcpCiAgICAgICAgd2luZG93b3BlbiA9IGdldENvbmQoJ1dpbmRvdy5Jc0FjdGl2ZSglcyknICUgd2luZG93KQogICAgICAgIHhibWMuc2xlZXAoMjUwKQogICAgcmV0dXJuIGFjdGl2ZQoKZGVmIGlkX2dlbmVyYXRvcihzaXplPTYsIGNoYXJzPXN0cmluZy5hc2NpaV91cHBlcmNhc2UgKyBzdHJpbmcuZGlnaXRzKToKICAgIHJldHVybiAnJy5qb2luKHJhbmRvbS5jaG9pY2UoY2hhcnMpIGZvciBfIGluIHJhbmdlKHNpemUpKQoKZGVmIGdlbmVyYXRlUVIodXJsLCBmaWxlbmFtZSk6CiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoUVJDT0RFUyk6IG9zLm1ha2VkaXJzKFFSQ09ERVMpCiAgICBpbWFnZWZpbGUgPSBvcy5wYXRoLmpvaW4oUVJDT0RFUywnJXMucG5nJyAlIGZpbGVuYW1lKQogICAgcXJJTUcgICAgID0gcHlxcmNvZGUuY3JlYXRlKHVybCkKICAgIHFySU1HLnBuZyhpbWFnZWZpbGUsIHNjYWxlPTEwKQogICAgcmV0dXJuIGltYWdlZmlsZQoKZGVmIGNyZWF0ZVFSKCk6CiAgICB1cmwgPSBnZXRLZXlib2FyZCgnJywgIiVzOiBJbnNlcnRlIGxhIFVSTCBwYXJhIGVsIFFSQ29kZS4iICUgQURET05USVRMRSkKICAgIGlmIHVybCA9PSAiIjogTG9nTm90aWZ5KCJbQ09MT1IgJXNdQ3JlYWNpb24gZGUgUVJbL0NPTE9SXSIgJSBDT0xPUjEsICdbQ09MT1IgJXNdQ3JlYWFjaW9uIGRlbCBRUiBjYW5jZWxhZG8hWy9DT0xPUl0nICUgQ09MT1IyKTsgcmV0dXJuCiAgICBpZiBub3QgdXJsLnN0YXJ0c3dpdGgoJ2h0dHA6Ly8nKSBhbmQgbm90IHVybC5zdGFydHN3aXRoKCdodHRwczovLycpOiBMb2dOb3RpZnkoIltDT0xPUiAlc11DcmVhY2lvbiBkZSBRUlsvQ09MT1JdIiAlIENPTE9SMSwgJ1tDT0xPUiAlc11VUkwgbm8gdmFsaWRhIVsvQ09MT1JdJyAlIENPTE9SMik7IHJldHVybgogICAgaWYgdXJsID09ICdodHRwOi8vJyBvciB1cmwgPT0gJ2h0dHBzOi8vJzogTG9nTm90aWZ5KCJbQ09MT1IgJXNdQ3JlYWNpb24gZGUgUVJbL0NPTE9SXSIgJSBDT0xPUjEsICdbQ09MT1IgJXNdVVJMIG5vIHZhbGlkYSFbL0NPTE9SXScgJSBDT0xPUjIpOyByZXR1cm4KICAgIHdvcmtpbmcgPSB3b3JraW5nVVJMKHVybCkKICAgIGlmIG5vdCB3b3JraW5nID09IFRydWU6CiAgICAgICAgaWYgbm90IERJQUxPRy55ZXNubyhBRERPTlRJVExFLCAiW0NPTE9SICVzXVBhcmVjZSBxdWUgbm8gZXMgZnVuY2lvbmFsLCBxdWllcmVzIGNyZWFybG8gZGUgdG9kYXMgbWFuZXJhcz9bL0NPTE9SXSIgJSBDT0xPUjIsICJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCB3b3JraW5nKSwgeWVzbGFiZWw9IltCXVtDT0xPUiByZWRdU2ksIGNyZWFyWy9DT0xPUl1bL0JdIiwgbm9sYWJlbD0iW0JdW0NPTE9SIGdyZWVuXU5vLCBDYW5jZWxhclsvQ09MT1JdWy9CXSIpOgogICAgICAgICAgICByZXR1cm4KICAgIG5hbWUgPSBnZXRLZXlib2FyZCgnJywgIiVzOiBJbnNlcnRhIGVsIG5vbWJyZSBwYXJhIGVsIFFSQ29kZS4iICUgQURET05USVRMRSkKICAgIG5hbWUgPSAiUXJJbWFnZV8lcyIgJSBpZF9nZW5lcmF0b3IoNikgaWYgbmFtZSA9PSAiIiBlbHNlIG5hbWUKICAgIGltYWdlID0gZ2VuZXJhdGVRUih1cmwsIG5hbWUpCiAgICBESUFMT0cub2soQURET05USVRMRSwgIltDT0xPUiAlc11FbCBjb2RpZ28gUVIgc2UgaGEgY3JlYWRvIGNvcnJlY3RhbWVudGUgeSBzZSBoYSBndWFyZGFkbyBlbiBsYSBjYXJwZXRhIGRlIGRhdG9zIGRlbCBhZGRvbjpbL0NPTE9SXSIgJSBDT0xPUjIsICJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBpbWFnZS5yZXBsYWNlKEhPTUUsICcnKSkpCgpkZWYgY2xlYW51cEJhY2t1cCgpOgogICAgbXlidWlsZHMgPSB4Ym1jLnRyYW5zbGF0ZVBhdGgoTVlCVUlMRFMpCiAgICBmb2xkZXIgPSBnbG9iLmdsb2Iob3MucGF0aC5qb2luKG15YnVpbGRzLCAiKiIpKQogICAgbGlzdCA9IFtdOyBmaWxlbGlzdCA9IFtdCiAgICBpZiBsZW4oZm9sZGVyKSA9PSAwOgogICAgICAgIExvZ05vdGlmeSgiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgQURET05USVRMRSksICJbQ09MT1IgJXNdTG9jYWxpemFjaW9uIGRlbCBiYWNrdXA6IFZhY2lvWy9DT0xPUl0iICUgKENPTE9SMikpCiAgICAgICAgcmV0dXJuCiAgICBmb3IgaXRlbSBpbiBzb3J0ZWQoZm9sZGVyLCBrZXk9b3MucGF0aC5nZXRtdGltZSk6CiAgICAgICAgZmlsZWxpc3QuYXBwZW5kKGl0ZW0pCiAgICAgICAgYmFzZSA9IGl0ZW0ucmVwbGFjZShteWJ1aWxkcywgJycpCiAgICAgICAgaWYgb3MucGF0aC5pc2RpcihpdGVtKTogCiAgICAgICAgICAgIGxpc3QuYXBwZW5kKCcvJXMvJyAlIGJhc2UpCiAgICAgICAgZWxpZiBvcy5wYXRoLmlzZmlsZShpdGVtKTogCiAgICAgICAgICAgIGxpc3QuYXBwZW5kKGJhc2UpCiAgICBsaXN0ID0gWyctLS0gRWxpbWluYXIgdG9kbyAtLS0nXSArIGxpc3QKICAgIHNlbGVjdGVkID0gRElBTE9HLnNlbGVjdCgiJXM6IFNlbGVjY2lvbmEgbG9zIGl0ZW1zIGEgZWxpbWluYXIgZGUgJ1NhbG9uRGlnaXRhbF9CYWNrdXAnLiIgJSBBRERPTlRJVExFLCBsaXN0KQogICAgCiAgICBpZiBzZWxlY3RlZCA9PSAtMToKICAgICAgICBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCAiW0NPTE9SICVzXUxpbXBpZXphIGNhbmNlbGFkYSFbL0NPTE9SXSIgJSBDT0xPUjIpCiAgICBlbGlmIHNlbGVjdGVkID09IDA6IAogICAgICAgIGlmIERJQUxPRy55ZXNubyhBRERPTlRJVExFLCAiW0NPTE9SICVzXVF1aWVyZXMgbGltcGlhciB0b2RvcyBsb3MgaXRlbXMgZGUgbGEgY2FycGV0YSAnU2Fsb25EaWdpdGFsX0JhY2t1cCcgP1svQ09MT1JdIiAlIENPTE9SMiwgIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIE1ZQlVJTERTKSwgeWVzbGFiZWw9IltCXVtDT0xPUiBncmVlbl1MaW1waWFyWy9DT0xPUl1bL0JdIiwgbm9sYWJlbD0iW0JdW0NPTE9SIHJlZF1Ob1svQ09MT1JdWy9CXSIpOgogICAgICAgICAgICBjbGVhcmVkZmlsZXMsIGNsZWFyZWRmb2xkZXJzID0gY2xlYW5Ib3VzZSh4Ym1jLnRyYW5zbGF0ZVBhdGgoTVlCVUlMRFMpKQogICAgICAgICAgICBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCAiW0NPTE9SICVzXUFyY2hpdm9zIGVsaW1pbmFkb3M6IFtDT0xPUiAlc10lc1svQ09MT1JdIC8gQ2FycGV0YXM6Wy9DT0xPUl0gW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMiwgQ09MT1IxLCBjbGVhcmVkZmlsZXMsIENPTE9SMSwgY2xlYXJlZGZvbGRlcnMpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIExvZ05vdGlmeSgiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgQURET05USVRMRSksICJbQ09MT1IgJXNdTGltcGllemEgY2FuY2VsYWRhIVsvQ09MT1JdIiAlIENPTE9SMikKICAgIGVsc2U6CiAgICAgICAgcGF0aCA9IGZpbGVsaXN0W3NlbGVjdGVkLTFdOyBwYXNzZWQgPSBGYWxzZQogICAgICAgIGlmIERJQUxPRy55ZXNubyhBRERPTlRJVExFLCAiW0NPTE9SICVzXVF1aWVyZXMgZWxpbWluYXIgW0NPTE9SICVzXSVzWy9DT0xPUl0gZGUgbGEgY2FycGV0YSAnU2Fsb25EaWdpdGFsX0JhY2t1cCcgP1svQ09MT1JdIiAlIChDT0xPUjIsIENPTE9SMSwgbGlzdFtzZWxlY3RlZF0pLCAiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgcGF0aCksIHllc2xhYmVsPSJbQl1bQ09MT1IgZ3JlZW5dTGltcGlhclsvQ09MT1JdWy9CXSIsIG5vbGFiZWw9IltCXVtDT0xPUiByZWRdTm9bL0NPTE9SXVsvQl0iKToKICAgICAgICAgICAgaWYgb3MucGF0aC5pc2ZpbGUocGF0aCk6IAogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG9zLnJlbW92ZShwYXRoKQogICAgICAgICAgICAgICAgICAgIHBhc3NlZCA9IFRydWUKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBsb2coIkltcG9zaWJsZSBlbGltaW5hcjogJXMiICUgcGF0aCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGNsZWFuSG91c2UocGF0aCkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzaHV0aWwucm10cmVlKHBhdGgpCiAgICAgICAgICAgICAgICAgICAgcGFzc2VkID0gVHJ1ZQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiAsZTogCiAgICAgICAgICAgICAgICAgICAgbG9nKCJFcnJvciBlbGltaW5hbmRvICVzIiAlIHBhdGgsIHhibWMuTE9HTk9USUNFKQogICAgICAgICAgICBpZiBwYXNzZWQ6IExvZ05vdGlmeSgiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgQURET05USVRMRSksICJbQ09MT1IgJXNdJXMgRWxpbWluYWRvIVsvQ09MT1JdIiAlIChDT0xPUjIsIGxpc3Rbc2VsZWN0ZWRdKSkKICAgICAgICAgICAgZWxzZTogTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgIltDT0xPUiAlc11FcnJvciBFbGltaW5hbmRvICVzIVsvQ09MT1JdIiAlIChDT0xPUjIsIGxpc3Rbc2VsZWN0ZWRdKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCAiW0NPTE9SICVzXUxpbXBpZXphIGNhbmNlbGFkYSFbL0NPTE9SXSIgJSBDT0xPUjIpCgpkZWYgZ2V0Q29uZCh0eXBlKToKICAgIHJldHVybiB4Ym1jLmdldENvbmRWaXNpYmlsaXR5KHR5cGUpCgpkZWYgZWJpKHByb2MpOgogICAgeGJtYy5leGVjdXRlYnVpbHRpbihwcm9jKQoKZGVmIHJlZnJlc2goKToKICAgIGViaSgnQ29udGFpbmVyLlJlZnJlc2goKScpCgpkZWYgc3BsaXROb3RpZnkobm90aWZ5KToKICAgIGxpbmsgPSBvcGVuVVJMKG5vdGlmeSkucmVwbGFjZSgnXHInLCcnKS5yZXBsYWNlKCdcdCcsJycpLnJlcGxhY2UoJ1xuJywgJ1tDUl0nKQogICAgaWYgbGluay5maW5kKCd8fHwnKSA9PSAtMTogcmV0dXJuIEZhbHNlLCBGYWxzZQogICAgaWQsIG1zZyA9IGxpbmsuc3BsaXQoJ3x8fCcpCiAgICBpZiBtc2cuc3RhcnRzd2l0aCgnW0NSXScpOiBtc2cgPSBtc2dbNDpdCiAgICByZXR1cm4gaWQucmVwbGFjZSgnW0NSXScsICcnKSwgbXNnCgpkZWYgZm9yY2VVcGRhdGUoc2lsZW50PUZhbHNlKToKICAgIGViaSgnVXBkYXRlQWRkb25SZXBvcygpJykKICAgIGViaSgnVXBkYXRlTG9jYWxBZGRvbnMoKScpCiAgICBpZiBzaWxlbnQgPT0gRmFsc2U6IExvZ05vdGlmeSgiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgQURET05USVRMRSksICdbQ09MT1IgJXNdRm9yemFuZG8gYWN0dWFsaXphY2lvbiBkZSBhZGRvbnNbL0NPTE9SXScgJSBDT0xPUjIpCgpkZWYgY29udmVydFNwZWNpYWwodXJsLCBvdmVyPUZhbHNlKToKICAgIHRvdGFsID0gZmlsZUNvdW50KHVybCk7IHN0YXJ0ID0gMAogICAgRFAuY3JlYXRlKEFERE9OVElUTEUsICJbQ09MT1IgJXNdQ2FtYmlhbmRvIHJ1dGFzIGZpc2ljYXMgcG9yIGVzcGVjaWFsZXMiICUgQ09MT1IyLCAiIiwgIlBvciBmYXZvciwgZXNwZXJlWy9DT0xPUl0iKQogICAgZm9yIHJvb3QsIGRpcnMsIGZpbGVzIGluIG9zLndhbGsodXJsKToKICAgICAgICBmb3IgZmlsZSBpbiBmaWxlczoKICAgICAgICAgICAgc3RhcnQgKz0gMQogICAgICAgICAgICBwZXJjID0gaW50KHBlcmNlbnRhZ2Uoc3RhcnQsIHRvdGFsKSkKICAgICAgICAgICAgaWYgZmlsZS5lbmRzd2l0aCgiLnhtbCIpIG9yIGZpbGUuZW5kc3dpdGgoIi5oYXNoIikgb3IgZmlsZS5lbmRzd2l0aCgicHJvcGVyaWVzIik6CiAgICAgICAgICAgICAgICBEUC51cGRhdGUocGVyYywgIltDT0xPUiAlc11Fc2NhbmVhbmRvOiBbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IyLCBDT0xPUjEsIHJvb3QucmVwbGFjZShIT01FLCAnJykpLCAiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgZmlsZSksICJQb3IgZmF2b3IsIGVzcGVyZVsvQ09MT1JdIikKICAgICAgICAgICAgICAgIGEgPSBvcGVuKG9zLnBhdGguam9pbihyb290LCBmaWxlKSkucmVhZCgpCiAgICAgICAgICAgICAgICBlbmNvZGVkcGF0aCAgPSB1cmxsaWIucXVvdGUoSE9NRSkKICAgICAgICAgICAgICAgIGVuY29kZWRwYXRoMiAgPSB1cmxsaWIucXVvdGUoSE9NRSkucmVwbGFjZSgnJTNBJywnJTNhJykucmVwbGFjZSgnJTVDJywnJTVjJykKICAgICAgICAgICAgICAgIGIgPSBhLnJlcGxhY2UoSE9NRSwgJ3NwZWNpYWw6Ly9ob21lLycpLnJlcGxhY2UoZW5jb2RlZHBhdGgsICdzcGVjaWFsOi8vaG9tZS8nKS5yZXBsYWNlKGVuY29kZWRwYXRoMiwgJ3NwZWNpYWw6Ly9ob21lLycpCiAgICAgICAgICAgICAgICBmID0gb3Blbigob3MucGF0aC5qb2luKHJvb3QsIGZpbGUpKSwgbW9kZT0ndycpCiAgICAgICAgICAgICAgICBmLndyaXRlKHN0cihiKSkKICAgICAgICAgICAgICAgIGYuY2xvc2UoKQogICAgRFAuY2xvc2UoKQogICAgbG9nKCJbQ29udmVydGlyIHJ1dGFzIGZpc2ljYXMgYSBlc3BlY2lhbGVzXSBDb21wbGV0YWRvIiwgeGJtYy5MT0dOT1RJQ0UpCiAgICBpZiBvdmVyID09IEZhbHNlOiBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCAiW0NPTE9SICVzXUNvbnZlcnRpciBydXRhcyBmaXNpY2FzIGEgZXNwZWNpYWxlc10gQ29tcGxldGFkbyFbL0NPTE9SXSIgJSBDT0xPUjIpCgpkZWYgY2xlYXJDcmFzaCgpOiAgCiAgICBmaWxlcyA9IFtdCiAgICBmb3IgZmlsZSBpbiBnbG9iLmdsb2Iob3MucGF0aC5qb2luKExPRywgJypjcmFzaGxvZyouKicpKToKICAgICAgICBmaWxlcy5hcHBlbmQoZmlsZSkKICAgIGlmIGxlbihmaWxlcykgPiAwOgogICAgICAgIGlmIERJQUxPRy55ZXNubyhBRERPTlRJVExFLCAnW0NPTE9SICVzXVF1aWVyZXMgZWxpbWluYXIgbG9zIGxvZ3MgZGUgY3Jhc2hlbz8nICUgQ09MT1IyLCAnW0NPTE9SICVzXSVzWy9DT0xPUl0gQXJjaGl2b3MgZW5jb250cmFkb3NbL0NPTE9SXScgJSAoQ09MT1IxLCBsZW4oZmlsZXMpKSwgeWVzbGFiZWw9IltCXVtDT0xPUiBncmVlbl1FbGltaW5hciBMb2dzWy9DT0xPUl1bL0JdIiwgbm9sYWJlbD0iW0JdW0NPTE9SIHJlZF1NYW50ZW5lciBMb2dzWy9DT0xPUl1bL0JdIik6CiAgICAgICAgICAgIGZvciBmIGluIGZpbGVzOgogICAgICAgICAgICAgICAgb3MucmVtb3ZlKGYpCiAgICAgICAgICAgIExvZ05vdGlmeSgnW0NPTE9SICVzXUxpbXBpYXIgbG9ncyBkZSBjcmFzaGVvWy9DT0xPUl0nICUgQ09MT1IxLCAnW0NPTE9SICVzXSVzIExvZ3MgZGUgY3Jhc2hlbyBlbGltaW5hZG9zWy9DT0xPUl0nICUgKENPTE9SMiwgbGVuKGZpbGVzKSkpCiAgICAgICAgZWxzZTogTG9nTm90aWZ5KCdbQ09MT1IgJXNdJXNbL0NPTE9SXScgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgJ1tDT0xPUiAlc11DbGVhciBMb2dzIGRlIGNyYXNoZW8gY2FuY2VsYWRvWy9DT0xPUl0nICUgQ09MT1IyKQogICAgZWxzZTogTG9nTm90aWZ5KCdbQ09MT1IgJXNdTGltcGlhciBsb2dzIGRlIGNyYXNoZW9bL0NPTE9SXScgJSBDT0xPUjEsICdbQ09MT1IgJXNdTm8gc2UgaGFuIGVuY29udHJhZG8gTG9ncyBkZSBjcmFzaGVvWy9DT0xPUl0nICUgQ09MT1IyKQoKZGVmIGhpZGVQYXNzd29yZCgpOgogICAgaWYgRElBTE9HLnllc25vKEFERE9OVElUTEUsICJbQ09MT1IgJXNdV291bGQgeW91IGxpa2UgdG8gW0NPTE9SICVzXWhpZGVbL0NPTE9SXSBhbGwgcGFzc3dvcmRzIHdoZW4gdHlwaW5nIGluIHRoZSBhZGQtb24gc2V0dGluZ3MgbWVudXM/Wy9DT0xPUl0iICUgQ09MT1IyLCB5ZXNsYWJlbD0iW0JdW0NPTE9SIGdyZWVuXUhpZGUgUGFzc3dvcmRzWy9DT0xPUl1bL0JdIiwgbm9sYWJlbD0iW0JdW0NPTE9SIHJlZF1ObyBDYW5jZWxbL0NPTE9SXVsvQl0iKToKICAgICAgICBjb3VudCA9IDAKICAgICAgICBmb3IgZm9sZGVyIGluIGdsb2IuZ2xvYihvcy5wYXRoLmpvaW4oQURET05TLCAnKi8nKSk6CiAgICAgICAgICAgIHNldHQgPSBvcy5wYXRoLmpvaW4oZm9sZGVyLCAncmVzb3VyY2VzJywgJ3NldHRpbmdzLnhtbCcpCiAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHNldHQpOgogICAgICAgICAgICAgICAgZiA9IG9wZW4oc2V0dCkucmVhZCgpCiAgICAgICAgICAgICAgICBtYXRjaCA9IHBhcnNlRE9NKGYsICdhZGRvbicsIHJldD0naWQnKQogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gbWF0Y2g6CiAgICAgICAgICAgICAgICAgICAgaWYgJ3Bhc3MnIGluIGxpbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCAnb3B0aW9uPSJoaWRkZW4iJyBpbiBsaW5lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZSA9IGxpbmUucmVwbGFjZSgnLycsICdvcHRpb249ImhpZGRlbiIgLycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZi5yZXBsYWNlKGxpbmUsIGNoYW5nZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3VudCArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nKCJbSGlkZSBQYXNzd29yZHNdIGZvdW5kIGluICVzIG9uICVzIiAlIChzZXR0LnJlcGxhY2UoSE9NRSwgJycpLCBsaW5lKSwgeGJtYy5MT0dERUJVRykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICBmMiA9IG9wZW4oc2V0dCwgbW9kZT0ndycpOyBmMi53cml0ZShmKTsgZjIuY2xvc2UoKQogICAgICAgIExvZ05vdGlmeSgiW0NPTE9SICVzXUhpZGUgUGFzc3dvcmRzWy9DT0xPUl0iICUgQ09MT1IxLCAiW0NPTE9SICVzXSVzIGl0ZW1zIGNoYW5nZWRbL0NPTE9SXSIgJSAoQ09MT1IyLCBjb3VudCkpCiAgICAgICAgbG9nKCJbSGlkZSBQYXNzd29yZHNdICVzIGl0ZW1zIGNoYW5nZWQiICUgY291bnQsIHhibWMuTE9HTk9USUNFKQogICAgZWxzZTogbG9nKCJbSGlkZSBQYXNzd29yZHNdIENhbmNlbGxlZCIsIHhibWMuTE9HTk9USUNFKQoKZGVmIHVuaGlkZVBhc3N3b3JkKCk6CiAgICBpZiBESUFMT0cueWVzbm8oQURET05USVRMRSwgIltDT0xPUiAlc11RdWllcmVzIFtDT0xPUiAlc11tb3N0cmFyWy9DT0xPUl0gdG9kb3MgbG9zIHBhc3N3b3JkcyBlbiBlbCB0ZWNsYWRvIHZpcnR1YWwgYSBsYSBob3JhIGRlIGNvbmZpZ3VyYXIgYWRkb25zP1svQ09MT1JdIiAlIChDT0xPUjIsIENPTE9SMSksIHllc2xhYmVsPSJbQl1bQ09MT1IgZ3JlZW5dTW9zdHJhciBQYXNzd29yZHNbL0NPTE9SXVsvQl0iLCBub2xhYmVsPSJbQl1bQ09MT1IgcmVkXU5vLCBDYW5jZWxhclsvQ09MT1JdWy9CXSIpOgogICAgICAgIGNvdW50ID0gMAogICAgICAgIGZvciBmb2xkZXIgaW4gZ2xvYi5nbG9iKG9zLnBhdGguam9pbihBRERPTlMsICcqLycpKToKICAgICAgICAgICAgc2V0dCA9IG9zLnBhdGguam9pbihmb2xkZXIsICdyZXNvdXJjZXMnLCAnc2V0dGluZ3MueG1sJykKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoc2V0dCk6CiAgICAgICAgICAgICAgICBmID0gb3BlbihzZXR0KS5yZWFkKCkKICAgICAgICAgICAgICAgIG1hdGNoID0gcGFyc2VET00oZiwgJ2FkZG9uJywgcmV0PSdpZCcpCiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBtYXRjaDoKICAgICAgICAgICAgICAgICAgICBpZiAncGFzcycgaW4gbGluZToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgJ29wdGlvbj0iaGlkZGVuIicgaW4gbGluZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2UgPSBsaW5lLnJlcGxhY2UoJ29wdGlvbj0iaGlkZGVuIicsICcnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYucmVwbGFjZShsaW5lLCBjaGFuZ2UpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bnQgKz0gMQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZygiW01vc3RyYXIgUGFzc3dvcmRzXSBlbmNvbnRyYWRvIGVuICVzIG9uICVzIiAlIChzZXR0LnJlcGxhY2UoSE9NRSwgJycpLCBsaW5lKSwgeGJtYy5MT0dERUJVRykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICBmMiA9IG9wZW4oc2V0dCwgbW9kZT0ndycpOyBmMi53cml0ZShmKTsgZjIuY2xvc2UoKQogICAgICAgIExvZ05vdGlmeSgiW0NPTE9SICVzXU1vc3RyYXIgUGFzc3dvcmRzWy9DT0xPUl0iICUgQ09MT1IxLCAiW0NPTE9SICVzXSVzIGl0ZW1zIGNhbWJpYWRvc1svQ09MT1JdIiAlIChDT0xPUjIsIGNvdW50KSkKICAgICAgICBsb2coIltNb3N0cmFyIFBhc3N3b3Jkc10gJXMgaXRlbXMgY2FtYmlhZG9zIiAlIGNvdW50LCB4Ym1jLkxPR05PVElDRSkKICAgIGVsc2U6IGxvZygiW01vc3RyYXIgUGFzc3dvcmRzXSBDYW5jZWxhZG8iLCB4Ym1jLkxPR05PVElDRSkKCmRlZiB3aXphcmRVcGRhdGUoc3RhcnR1cD1Ob25lKToKICAgIGlmIHdvcmtpbmdVUkwoV0laQVJERklMRSk6CiAgICAgICAgdmVyID0gY2hlY2tXaXphcmQoJ3ZlcnNpb24nKQogICAgICAgIHppcCA9IGNoZWNrV2l6YXJkKCd6aXAnKQogICAgICAgIGlmIHZlciA+IFZFUlNJT046CiAgICAgICAgICAgIHllcyA9IERJQUxPRy55ZXNubyhBRERPTlRJVExFLCAnW0NPTE9SICVzXUhheSB1bmEgbnVldmEgdmVyc2lvbiBkZSBbQ09MT1IgJXNdJXNbL0NPTE9SXSEnICUgKENPTE9SMiwgQ09MT1IxLCBBRERPTlRJVExFKSwgJ1F1aWVyZXMgZGVzY2FyZ2FyIFtDT0xPUiAlc112JXNbL0NPTE9SXT9bL0NPTE9SXScgJSAoQ09MT1IxLCB2ZXIpLCBub2xhYmVsPSdbQl1bQ09MT1IgcmVkXVJlY29yZGFybWVsbyBtYXMgdGFyZGVbL0NPTE9SXVsvQl0nLCB5ZXNsYWJlbD0iW0JdW0NPTE9SIGdyZWVuXUFjdHVhbGl6YXJbL0NPTE9SXVsvQl0iKQogICAgICAgICAgICBpZiB5ZXM6CiAgICAgICAgICAgICAgICBsb2coIltBdXRvIFVwZGF0ZV0gSW5zdGxhbmFkbyB2ZXJzaW9uIHYlcyIgJSB2ZXIsIHhibWMuTE9HTk9USUNFKQogICAgICAgICAgICAgICAgRFAuY3JlYXRlKEFERE9OVElUTEUsJ1tDT0xPUiAlc11EZXNjYXJnYW5kbyBVcGRhdGUuLi4nICUgQ09MT1IyLCcnLCAnUG9yIGZhdm9yLCBlc3BlcmVbL0NPTE9SXScpCiAgICAgICAgICAgICAgICBsaWI9b3MucGF0aC5qb2luKFBBQ0tBR0VTLCAnJXMtJXMuemlwJyAlIChBRERPTl9JRCwgdmVyKSkKICAgICAgICAgICAgICAgIHRyeTogb3MucmVtb3ZlKGxpYikKICAgICAgICAgICAgICAgIGV4Y2VwdDogcGFzcwogICAgICAgICAgICAgICAgZG93bmxvYWRlci5kb3dubG9hZCh6aXAsIGxpYiwgRFApCiAgICAgICAgICAgICAgICB4Ym1jLnNsZWVwKDIwMDApCiAgICAgICAgICAgICAgICBEUC51cGRhdGUoMCwiIiwgIkluc3RhbGFuZG8gJXMgdXBkYXRlIiAlIEFERE9OVElUTEUpCiAgICAgICAgICAgICAgICBwZXJjZW50LCBlcnJvcnMsIGVycm9yID0gZXh0cmFjdC5hbGwobGliLCBBRERPTlMsIERQLCBUcnVlKQogICAgICAgICAgICAgICAgRFAuY2xvc2UoKQogICAgICAgICAgICAgICAgeGJtYy5zbGVlcCgxMDAwKQogICAgICAgICAgICAgICAgZWJpKCdVcGRhdGVBZGRvblJlcG9zKCknKQogICAgICAgICAgICAgICAgZWJpKCdVcGRhdGVMb2NhbEFkZG9ucygpJykKICAgICAgICAgICAgICAgIHhibWMuc2xlZXAoMTAwMCkKICAgICAgICAgICAgICAgIExvZ05vdGlmeSgiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgQURET05USVRMRSksJ1tDT0xPUiAlc11BZGQtb24gYWN0dWFsaXphZG9bL0NPTE9SXScgJSBDT0xPUjIpCiAgICAgICAgICAgICAgICBsb2coIltBdXRvIFVwZGF0ZV0gVmVyc2lvbiBhY3R1YWxpemFkYSBhIHYlcyIgJSB2ZXIsIHhibWMuTE9HTk9USUNFKQogICAgICAgICAgICAgICAgcmVsb2FkUHJvZmlsZSgpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgZWxzZTogbG9nKCJbQXV0byBVcGRhdGVdIEluc3RhbGFyIG51ZXZhIHZlcnNpb246IElnbm9yYWRvOiAlcyIgJSB2ZXIsIHhibWMuTE9HTk9USUNFKQogICAgICAgIGVsc2U6IAogICAgICAgICAgICBpZiBub3Qgc3RhcnR1cDogTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgIltDT0xPUiAlc11ObyBoYXkgbnVldmEgdmVyc2lvbiBkZWwgYWRkb25bL0NPTE9SXSIgJSBDT0xPUjIpCiAgICAgICAgICAgIGxvZygiW0F1dG8gVXBkYXRlXSBObyBoYXkgbnVldmEgdmVyc2lvbiBkZSB2JXMiICUgdmVyLCB4Ym1jLkxPR05PVElDRSkKICAgIGVsc2U6IGxvZygiW0F1dG8gVXBkYXRlXSBVcmwgbm8gdmFsaWRvOiAlcyIgJSBXSVpBUkRGSUxFLCB4Ym1jLkxPR05PVElDRSkKCmRlZiBjb252ZXJ0VGV4dCgpOgogICAgVEVYVEZJTEVTID0gb3MucGF0aC5qb2luKEFERE9OREFUQSwgJ1RleHRGaWxlcycpCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoVEVYVEZJTEVTKTogb3MubWFrZWRpcnMoVEVYVEZJTEVTKQogICAgCiAgICBEUC5jcmVhdGUoQURET05USVRMRSwnW0NPTE9SICVzXVtCXUNvbnZlcnRpZW5kbyB0ZXh0bzpbL0JdWy9DT0xPUl0nICUgKENPTE9SMiksJycsICdQb3IgZmF2b3IsIGVzcGVyZScpCiAgICAKICAgIGlmIG5vdCBCVUlMREZJTEUgPT0gJ2h0dHA6Ly8nOgogICAgICAgIGZpbGVuYW1lID0gb3MucGF0aC5qb2luKFRFWFRGSUxFUywgJ2J1aWxkcy50eHQnKQogICAgICAgIHdyaXRpbmcgPSAnJzt4ID0gMAogICAgICAgIGEgPSBvcGVuVVJMKEJVSUxERklMRSkucmVwbGFjZSgnXG4nLCcnKS5yZXBsYWNlKCdccicsJycpLnJlcGxhY2UoJ1x0JywnJykKICAgICAgICBEUC51cGRhdGUoMCwnW0NPTE9SICVzXVtCXUNvbnZlcnRpZW5kbyB0ZXh0bzpbL0JdWy9DT0xPUl0gW0NPTE9SICVzXUJ1aWxkcy50eHRbL0NPTE9SXScgJSAoQ09MT1IyLCBDT0xPUjEpLCcnLCAnUG9yIGZhdm9yLCBlc3BlcmUnKQogICAgICAgIGlmIFdJWkFSREZJTEUgPT0gQlVJTERGSUxFOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBhZGRvbmlkLCB2ZXJzaW9uLCB1cmwgPSBjaGVja1dpemFyZCgnYWxsJykKICAgICAgICAgICAgICAgIHdyaXRpbmcgID0gJ2lkPSIlcyJcbicgJSBhZGRvbmlkCiAgICAgICAgICAgICAgICB3cml0aW5nICs9ICd2ZXJzaW9uPSIlcyJcbicgJSB2ZXJzaW9uCiAgICAgICAgICAgICAgICB3cml0aW5nICs9ICd6aXA9IiVzIlxuJyAlIHVybAogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgbWF0Y2ggPSByZS5jb21waWxlKCduYW1lPSIoLis/KSIuKz9lcnNpb249IiguKz8pIi4rP3JsPSIoLis/KSIuKz91aT0iKC4rPykiLis/b2RpPSIoLis/KSIuKz9oZW1lPSIoLis/KSIuKz9jb249IiguKz8pIi4rP2FuYXJ0PSIoLis/KSInKS5maW5kYWxsKGEpCiAgICAgICAgbWF0Y2gyID0gcmUuY29tcGlsZSgnbmFtZT0iKC4rPykiLis/ZXJzaW9uPSIoLis/KSIuKz9ybD0iKC4rPykiLis/dWk9IiguKz8pIi4rP29kaT0iKC4rPykiLis/aGVtZT0iKC4rPykiLis/Y29uPSIoLis/KSIuKz9hbmFydD0iKC4rPykiLis/ZHVsdD0iKC4rPykiLis/ZXNjcmlwdGlvbj0iKC4rPykiJykuZmluZGFsbChhKQogICAgICAgIGlmIGxlbihtYXRjaDIpID09IDA6CiAgICAgICAgICAgIGZvciBuYW1lLCB2ZXJzaW9uLCB1cmwsIGd1aSwga29kaSwgdGhlbWUsIGljb24sIGZhbmFydCBpbiBtYXRjaDoKICAgICAgICAgICAgICAgIHggKz0gMQogICAgICAgICAgICAgICAgRFAudXBkYXRlKGludChwZXJjZW50YWdlKHgsIGxlbihtYXRjaDIpKSksICcnLCAiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgbmFtZSkpCiAgICAgICAgICAgICAgICBpZiBub3Qgd3JpdGluZyA9PSAnJzogd3JpdGluZyArPSAnXG4nCiAgICAgICAgICAgICAgICB3cml0aW5nICs9ICduYW1lPSIlcyJcbicgJSBuYW1lCiAgICAgICAgICAgICAgICB3cml0aW5nICs9ICd2ZXJzaW9uPSIlcyJcbicgJSB2ZXJzaW9uCiAgICAgICAgICAgICAgICB3cml0aW5nICs9ICd1cmw9IiVzIlxuJyAlIHVybAogICAgICAgICAgICAgICAgd3JpdGluZyArPSAnZ3VpPSIlcyJcbicgJSBndWkKICAgICAgICAgICAgICAgIHdyaXRpbmcgKz0gJ2tvZGk9IiVzIlxuJyAlIGtvZGkKICAgICAgICAgICAgICAgIHdyaXRpbmcgKz0gJ3RoZW1lPSIlcyJcbicgJSB0aGVtZQogICAgICAgICAgICAgICAgd3JpdGluZyArPSAnaWNvbj0iJXMiXG4nICUgaWNvbgogICAgICAgICAgICAgICAgd3JpdGluZyArPSAnZmFuYXJ0PSIlcyJcbicgJSBmYW5hcnQKICAgICAgICAgICAgICAgIHdyaXRpbmcgKz0gJ3ByZXZpZXc9Imh0dHA6Ly8iXG4nCiAgICAgICAgICAgICAgICB3cml0aW5nICs9ICdhZHVsdD0ibm8iXG4nCiAgICAgICAgICAgICAgICB3cml0aW5nICs9ICdkZXNjcmlwdGlvbj0iRGVzY2FyZ2FkbyAlcyBkZSAlcyJcbicgJSAobmFtZSwgQURET05USVRMRSkKICAgICAgICAgICAgICAgIGlmIG5vdCB0aGVtZSA9PSAnaHR0cDovLyc6CiAgICAgICAgICAgICAgICAgICAgZmlsZW5hbWUyID0gb3MucGF0aC5qb2luKFRFWFRGSUxFUywgJyVzX3RoZW1lLnR4dCcgJSBuYW1lKQogICAgICAgICAgICAgICAgICAgIHRoZW1ld3JpdGUgPSAnJzsgeDIgPSAwCiAgICAgICAgICAgICAgICAgICAgYSA9IG9wZW5VUkwodGhlbWUpLnJlcGxhY2UoJ1xuJywnJykucmVwbGFjZSgnXHInLCcnKS5yZXBsYWNlKCdcdCcsJycpCiAgICAgICAgICAgICAgICAgICAgRFAudXBkYXRlKDAsJ1tDT0xPUiAlc11bQl1Db252ZXJ0aWVuZG8gdGV4dG86Wy9CXVsvQ09MT1JdIFtDT0xPUiAlc10lc190aGVtZS50eHRbL0NPTE9SXScgJSAoQ09MT1IyLCBDT0xPUjEsIG5hbWUpLCcnLCAnUG9yIGZhdm9yLCBlc3BlcmUnKQogICAgICAgICAgICAgICAgICAgIG1hdGNoMyA9IHJlLmNvbXBpbGUoJ25hbWU9IiguKz8pIi4rP3JsPSIoLis/KSIuKz9jb249IiguKz8pIi4rP2FuYXJ0PSIoLis/KSIuKz9lc2NyaXB0aW9uPSIoLis/KSInKS5maW5kYWxsKGEpCiAgICAgICAgICAgICAgICAgICAgZm9yIG5hbWUsIHVybCwgaWNvbiwgZmFuYXJ0LCBkZXNjcmlwdGlvbiBpbiBtYXRjaDM6CiAgICAgICAgICAgICAgICAgICAgICAgIHgyICs9IDEKICAgICAgICAgICAgICAgICAgICAgICAgRFAudXBkYXRlKGludChwZXJjZW50YWdlKHgyLCBsZW4obWF0Y2gyKSkpLCAnJywgIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIG5hbWUpKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3QgdGhlbWV3cml0ZSA9PSAnJzogdGhlbWV3cml0ZSArPSAnXG4nCiAgICAgICAgICAgICAgICAgICAgICAgIHRoZW1ld3JpdGUgKz0gJ25hbWU9IiVzIlxuJyAlIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgdGhlbWV3cml0ZSArPSAndXJsPSIlcyJcbicgJSB1cmwKICAgICAgICAgICAgICAgICAgICAgICAgdGhlbWV3cml0ZSArPSAnaWNvbj0iJXMiXG4nICUgaWNvbgogICAgICAgICAgICAgICAgICAgICAgICB0aGVtZXdyaXRlICs9ICdmYW5hcnQ9IiVzIlxuJyAlIGZhbmFydAogICAgICAgICAgICAgICAgICAgICAgICB0aGVtZXdyaXRlICs9ICdhZHVsdD0ibm8iXG4nCiAgICAgICAgICAgICAgICAgICAgICAgIHRoZW1ld3JpdGUgKz0gJ2Rlc2NyaXB0aW9uPSIlcyJcbicgJSBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgIGYgPSBvcGVuKGZpbGVuYW1lMiwgJ3cnKTsgZi53cml0ZSh0aGVtZXdyaXRlKTsgZi5jbG9zZSgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZm9yIG5hbWUsIHZlcnNpb24sIHVybCwgZ3VpLCBrb2RpLCB0aGVtZSwgaWNvbiwgZmFuYXJ0LCBhZHVsdCwgZGVzY3JpcHRpb24gaW4gbWF0Y2gyOgogICAgICAgICAgICAgICAgeCArPSAxCiAgICAgICAgICAgICAgICBEUC51cGRhdGUoaW50KHBlcmNlbnRhZ2UoeCwgbGVuKG1hdGNoMikpKSwgJycsICJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBuYW1lKSkKICAgICAgICAgICAgICAgIGlmIG5vdCB3cml0aW5nID09ICcnOiB3cml0aW5nICs9ICdcbicKICAgICAgICAgICAgICAgIHdyaXRpbmcgKz0gJ25hbWU9IiVzIlxuJyAlIG5hbWUKICAgICAgICAgICAgICAgIHdyaXRpbmcgKz0gJ3ZlcnNpb249IiVzIlxuJyAlIHZlcnNpb24KICAgICAgICAgICAgICAgIHdyaXRpbmcgKz0gJ3VybD0iJXMiXG4nICUgdXJsCiAgICAgICAgICAgICAgICB3cml0aW5nICs9ICdndWk9IiVzIlxuJyAlIGd1aQogICAgICAgICAgICAgICAgd3JpdGluZyArPSAna29kaT0iJXMiXG4nICUga29kaQogICAgICAgICAgICAgICAgd3JpdGluZyArPSAndGhlbWU9IiVzIlxuJyAlIHRoZW1lCiAgICAgICAgICAgICAgICB3cml0aW5nICs9ICdpY29uPSIlcyJcbicgJSBpY29uCiAgICAgICAgICAgICAgICB3cml0aW5nICs9ICdmYW5hcnQ9IiVzIlxuJyAlIGZhbmFydAogICAgICAgICAgICAgICAgd3JpdGluZyArPSAncHJldmlldz0iaHR0cDovLyJcbicKICAgICAgICAgICAgICAgIHdyaXRpbmcgKz0gJ2FkdWx0PSIlcyJcbicgJSBhZHVsdAogICAgICAgICAgICAgICAgd3JpdGluZyArPSAnZGVzY3JpcHRpb249IiVzIlxuJyAlIGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICBpZiBub3QgdGhlbWUgPT0gJ2h0dHA6Ly8nOgogICAgICAgICAgICAgICAgICAgIGZpbGVuYW1lMiA9IG9zLnBhdGguam9pbihURVhURklMRVMsICclc190aGVtZS50eHQnICUgbmFtZSkKICAgICAgICAgICAgICAgICAgICB0aGVtZXdyaXRlID0gJyc7IHgyID0gMAogICAgICAgICAgICAgICAgICAgIGEgPSBvcGVuVVJMKHRoZW1lKS5yZXBsYWNlKCdcbicsJycpLnJlcGxhY2UoJ1xyJywnJykucmVwbGFjZSgnXHQnLCcnKQogICAgICAgICAgICAgICAgICAgIERQLnVwZGF0ZSgwLCdbQ09MT1IgJXNdW0JdQ29udmVydGllbmRvIHRleHRvOlsvQl1bL0NPTE9SXSBbQ09MT1IgJXNdJXNfdGhlbWUudHh0Wy9DT0xPUl0nICUgKENPTE9SMiwgQ09MT1IxLCBuYW1lKSwnJywgJ1BvciBmYXZvciwgZXNwZXJlJykKICAgICAgICAgICAgICAgICAgICBtYXRjaDMgPSByZS5jb21waWxlKCduYW1lPSIoLis/KSIuKz9ybD0iKC4rPykiLis/Y29uPSIoLis/KSIuKz9hbmFydD0iKC4rPykiLis/ZXNjcmlwdGlvbj0iKC4rPykiJykuZmluZGFsbChhKQogICAgICAgICAgICAgICAgICAgIGZvciBuYW1lLCB1cmwsIGljb24sIGZhbmFydCwgZGVzY3JpcHRpb24gaW4gbWF0Y2gzOgogICAgICAgICAgICAgICAgICAgICAgICB4MiArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIERQLnVwZGF0ZShpbnQocGVyY2VudGFnZSh4MiwgbGVuKG1hdGNoMikpKSwgJycsICJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBuYW1lKSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHRoZW1ld3JpdGUgPT0gJyc6IHRoZW1ld3JpdGUgKz0gJ1xuJwogICAgICAgICAgICAgICAgICAgICAgICB0aGVtZXdyaXRlICs9ICduYW1lPSIlcyJcbicgJSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIHRoZW1ld3JpdGUgKz0gJ3VybD0iJXMiXG4nICUgdXJsCiAgICAgICAgICAgICAgICAgICAgICAgIHRoZW1ld3JpdGUgKz0gJ2ljb249IiVzIlxuJyAlIGljb24KICAgICAgICAgICAgICAgICAgICAgICAgdGhlbWV3cml0ZSArPSAnZmFuYXJ0PSIlcyJcbicgJSBmYW5hcnQKICAgICAgICAgICAgICAgICAgICAgICAgdGhlbWV3cml0ZSArPSAnYWR1bHQ9Im5vIlxuJwogICAgICAgICAgICAgICAgICAgICAgICB0aGVtZXdyaXRlICs9ICdkZXNjcmlwdGlvbj0iJXMiXG4nICUgZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICBmID0gb3BlbihmaWxlbmFtZTIsICd3Jyk7IGYud3JpdGUodGhlbWV3cml0ZSk7IGYuY2xvc2UoKQogICAgICAgIGYgPSBvcGVuKGZpbGVuYW1lLCAndycpOyBmLndyaXRlKHdyaXRpbmcpOyBmLmNsb3NlKCkKICAgIAogICAgaWYgbm90IEFQS0ZJTEUgPT0gJ2h0dHA6Ly8nOgogICAgICAgIGZpbGVuYW1lID0gb3MucGF0aC5qb2luKFRFWFRGSUxFUywgJ2Fwa3MudHh0JykKICAgICAgICB3cml0aW5nID0gJyc7IHggPSAwCiAgICAgICAgYSA9IG9wZW5VUkwoQVBLRklMRSkucmVwbGFjZSgnXG4nLCcnKS5yZXBsYWNlKCdccicsJycpLnJlcGxhY2UoJ1x0JywnJykKICAgICAgICBEUC51cGRhdGUoMCwnW0NPTE9SICVzXVtCXUNvbnZlcnRpZW5kbyB0ZXh0bzpbL0JdWy9DT0xPUl0gW0NPTE9SICVzXUFwa3MudHh0Wy9DT0xPUl0nICUgKENPTE9SMiwgQ09MT1IxKSwgJycsICdQb3IgZmF2b3IsIGVzcGVyZScpCiAgICAgICAgbWF0Y2ggPSByZS5jb21waWxlKCduYW1lPSIoLis/KSIuKz9ybD0iKC4rPykiLis/Y29uPSIoLis/KSIuKz9hbmFydD0iKC4rPykiJykuZmluZGFsbChhKQogICAgICAgIG1hdGNoMiA9IHJlLmNvbXBpbGUoJ25hbWU9IiguKz8pIi4rP3JsPSIoLis/KSIuKz9jb249IiguKz8pIi4rP2FuYXJ0PSIoLis/KSIuKz9kdWx0PSIoLis/KSIuKz9lc2NyaXB0aW9uPSIoLis/KSInKS5maW5kYWxsKGEpCiAgICAgICAgaWYgbGVuKG1hdGNoMikgPT0gMDoKICAgICAgICAgICAgZm9yIG5hbWUsIHVybCwgaWNvbiwgZmFuYXJ0IGluIG1hdGNoOgogICAgICAgICAgICAgICAgeCArPSAxCiAgICAgICAgICAgICAgICBEUC51cGRhdGUoaW50KHBlcmNlbnRhZ2UoeCwgbGVuKG1hdGNoKSkpLCAnJywgIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIG5hbWUpKQogICAgICAgICAgICAgICAgaWYgbm90IHdyaXRpbmcgPT0gJyc6IHdyaXRpbmcgKz0gJ1xuJwogICAgICAgICAgICAgICAgd3JpdGluZyArPSAnbmFtZT0iJXMiXG4nICUgbmFtZQogICAgICAgICAgICAgICAgd3JpdGluZyArPSAnc2VjdGlvbj0ibm8iJwogICAgICAgICAgICAgICAgd3JpdGluZyArPSAndXJsPSIlcyJcbicgJSB1cmwKICAgICAgICAgICAgICAgIHdyaXRpbmcgKz0gJ2ljb249IiVzIlxuJyAlIGljb24KICAgICAgICAgICAgICAgIHdyaXRpbmcgKz0gJ2ZhbmFydD0iJXMiXG4nICUgZmFuYXJ0CiAgICAgICAgICAgICAgICB3cml0aW5nICs9ICdhZHVsdD0ibm8iXG4nCiAgICAgICAgICAgICAgICB3cml0aW5nICs9ICdkZXNjcmlwdGlvbj0iRGVzY2FyZ2FkbyAlcyBkZSAlcyJcbicgJSAobmFtZSwgQURET05USVRMRSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBmb3IgbmFtZSwgdXJsLCBpY29uLCBmYW5hcnQsIGFkdWx0LCBkZXNjcmlwdGlvbiBpbiBtYXRjaDI6CiAgICAgICAgICAgICAgICB4ICs9IDEKICAgICAgICAgICAgICAgIERQLnVwZGF0ZShpbnQocGVyY2VudGFnZSh4LCBsZW4obWF0Y2gyKSkpLCAnJywgIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIG5hbWUpKQogICAgICAgICAgICAgICAgaWYgbm90IHdyaXRpbmcgPT0gJyc6IHdyaXRpbmcgKz0gJ1xuJwogICAgICAgICAgICAgICAgd3JpdGluZyArPSAnbmFtZT0iJXMiXG4nICUgbmFtZQogICAgICAgICAgICAgICAgd3JpdGluZyArPSAnc2VjdGlvbj0ibm8iJwogICAgICAgICAgICAgICAgd3JpdGluZyArPSAndXJsPSIlcyJcbicgJSB1cmwKICAgICAgICAgICAgICAgIHdyaXRpbmcgKz0gJ2ljb249IiVzIlxuJyAlIGljb24KICAgICAgICAgICAgICAgIHdyaXRpbmcgKz0gJ2ZhbmFydD0iJXMiXG4nICUgZmFuYXJ0CiAgICAgICAgICAgICAgICB3cml0aW5nICs9ICdhZHVsdD0iJXMiXG4nICUgYWR1bHQKICAgICAgICAgICAgICAgIHdyaXRpbmcgKz0gJ2Rlc2NyaXB0aW9uPSIlcyJcbicgJSBkZXNjcmlwdGlvbgogICAgICAgIGYgPSBvcGVuKGZpbGVuYW1lLCAndycpOyBmLndyaXRlKHdyaXRpbmcpOyBmLmNsb3NlKCkKICAgIAogICAgaWYgbm90IFlPVVRVQkVGSUxFID09ICdodHRwOi8vJzoKICAgICAgICBmaWxlbmFtZSA9IG9zLnBhdGguam9pbihURVhURklMRVMsICd5b3V0dWJlLnR4dCcpCiAgICAgICAgd3JpdGluZyA9ICcnOyB4ID0gMAogICAgICAgIGEgPSBvcGVuVVJMKFlPVVRVQkVGSUxFKS5yZXBsYWNlKCdcbicsJycpLnJlcGxhY2UoJ1xyJywnJykucmVwbGFjZSgnXHQnLCcnKQogICAgICAgIERQLnVwZGF0ZSgwLCdbQ09MT1IgJXNdW0JdQ29udmVydGllbmRvIHRleHRvOlsvQl1bL0NPTE9SXSBbQ09MT1IgJXNdWW91VHViZS50eHRbL0NPTE9SXScgJSAoQ09MT1IyLCBDT0xPUjEpLCAnJywgJ1BvciBmYXZvciwgZXNwZXJlJykKICAgICAgICBtYXRjaCA9IHJlLmNvbXBpbGUoJ25hbWU9IiguKz8pIi4rP3JsPSIoLis/KSIuKz9jb249IiguKz8pIi4rP2FuYXJ0PSIoLis/KSIuKz9lc2NyaXB0aW9uPSIoLis/KSInKS5maW5kYWxsKGEpCiAgICAgICAgZm9yIG5hbWUsIHVybCwgaWNvbiwgZmFuYXJ0LCBkZXNjcmlwdGlvbiBpbiBtYXRjaDoKICAgICAgICAgICAgeCArPSAxCiAgICAgICAgICAgIERQLnVwZGF0ZShpbnQocGVyY2VudGFnZSh4LCBsZW4obWF0Y2gpKSksICcnLCAiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgbmFtZSkpCiAgICAgICAgICAgIGlmIG5vdCB3cml0aW5nID09ICcnOiB3cml0aW5nICs9ICdcbicKICAgICAgICAgICAgd3JpdGluZyArPSAnbmFtZT0iJXMiXG4nICUgbmFtZQogICAgICAgICAgICB3cml0aW5nICs9ICdzZWN0aW9uPSJubyInCiAgICAgICAgICAgIHdyaXRpbmcgKz0gJ3VybD0iJXMiXG4nICUgdXJsCiAgICAgICAgICAgIHdyaXRpbmcgKz0gJ2ljb249IiVzIlxuJyAlIGljb24KICAgICAgICAgICAgd3JpdGluZyArPSAnZmFuYXJ0PSIlcyJcbicgJSBmYW5hcnQKICAgICAgICAgICAgd3JpdGluZyArPSAnZGVzY3JpcHRpb249IiVzIlxuJyAlIGRlc2NyaXB0aW9uCiAgICAgICAgZiA9IG9wZW4oZmlsZW5hbWUsICd3Jyk7IGYud3JpdGUod3JpdGluZyk7IGYuY2xvc2UoKQoKICAgIGlmIG5vdCBBRFZBTkNFREZJTEUgPT0gJ2h0dHA6Ly8nOgogICAgICAgIGZpbGVuYW1lID0gb3MucGF0aC5qb2luKFRFWFRGSUxFUywgJ2FkdmFuY2Vkc2V0dGluZ3MudHh0JykKICAgICAgICB3cml0aW5nID0gJyc7IHggPSAwCiAgICAgICAgYSA9IG9wZW5VUkwoQURWQU5DRURGSUxFKS5yZXBsYWNlKCdcbicsJycpLnJlcGxhY2UoJ1xyJywnJykucmVwbGFjZSgnXHQnLCcnKQogICAgICAgIERQLnVwZGF0ZSgwLCdbQ09MT1IgJXNdW0JdQ29udmVydGllbmRvIHRleHRvOlsvQl1bL0NPTE9SXSBbQ09MT1IgJXNdQWR2YW5jZWRTZXR0aW5ncy50eHRbL0NPTE9SXScgJSAoQ09MT1IyLCBDT0xPUjEpLCAnJywgJ1BvciBmYXZvciwgZXNwZXJlJykKICAgICAgICBtYXRjaCA9IHJlLmNvbXBpbGUoJ25hbWU9IiguKz8pIi4rP3JsPSIoLis/KSIuKz9jb249IiguKz8pIi4rP2FuYXJ0PSIoLis/KSIuKz9lc2NyaXB0aW9uPSIoLis/KSInKS5maW5kYWxsKGEpCiAgICAgICAgZm9yIG5hbWUsIHVybCwgaWNvbiwgZmFuYXJ0LCBkZXNjcmlwdGlvbiBpbiBtYXRjaDoKICAgICAgICAgICAgeCArPSAxCiAgICAgICAgICAgIERQLnVwZGF0ZShpbnQocGVyY2VudGFnZSh4LCBsZW4obWF0Y2gpKSksICcnLCAiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgbmFtZSkpCiAgICAgICAgICAgIGlmIG5vdCB3cml0aW5nID09ICcnOiB3cml0aW5nICs9ICdcbicKICAgICAgICAgICAgd3JpdGluZyArPSAnbmFtZT0iJXMiXG4nICUgbmFtZQogICAgICAgICAgICB3cml0aW5nICs9ICdzZWN0aW9uPSJubyInCiAgICAgICAgICAgIHdyaXRpbmcgKz0gJ3VybD0iJXMiXG4nICUgdXJsCiAgICAgICAgICAgIHdyaXRpbmcgKz0gJ2ljb249IiVzIlxuJyAlIGljb24KICAgICAgICAgICAgd3JpdGluZyArPSAnZmFuYXJ0PSIlcyJcbicgJSBmYW5hcnQKICAgICAgICAgICAgd3JpdGluZyArPSAnZGVzY3JpcHRpb249IiVzIlxuJyAlIGRlc2NyaXB0aW9uCiAgICAgICAgZiA9IG9wZW4oZmlsZW5hbWUsICd3Jyk7IGYud3JpdGUod3JpdGluZyk7IGYuY2xvc2UoKQogICAgCiAgICBEUC5jbG9zZSgpCiAgICBESUFMT0cub2soQURET05USVRMRSwgJ1tDT0xPUiAlc11UZXh0b3MgY29udmVydGlkb3MgeSBjb21wYXRpYmlsaXphZG9zIHBhcmEgbGEgdmVyc2lvbiAwLjEuNyB5IGd1YXJkYWRvcyBlbiBbQ09MT1IgJXNdL2FkZG9uX2RhdGEvJXMvWy9DT0xPUl0gY2FycGV0YVsvQ09MT1JdJyAlIChDT0xPUjIsIENPTE9SMSwgQURET05fSUQpKQoKZGVmIHJlbG9hZFByb2ZpbGUocHJvZmlsZT1Ob25lKToKICAgIGlmIHByb2ZpbGUgPT0gTm9uZTogCiAgICAgICAgI2lmIG9zLnBhdGguZXhpc3RzKFBST0ZJTEVTKToKICAgICAgICAjICAgcHJvZmlsZSA9IGdldEluZm8oJ1N5c3RlbS5Qcm9maWxlTmFtZScpCiAgICAgICAgIyAgIGxvZygiUHJvZmlsZTogJXMiICUgcHJvZmlsZSkKICAgICAgICAjICAgZWJpKCdMb2FkUHJvZmlsZSglcyknICUgcHJvZmlsZSkKICAgICAgICAjZWxzZToKICAgICAgICAjZWJpKCdNYXN0ZXJtb2RlJykKICAgICAgICBlYmkoJ0xvYWRQcm9maWxlKE1hc3RlciB1c2VyKScpCiAgICBlbHNlOiBlYmkoJ0xvYWRQcm9maWxlKCVzKScgJSBwcm9maWxlKQoKZGVmIGNodW5rcyhzLCBuKToKICAgIGZvciBzdGFydCBpbiByYW5nZSgwLCBsZW4ocyksIG4pOgogICAgICAgIHlpZWxkIHNbc3RhcnQ6c3RhcnQrbl0KCmRlZiBhc2NpaUNoZWNrKHVzZT1Ob25lLCBvdmVyPUZhbHNlKToKICAgIGlmIHVzZSA9PSBOb25lOgogICAgICAgIHNvdXJjZSA9IERJQUxPRy5icm93c2UoMywgJ1tDT0xPUiAlc11TZWxlY2Npb25hIGxhIGNhcnBldGEgYSBlc2NhbmVhclsvQ09MT1JdJyAlIENPTE9SMiwgJ2ZpbGVzJywgJycsIEZhbHNlLCBGYWxzZSwgSE9NRSkKICAgICAgICBpZiBvdmVyID09IFRydWU6CiAgICAgICAgICAgIHllcyA9IDEKICAgICAgICBlbHNlOgogICAgICAgICAgICB5ZXMgPSBESUFMT0cueWVzbm8oQURET05USVRMRSwnW0NPTE9SICVzXVF1aWVyZXMgW0NPTE9SICVzXWVsaW1pbmFyWy9DT0xPUl0gdG9kb3MgbG9zIGFyY2hpdm9zIGNvbiBjYXJhY3RlcmVzIGVzcGVjaWFsZXMgbyBzb2xvIFtDT0xPUiAlc11lc2NhbmVhciB5IHZlclsvQ09MT1JdIGxvcyByZXN1bHRhZG9zIGVuIGVsIGxvZz9bL0NPTE9SXScgJSAoQ09MT1IyLCBDT0xPUjEsIENPTE9SMSksIHllc2xhYmVsPSdbQl1bQ09MT1IgZ3JlZW5dRWxpbWluYXJbL0NPTE9SXVsvQl0nLCBub2xhYmVsPSdbQl1bQ09MT1IgcmVkXUVzY2FuZWFyIHkgdmVyWy9DT0xPUl1bL0JdJykKICAgIGVsc2U6IAogICAgICAgIHNvdXJjZSA9IHVzZQogICAgICAgIHllcyA9IDEKCiAgICBpZiBzb3VyY2UgPT0gIiI6CiAgICAgICAgTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgIltDT0xPUiAlc11Db21wcm9iYWNpb24gQVNDSUk6IENhbmNlbGFkb1svQ09MT1JdIiAlIENPTE9SMikKICAgICAgICByZXR1cm4KICAgIAogICAgZmlsZXNfZm91bmQgID0gb3MucGF0aC5qb2luKEFERE9OREFUQSwgJ2FzY2lpZmlsZXMudHh0JykKICAgIGZpbGVzX2ZhaWxzICA9IG9zLnBhdGguam9pbihBRERPTkRBVEEsICdhc2NpaWZhaWxzLnR4dCcpCiAgICBhZmlsZXMgICAgICAgPSBvcGVuKGZpbGVzX2ZvdW5kLCBtb2RlPSd3KycpCiAgICBhZmFpbHMgICAgICAgPSBvcGVuKGZpbGVzX2ZhaWxzLCBtb2RlPSd3KycpCiAgICBmMSAgICAgICAgICAgPSAwOyBmMiAgICAgICAgICAgPSAwCiAgICBpdGVtcyAgICAgICAgPSBmaWxlQ291bnQoc291cmNlKQogICAgbXNnICAgICAgICAgID0gJycKICAgIHByb2cgICAgICAgICA9IFtdCiAgICBsb2coIkFyY2hpdm8gZGUgb3JpZ2VuOiAoJXMpIiAlIHN0cihzb3VyY2UpLCB4Ym1jLkxPR05PVElDRSkKICAgIAogICAgRFAuY3JlYXRlKEFERE9OVElUTEUsICdQb3IgZmF2b3IsIGVzcGVyZS4uLicpCiAgICBmb3IgYmFzZSwgZGlycywgZmlsZXMgaW4gb3Mud2Fsayhzb3VyY2UpOgogICAgICAgIGRpcnNbOl0gPSBbZCBmb3IgZCBpbiBkaXJzXQogICAgICAgIGZpbGVzWzpdID0gW2YgZm9yIGYgaW4gZmlsZXNdCiAgICAgICAgZm9yIGZpbGUgaW4gZmlsZXM6CiAgICAgICAgICAgIHByb2cuYXBwZW5kKGZpbGUpIAogICAgICAgICAgICBwcm9nMiA9IGludChsZW4ocHJvZykgLyBmbG9hdChpdGVtcykgKiAxMDApCiAgICAgICAgICAgIERQLnVwZGF0ZShwcm9nMiwiW0NPTE9SICVzXUNvbXByb2JhY2lvbiBkZSBhcmNoaXZvcyBubyBBU0NJSSIgJSBDT0xPUjIsJ1tDT0xPUiAlc10lc1svQ09MT1JdJyAlIChDT0xPUjEsIGQpLCAnUG9yIGZhdm9yLCBlc3BlcmUuLi5bL0NPTE9SXScpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZpbGUuZW5jb2RlKCdhc2NpaScpCiAgICAgICAgICAgIGV4Y2VwdCBVbmljb2RlRGVjb2RlRXJyb3I6CiAgICAgICAgICAgICAgICBiYWRmaWxlID0gb3MucGF0aC5qb2luKGJhc2UsIGZpbGUpCiAgICAgICAgICAgICAgICBpZiB5ZXM6CiAgICAgICAgICAgICAgICAgICAgdHJ5OiAKICAgICAgICAgICAgICAgICAgICAgICAgb3MucmVtb3ZlKGJhZGZpbGUpCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBjaHVuayBpbiBjaHVua3MoYmFkZmlsZSwgNzUpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZpbGVzLndyaXRlKGNodW5rKydcbicpCiAgICAgICAgICAgICAgICAgICAgICAgIGFmaWxlcy53cml0ZSgnXG4nKQogICAgICAgICAgICAgICAgICAgICAgICBmMSArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZygiW0NvbXByb2JhY2lvbiBBU0NJSV0gQXJjaGl2byBlbGltaW5hZG86ICVzICIgJSBiYWRmaWxlLCB4Ym1jLkxPR0VSUk9SKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGNodW5rIGluIGNodW5rcyhiYWRmaWxlLCA3NSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZmFpbHMud3JpdGUoY2h1bmsrJ1xuJykKICAgICAgICAgICAgICAgICAgICAgICAgYWZhaWxzLndyaXRlKCdcbicpCiAgICAgICAgICAgICAgICAgICAgICAgIGYyICs9IDEKICAgICAgICAgICAgICAgICAgICAgICAgbG9nKCJbQ29tcHJvYmFjaW9uIEFTQ0lJXSBBcmNoaXZvIGZhbGxhZG86ICVzICIgJSBiYWRmaWxlLCB4Ym1jLkxPR0VSUk9SKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBmb3IgY2h1bmsgaW4gY2h1bmtzKGJhZGZpbGUsIDc1KToKICAgICAgICAgICAgICAgICAgICAgICAgYWZpbGVzLndyaXRlKGNodW5rKydcbicpCiAgICAgICAgICAgICAgICAgICAgYWZpbGVzLndyaXRlKCdcbicpCiAgICAgICAgICAgICAgICAgICAgZjEgKz0gMQogICAgICAgICAgICAgICAgICAgIGxvZygiW0NvbXByb2JhY2lvbiBBU0NJSV0gRmlsZSBlbmNvbnRyYWRvOiAlcyAiICUgYmFkZmlsZSwgeGJtYy5MT0dFUlJPUikKICAgICAgICAgICAgICAgIHBhc3MKICAgIERQLmNsb3NlKCk7IGFmaWxlcy5jbG9zZSgpOyBhZmFpbHMuY2xvc2UoKQogICAgdG90YWwgPSBpbnQoZjEpICsgaW50KGYyKQogICAgaWYgdG90YWwgPiAwOgogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGZpbGVzX2ZvdW5kKTogYWZpbGVzID0gb3BlbihmaWxlc19mb3VuZCwgbW9kZT0ncicpOyBtc2cgPSBhZmlsZXMucmVhZCgpOyBhZmlsZXMuY2xvc2UoKQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGZpbGVzX2ZhaWxzKTogYWZhaWxzID0gb3BlbihmaWxlc19mYWlscywgbW9kZT0ncicpOyBtc2cyID0gYWZhaWxzLnJlYWQoKTsgYWZhaWxzLmNsb3NlKCkKICAgICAgICBpZiB5ZXM6CiAgICAgICAgICAgIGlmIHVzZToKICAgICAgICAgICAgICAgIExvZ05vdGlmeSgiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgQURET05USVRMRSksICJbQ09MT1IgJXNdQ29tcHJvYmFjaW9uIEFTQ0lJOiAlcyBFbGltaW5hZG8gLyAlcyBGYWxsYWRvcy5bL0NPTE9SXSIgJSAoQ09MT1IyLCBmMSwgZjIpKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgVGV4dEJveChBRERPTlRJVExFLCAiW0NPTE9SIHllbGxvd11bQl0lcyBBcmNoaXZvcyBlbGltaW5hZG9zOlsvQl1bL0NPTE9SXVxuICVzXG5cbltDT0xPUiB5ZWxsb3ddW0JdJXMgQXJjaGl2b3MgZmFsbGFkb3M6W0JdWy9DT0xPUl1cbiAlcyIgJSAoZjEsIG1zZywgZjIsIG1zZzIpKQogICAgICAgIGVsc2U6IAogICAgICAgICAgICBUZXh0Qm94KEFERE9OVElUTEUsICJbQ09MT1IgeWVsbG93XVtCXSVzIEZpbGVzIGVuY29udHJhZG9zOlsvQl1bL0NPTE9SXVxuICVzIiAlIChmMSwgbXNnKSkKICAgIGVsc2U6IExvZ05vdGlmeSgiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgQURET05USVRMRSksICJbQ09MT1IgJXNdQ29tcHJvYmFjaW9uIEFTQ0lJOiBObyBzZSBoYSBlbmNvbnRyYWRvIG5pbmd1biBhcmNoaXZvLlsvQ09MT1JdIiAlIENPTE9SMikKCmRlZiBmaWxlQ291bnQoaG9tZSwgZXhjbHVkZXM9VHJ1ZSk6CiAgICBleGNsdWRlX2RpcnMgID0gW0FERE9OX0lELCAnY2FjaGUnLCAnc3lzdGVtJywgJ3BhY2thZ2VzJywgJ1RodW1ibmFpbHMnLCAncGVyaXBoZXJhbF9kYXRhJywgJ3RlbXAnLCAnU2Fsb25EaWdpdGFsX0JhY2t1cCcsICdsaWJyYXJ5JywgJ2tleW1hcHMnXQogICAgZXhjbHVkZV9maWxlcyA9IFsnVGV4dHVyZXMxMy5kYicsICcuRFNfU3RvcmUnLCAnYWR2YW5jZWRzZXR0aW5ncy54bWwnLCAnVGh1bWJzLmRiJywgJy5naXRpZ25vcmUnXQogICAgaXRlbSA9IFtdCiAgICBmb3IgYmFzZSwgZGlycywgZmlsZXMgaW4gb3Mud2Fsayhob21lKToKICAgICAgICBpZiBleGNsdWRlczoKICAgICAgICAgICAgZGlyc1s6XSA9IFtkIGZvciBkIGluIGRpcnMgaWYgZCBub3QgaW4gZXhjbHVkZV9kaXJzXQogICAgICAgICAgICBmaWxlc1s6XSA9IFtmIGZvciBmIGluIGZpbGVzIGlmIGYgbm90IGluIGV4Y2x1ZGVfZmlsZXNdCiAgICAgICAgZm9yIGZpbGUgaW4gZmlsZXM6CiAgICAgICAgICAgIGl0ZW0uYXBwZW5kKGZpbGUpCiAgICByZXR1cm4gbGVuKGl0ZW0pCgpkZWYgZGVmYXVsdFNraW4oKToKICAgIGxvZygiW0NvbXByb2JhY2lvbiBkZSBza2luXSIsIHhibWMuTE9HTk9USUNFKQogICAgdGVtcGd1aSA9IG9zLnBhdGguam9pbihVU0VSREFUQSwgJ2d1aXRlbXAueG1sJykKICAgIGd1aSA9IHRlbXBndWkgaWYgb3MucGF0aC5leGlzdHModGVtcGd1aSkgZWxzZSBHVUlTRVRUSU5HUwogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGd1aSk6IHJldHVybiBGYWxzZQogICAgbG9nKCJMZXllbmRvIGFyY2hpdm8gZGUgc2tpbjogJXMiICUgZ3VpLCB4Ym1jLkxPR05PVElDRSkKICAgIGd1aWYgPSBvcGVuKGd1aSwgJ3IrJykKICAgIG1zZyA9IGd1aWYucmVhZCgpLnJlcGxhY2UoJ1xuJywnJykucmVwbGFjZSgnXHInLCcnKS5yZXBsYWNlKCdcdCcsJycpLnJlcGxhY2UoJyAgICAnLCcnKTsgZ3VpZi5jbG9zZSgpCiAgICBsb2coIkFicmllbmRvIGFyY2hpdm8gZGUgc2tpbiIsIHhibWMuTE9HTk9USUNFKQogICAgbWF0Y2ggPSByZS5jb21waWxlKCc8bG9va2FuZGZlZWw+Lis/PHNraS4rPz4oLis/KTwvc2tpbj4uKz88L2xvb2thbmRmZWVsPicpLmZpbmRhbGwobXNnKQogICAgbG9nKCJDb2luY2lkZW5jaWFzOiAlcyIgJSBzdHIobWF0Y2gpLCB4Ym1jLkxPR05PVElDRSkKICAgIGlmIGxlbihtYXRjaCkgPiAwOgogICAgICAgIHNraW5pZCA9IG1hdGNoWzBdCiAgICAgICAgYWRkb254bWwgPSBvcy5wYXRoLmpvaW4oQURET05TLCBtYXRjaFswXSwgJ2FkZG9uLnhtbCcpCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoYWRkb254bWwpOgogICAgICAgICAgICBhZGRmID0gb3BlbihhZGRvbnhtbCwgJ3IrJykKICAgICAgICAgICAgbXNnMiA9IGFkZGYucmVhZCgpOyBhZGRmLmNsb3NlKCkKICAgICAgICAgICAgbWF0Y2gyID0gcGFyc2VET00obXNnMiwgJ2FkZG9uJywgcmV0PSduYW1lJykKICAgICAgICAgICAgaWYgbGVuKG1hdGNoMikgPiAwOiBza2lubmFtZSA9IG1hdGNoMlswXQogICAgICAgICAgICBlbHNlOiBza2lubmFtZSA9ICdubyBtYXRjaCcKICAgICAgICBlbHNlOiBza2lubmFtZSA9ICdubyBmaWxlJwogICAgICAgIGxvZygiW0NvbXByb2JhY2lvbiBkZSBza2luXSBOb21icmUgZGUgc2tpbjogJXMiICUgc2tpbm5hbWUsIHhibWMuTE9HTk9USUNFKQogICAgICAgIGxvZygiW0NvbXByb2JhY2lvbiBkZSBza2luXSBJRCBkZSBza2luOiAlcyIgJSBza2luaWQsIHhibWMuTE9HTk9USUNFKQogICAgICAgIHNldFMoJ2RlZmF1bHRza2luJywgc2tpbmlkKQogICAgICAgIHNldFMoJ2RlZmF1bHRza2lubmFtZScsIHNraW5uYW1lKQogICAgICAgIHNldFMoJ2RlZmF1bHRza2luaWdub3JlJywgJ2ZhbHNlJykKICAgIGlmIG9zLnBhdGguZXhpc3RzKHRlbXBndWkpOgogICAgICAgIGxvZygiRWxpbWluYW5kbyBhcmNoaXZvIHRlbXBvcmFsIGRlIHNraW4uIiwgeGJtYy5MT0dOT1RJQ0UpCiAgICAgICAgb3MucmVtb3ZlKHRlbXBndWkpCiAgICBsb2coIltDb21wcm9iYWNpb24gZGUgc2tpbl0gRmluIiwgeGJtYy5MT0dOT1RJQ0UpCgpkZWYgbG9va2FuZEZlZWxEYXRhKGRvPSdzYXZlJyk6CiAgICBzY2FuID0gWydsb29rYW5kZmVlbC5lbmFibGVyc3NmZWVkcycsICdsb29rYW5kZmVlbC5mb250JywgJ2xvb2thbmRmZWVsLnJzc2VkaXQnLCAnbG9va2FuZGZlZWwuc2tpbmNvbG9ycycsICdsb29rYW5kZmVlbC5za2ludGhlbWUnLCAnbG9va2FuZGZlZWwuc2tpbnpvb20nLCAnbG9va2FuZGZlZWwuc291bmRza2luJywgJ2xvb2thbmRmZWVsLnN0YXJ0dXB3aW5kb3cnLCAnbG9va2FuZGZlZWwuc3RlcmVvc3RyZW5ndGgnXQogICAgaWYgZG8gPT0gJ3NhdmUnOgogICAgICAgIGZvciBpdGVtIGluIHNjYW46CiAgICAgICAgICAgIHF1ZXJ5ID0gJ3sianNvbnJwYyI6IjIuMCIsICJtZXRob2QiOiJTZXR0aW5ncy5HZXRTZXR0aW5nVmFsdWUiLCJwYXJhbXMiOnsic2V0dGluZyI6IiVzIn0sICJpZCI6MX0nICUgKGl0ZW0pCiAgICAgICAgICAgIHJlc3BvbnNlID0geGJtYy5leGVjdXRlSlNPTlJQQyhxdWVyeSkKICAgICAgICAgICAgaWYgbm90ICdlcnJvcicgaW4gcmVzcG9uc2U6CiAgICAgICAgICAgICAgICBtYXRjaCA9IHJlLmNvbXBpbGUoJ3sidmFsdWUiOiguKz8pfScpLmZpbmRhbGwoc3RyKHJlc3BvbnNlKSkKICAgICAgICAgICAgICAgIHNldFMoaXRlbS5yZXBsYWNlKCdsb29rYW5kZmVlbCcsICdkZWZhdWx0JyksIG1hdGNoWzBdKQogICAgICAgICAgICAgICAgbG9nKCIlcyBndWFyZGFkbyBlbiAlcyIgJSAoaXRlbSwgbWF0Y2hbMF0pLCB4Ym1jLkxPR05PVElDRSkKICAgIGVsc2U6CiAgICAgICAgZm9yIGl0ZW0gaW4gc2NhbjoKICAgICAgICAgICAgdmFsdWUgPSBnZXRTKGl0ZW0ucmVwbGFjZSgnbG9va2FuZGZlZWwnLCAnZGVmYXVsdCcpKQogICAgICAgICAgICBxdWVyeSA9ICd7Impzb25ycGMiOiIyLjAiLCAibWV0aG9kIjoiU2V0dGluZ3MuU2V0U2V0dGluZ1ZhbHVlIiwicGFyYW1zIjp7InNldHRpbmciOiIlcyIsInZhbHVlIjolc30sICJpZCI6MX0nICUgKGl0ZW0sIHZhbHVlKQogICAgICAgICAgICByZXNwb25zZSA9IHhibWMuZXhlY3V0ZUpTT05SUEMocXVlcnkpCiAgICAgICAgICAgIGxvZygiJXMgcmVzdGF1cmFkbyBlbiAlcyIgJSAoaXRlbSwgdmFsdWUpLCB4Ym1jLkxPR05PVElDRSkKCmRlZiBzZXAobWlkZGxlPScnKToKICAgIGNoYXIgPSBTUEFDRVIKICAgIHJldCA9IGNoYXIgKiA0MAogICAgaWYgbm90IG1pZGRsZSA9PSAnJzogCiAgICAgICAgbWlkZGxlID0gJ1sgJXMgXScgJSBtaWRkbGUKICAgICAgICBmbHVmZiA9IGludCgoNDAgLSBsZW4obWlkZGxlKSkvMikKICAgICAgICByZXQgPSAiJXMlcyVzIiAlIChyZXRbOmZsdWZmXSwgbWlkZGxlLCByZXRbOmZsdWZmKzJdKQogICAgcmV0dXJuIHJldFs6NDBdCgpkZWYgY29udmVydEFkdmFuY2VkKCk6CiAgICBpZiBvcy5wYXRoLmV4aXN0cyhBRFZBTkNFRCk6CiAgICAgICAgZiA9IG9wZW4oQURWQU5DRUQpCiAgICAgICAgYSA9IGYucmVhZCgpCiAgICAgICAgaWYgS09ESVYgPj0gMTc6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybgogICAgZWxzZTogTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgIltDT0xPUiAlc11BcmNoaXZvIEFkdmFuY2VkU2V0dGluZ3MueG1sIG5vIGVuY29udHJhZG9bL0NPTE9SXSIpCgojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwojIyNCQUNLVVAvUkVTVEFVUkFDSU9OICMjIyMjIyMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKZGVmIGJhY2tVcE9wdGlvbnModHlwZSwgbmFtZT0iIik6CiAgICBleGNsdWRlX2RpcnMgID0gW0FERE9OX0lELCAnY2FjaGUnLCAnc3lzdGVtJywgJ1RodW1ibmFpbHMnLCAncGVyaXBoZXJhbF9kYXRhJywgJ3RlbXAnLCAnU2Fsb25EaWdpdGFsX0JhY2t1cCcsICdsaWJyYXJ5JywgJ2tleW1hcHMnXQogICAgZXhjbHVkZV9maWxlcyA9IFsnVGV4dHVyZXMxMy5kYicsICcuRFNfU3RvcmUnLCAnYWR2YW5jZWRzZXR0aW5ncy54bWwnLCAnVGh1bWJzLmRiJywgJy5naXRpZ25vcmUnXQogICAgYmFkX2ZpbGVzICAgICA9IFtvcy5wYXRoLmpvaW4oREFUQUJBU0UsICdvbmVjaGFubmVsY2FjaGUuZGInKSwKICAgICAgICAgICAgICAgICAgICAgb3MucGF0aC5qb2luKERBVEFCQVNFLCAnc2FsdHNjYWNoZS5kYicpLCAKICAgICAgICAgICAgICAgICAgICAgb3MucGF0aC5qb2luKERBVEFCQVNFLCAnc2FsdHNjYWNoZS5kYi1zaG0nKSwgCiAgICAgICAgICAgICAgICAgICAgIG9zLnBhdGguam9pbihEQVRBQkFTRSwgJ3NhbHRzY2FjaGUuZGItd2FsJyksCiAgICAgICAgICAgICAgICAgICAgIG9zLnBhdGguam9pbihEQVRBQkFTRSwgJ3NhbHRzaGQubGl0ZS5kYicpLAogICAgICAgICAgICAgICAgICAgICBvcy5wYXRoLmpvaW4oREFUQUJBU0UsICdzYWx0c2hkLmxpdGUuZGItc2htJyksIAogICAgICAgICAgICAgICAgICAgICBvcy5wYXRoLmpvaW4oREFUQUJBU0UsICdzYWx0c2hkLmxpdGUuZGItd2FsJyksCiAgICAgICAgICAgICAgICAgICAgIG9zLnBhdGguam9pbihBRERPTkQsICdzY3JpcHQudHJha3QnLCAncXVldWUuZGInKSwKICAgICAgICAgICAgICAgICAgICAgb3MucGF0aC5qb2luKEhPTUUsICdjYWNoZScsICdjb21tb25jYWNoZS5kYicpLAogICAgICAgICAgICAgICAgICAgICBvcy5wYXRoLmpvaW4oQURET05ELCAnc2NyaXB0Lm1vZHVsZS5kdWRlaGVyZS5yb3V0aW5lcycsICdhY2Nlc3MubG9nJyksCiAgICAgICAgICAgICAgICAgICAgIG9zLnBhdGguam9pbihBRERPTkQsICdzY3JpcHQubW9kdWxlLmR1ZGVoZXJlLnJvdXRpbmVzJywgJ3RyYWt0LmRiJyksCiAgICAgICAgICAgICAgICAgICAgIG9zLnBhdGguam9pbihBRERPTkQsICdzY3JpcHQubW9kdWxlLm1ldGFoYW5kbGVyJywgJ21ldGFfY2FjaGUnLCAndmlkZW9fY2FjaGUuZGInKV0KICAgIAogICAgYmFja3VwICAgPSB4Ym1jLnRyYW5zbGF0ZVBhdGgoQkFDS1VQTE9DQVRJT04pCiAgICBteWJ1aWxkcyA9IHhibWMudHJhbnNsYXRlUGF0aChNWUJVSUxEUykKICAgIHRyeToKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoYmFja3VwKTogeGJtY3Zmcy5ta2RpcnMoYmFja3VwKQogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhteWJ1aWxkcyk6IHhibWN2ZnMubWtkaXJzKG15YnVpbGRzKQogICAgZXhjZXB0IEV4Y2VwdGlvbiwgZToKICAgICAgICBESUFMT0cub2soQURET05USVRMRSwgIltDT0xPUiAlc11FcnJvciBjcmVhbmRvIGVsIGRpcmVjdG9yaW8gZGUgYkFDS1VQOlsvQ09MT1JdIiAlIChDT0xPUjIpLCAiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgc3RyKGUpKSkKICAgICAgICByZXR1cm4KICAgIGlmIHR5cGUgPT0gImJ1aWxkIjoKICAgICAgICBpZiBESUFMT0cueWVzbm8oQURET05USVRMRSwgIltDT0xPUiAlc11RdWllcmVzIGhhY2VyIHVuYSBjb3BpYSBkZSBsYSB2ZXJzaW9uIGFjdHVhbD9bL0NPTE9SXSIgJSBDT0xPUjIsIG5vbGFiZWw9IltCXVtDT0xPUiByZWRdQ2FuY2VsYXJbL0NPTE9SXVsvQl0iLCB5ZXNsYWJlbD0iW0JdW0NPTE9SIGdyZWVuXUhhY2VyIGJhY2t1cFsvQ09MT1JdWy9CXSIpOgogICAgICAgICAgICBpZiBuYW1lID09ICIiOgogICAgICAgICAgICAgICAgbmFtZSA9IGdldEtleWJvYXJkKCIiLCJQb3IgZmF2b3IsIGludHJvZHVjZSBlbCBub21icmUgcGFyYSAlcyB6aXAiICUgdHlwZSkKICAgICAgICAgICAgICAgIGlmIG5vdCBuYW1lOiByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoJ1xcJywgJycpLnJlcGxhY2UoJy8nLCAnJykucmVwbGFjZSgnOicsICcnKS5yZXBsYWNlKCcqJywgJycpLnJlcGxhY2UoJz8nLCAnJykucmVwbGFjZSgnIicsICcnKS5yZXBsYWNlKCc8JywgJycpLnJlcGxhY2UoJz4nLCAnJykucmVwbGFjZSgnfCcsICcnKQogICAgICAgICAgICBuYW1lID0gdXJsbGliLnF1b3RlX3BsdXMobmFtZSk7IHRlbXB6aXBuYW1lID0gJycKICAgICAgICAgICAgemlwbmFtZSA9IG9zLnBhdGguam9pbihteWJ1aWxkcywgJyVzLnppcCcgJSBuYW1lKQogICAgICAgICAgICBmb3JfcHJvZ3Jlc3MgID0gMAogICAgICAgICAgICBJVEVNICAgICAgICAgID0gW10KICAgICAgICAgICAgaWYgbm90IERJQUxPRy55ZXNubyhBRERPTlRJVExFLCAiW0NPTE9SICVzXVF1aWVyZXMgaW5jbHVpciBsb3MgZGF0b3MgZGUgbG9zIGFkZG9ucz8iICUgQ09MT1IyLCAnQ29udGllbmUgW0NPTE9SICVzXVRPRE9TWy9DT0xPUl0gbG9zIGRhdG9zIGRlIHRvZG9zIGxvcyBhZGRvbnMsIGNvbW8gcGFzc3dvcmRzLCBza2luLCBpY29ub3MsIGV0Yy4gVGUgcmVjb21lbmRhbW9zIFtDT0xPUiAlc11NQU5VQUxNRU5URVsvQ09MT1JdIGVsaW1pbmFyIGxvcyBkYXRvcyBkZSBhZGRvbnMgcXVlIG5vIHZheWFzIGEgdXNhci4nICUgKENPTE9SMSwgQ09MT1IxKSwgJ1tDT0xPUiAlc10lc1svQ09MT1JdIGFkZG9uX2RhdGEgc2VyYSBpZ25vcmFkb1svQ09MT1JdJyAlIChDT0xPUjEsIEFERE9OX0lEKSwgeWVzbGFiZWw9J1tCXVtDT0xPUiBncmVlbl1JbmNsdWlyIGRhdG9zWy9DT0xPUl1bL0JdJyxub2xhYmVsPSdbQl1bQ09MT1IgcmVkXU5vIEluY2x1aXJbL0NPTE9SXVsvQl0nKToKICAgICAgICAgICAgICAgIGV4Y2x1ZGVfZGlycy5hcHBlbmQoJ2FkZG9uX2RhdGEnKQogICAgICAgICAgICBjb252ZXJ0U3BlY2lhbChIT01FLCBUcnVlKQogICAgICAgICAgICBhc2NpaUNoZWNrKEhPTUUsIFRydWUpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHppcGYgPSB6aXBmaWxlLlppcEZpbGUoeGJtYy50cmFuc2xhdGVQYXRoKHppcG5hbWUpLCBtb2RlPSd3JykKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHRlbXB6aXBuYW1lID0gb3MucGF0aC5qb2luKFBBQ0tBR0VTLCAnJXMuemlwJyAlIG5hbWUpCiAgICAgICAgICAgICAgICAgICAgemlwZiA9IHppcGZpbGUuWmlwRmlsZSh0ZW1wemlwbmFtZSwgbW9kZT0ndycpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgbG9nKCJObyBlcyBwb3NpYmxlIGNyZWFyICVzLnppcCIgJSBuYW1lLCB4Ym1jLkxPR0VSUk9SKQogICAgICAgICAgICAgICAgICAgIGlmIERJQUxPRy55ZXNubyhBRERPTlRJVExFLCAiW0NPTE9SICVzXUltcG9zaWJsZSBlc2NyaWJpciBlbiBlbCBkaXJlY3RvcmlvIGRlIGJhY2t1cHMsIHF1aWVyZXMgc2VsZWNjaW9uYXIgb3Rybz9bL0NPTE9SXSIgJSBDT0xPUjIsIHllc2xhYmVsPSJbQl1bQ09MT1IgZ3JlZW5dQ2FtYmlhciBkaXJlY3RvcmlvWy9DT0xPUl1bL0JdIiwgbm9sYWJlbD0iW0JdW0NPTE9SIHJlZF1DYW5jZWxhclsvQ09MT1JdWy9CXSIpOgogICAgICAgICAgICAgICAgICAgICAgICBvcGVuUygpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICBEUC5jcmVhdGUoIltDT0xPUiAlc10lc1svQ09MT1JdW0NPTE9SICVzXTogQ3JlYW5kbyB6aXBbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFLENPTE9SMiksICJbQ09MT1IgJXNdQ3JlYW5kbyB6aXAiICUgQ09MT1IyLCAiIiwgIlBvciBmYXZvciwgZXNwZXJlLi4uWy9DT0xPUl0iKQogICAgICAgICAgICBmb3IgYmFzZSwgZGlycywgZmlsZXMgaW4gb3Mud2FsayhIT01FKToKICAgICAgICAgICAgICAgIGRpcnNbOl0gPSBbZCBmb3IgZCBpbiBkaXJzIGlmIGQgbm90IGluIGV4Y2x1ZGVfZGlyc10KICAgICAgICAgICAgICAgIGZpbGVzWzpdID0gW2YgZm9yIGYgaW4gZmlsZXMgaWYgZiBub3QgaW4gZXhjbHVkZV9maWxlc10KICAgICAgICAgICAgICAgIGZvciBmaWxlIGluIGZpbGVzOgogICAgICAgICAgICAgICAgICAgIElURU0uYXBwZW5kKGZpbGUpCiAgICAgICAgICAgIE5fSVRFTSA9IGxlbihJVEVNKQogICAgICAgICAgICBmaXhtZXRhcygpCiAgICAgICAgICAgIGZvciBiYXNlLCBkaXJzLCBmaWxlcyBpbiBvcy53YWxrKEhPTUUpOgogICAgICAgICAgICAgICAgZGlyc1s6XSA9IFtkIGZvciBkIGluIGRpcnMgaWYgZCBub3QgaW4gZXhjbHVkZV9kaXJzXQogICAgICAgICAgICAgICAgZmlsZXNbOl0gPSBbZiBmb3IgZiBpbiBmaWxlcyBpZiBmIG5vdCBpbiBleGNsdWRlX2ZpbGVzXQogICAgICAgICAgICAgICAgZm9yIGZpbGUgaW4gZmlsZXM6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBmb3JfcHJvZ3Jlc3MgKz0gMQogICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzcyA9IHBlcmNlbnRhZ2UoZm9yX3Byb2dyZXNzLCBOX0lURU0pIAogICAgICAgICAgICAgICAgICAgICAgICBEUC51cGRhdGUoaW50KHByb2dyZXNzKSwgJ1tDT0xPUiAlc11DcmVhbmRvIHppcDogW0NPTE9SJXNdJXNbL0NPTE9SXSAvIFtDT0xPUiVzXSVzWy9DT0xPUl0nICUgKENPTE9SMiwgQ09MT1IxLCBmb3JfcHJvZ3Jlc3MsIENPTE9SMSwgTl9JVEVNKSwgJ1tDT0xPUiAlc10lc1svQ09MT1JdJyAlIChDT0xPUjEsIGZpbGUpLCAnJykKICAgICAgICAgICAgICAgICAgICAgICAgZm4gPSBvcy5wYXRoLmpvaW4oYmFzZSwgZmlsZSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZmlsZSBpbiBMT0dGSUxFUzogbG9nKCJbQmFjayBVcF0gVHlwZSA9ICclcyc6IElnbm9yZSAlcyIgJSAodHlwZSwgZmlsZSksIHhibWMuTE9HTk9USUNFKTsgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiBvcy5wYXRoLmpvaW4oYmFzZSwgZmlsZSkgaW4gYmFkX2ZpbGVzOiBsb2coIltCYWNrIFVwXSBUeXBlID0gJyVzJzogSWdub3JlICVzIiAlICh0eXBlLCBmaWxlKSwgeGJtYy5MT0dOT1RJQ0UpOyBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICAgICBlbGlmIG9zLnBhdGguam9pbignYWRkb25zJywgJ3BhY2thZ2VzJykgaW4gZm46IGxvZygiW0JhY2sgVXBdIFR5cGUgPSAnJXMnOiBJZ25vcmUgJXMiICUgKHR5cGUsIGZpbGUpLCB4Ym1jLkxPR05PVElDRSk7IGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgZmlsZS5lbmRzd2l0aCgnLmNzdicpOiBsb2coIltCYWNrIFVwXSBUeXBlID0gJyVzJzogSWdub3JlICVzIiAlICh0eXBlLCBmaWxlKSwgeGJtYy5MT0dOT1RJQ0UpOyBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICAgICBlbGlmIGZpbGUuZW5kc3dpdGgoJy5weW8nKTogY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiBmaWxlLmVuZHN3aXRoKCcuZGInKSBhbmQgJ0RhdGFiYXNlJyBpbiBiYXNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcCA9IGZpbGUucmVwbGFjZSgnLmRiJywgJycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wID0gJycuam9pbihbaSBmb3IgaSBpbiB0ZW1wIGlmIG5vdCBpLmlzZGlnaXQoKV0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0ZW1wIGluIFsnQWRkb25zJywgJ0FEU1AnLCAnRXBnJywgJ015TXVzaWMnLCAnTXlWaWRlb3MnLCAnVGV4dHVyZXMnLCAnVFYnLCAnVmlld01vZGVzJ106CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IGZpbGUgPT0gbGF0ZXN0REIodGVtcCk6ICBsb2coIltCYWNrIFVwXSBUeXBlID0gJyVzJzogSWdub3JlICVzIiAlICh0eXBlLCBmaWxlKSwgeGJtYy5MT0dOT1RJQ0UpOyBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB6aXBmLndyaXRlKGZuLCBmbltsZW4oSE9NRSk6XSwgemlwZmlsZS5aSVBfREVGTEFURUQpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24sIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2coIltCYWNrIFVwXSBUeXBlID0gJyVzJzogVW5hYmxlIHRvIGJhY2t1cCAlcyIgJSAodHlwZSwgZmlsZSksIHhibWMuTE9HTk9USUNFKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nKCIlcyAvICVzIiAlIChFeGNlcHRpb24sIGUpKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24sIGU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZygiW0JhY2sgVXBdIFR5cGUgPSAnJXMnOiBVbmFibGUgdG8gYmFja3VwICVzIiAlICh0eXBlLCBmaWxlKSwgeGJtYy5MT0dOT1RJQ0UpCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZygiQnVpbGQgQmFja3VwIEVycm9yOiAlcyIgJSBzdHIoZSksIHhibWMuTE9HTk9USUNFKQogICAgICAgICAgICB6aXBmLmNsb3NlKCkKICAgICAgICAgICAgeGJtYy5zbGVlcCg1MDApCiAgICAgICAgICAgIERQLnVwZGF0ZSgxMDAsICJDcmVhbmRvICVzX2d1aXNldHRpbmdzLnppcCIgJSBuYW1lLCAiIiwgIiIpCiAgICAgICAgICAgIGJhY2tVcE9wdGlvbnMoJ2d1aWZpeCcsIG5hbWUpCiAgICAgICAgICAgIGlmIG5vdCB0ZW1wemlwbmFtZSA9PSAnJzoKICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSB4Ym1jdmZzLnJlbmFtZSh0ZW1wemlwbmFtZSwgemlwbmFtZSkKICAgICAgICAgICAgICAgIGlmIHN1Y2Nlc3MgPT0gMDoKICAgICAgICAgICAgICAgICAgICB4Ym1jdmZzLmNvcHkodGVtcHppcG5hbWUsIHppcG5hbWUpCiAgICAgICAgICAgICAgICAgICAgeGJtY3Zmcy5kZWxldGUodGVtcHppcG5hbWUpCiAgICAgICAgICAgIERQLmNsb3NlKCkKICAgICAgICAgICAgRElBTE9HLm9rKEFERE9OVElUTEUsICJbQ09MT1IgJXNdJXNbL0NPTE9SXSBbQ09MT1IgJXNdQmFja3VwIGNyZWFkbyBjb24gZXhpdG86Wy9DT0xPUl0iICUgKENPTE9SMSwgbmFtZSwgQ09MT1IyKSwgIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIHppcG5hbWUpKQogICAgZWxpZiB0eXBlID09ICJndWlmaXgiOgogICAgICAgIGlmIG5hbWUgPT0gIiI6CiAgICAgICAgICAgIGd1aW5hbWUgPSBnZXRLZXlib2FyZCgiIiwiUG9yIGZhdm9yLCBpbnRyb2R1emNhIGVsIG5vbWJyZSBwYXJhICVzIHppcCIgJSB0eXBlKQogICAgICAgICAgICBpZiBub3QgZ3VpbmFtZTogcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGNvbnZlcnRTcGVjaWFsKFVTRVJEQVRBLCBUcnVlKQogICAgICAgICAgICBhc2NpaUNoZWNrKFVTRVJEQVRBLCBUcnVlKQogICAgICAgIGVsc2U6IGd1aW5hbWUgPSBuYW1lCiAgICAgICAgZ3VpbmFtZSA9IHVybGxpYi5xdW90ZV9wbHVzKGd1aW5hbWUpOyB0ZW1wZ3VpemlwbmFtZSA9ICcnCiAgICAgICAgZ3VpemlwbmFtZSA9IHhibWMudHJhbnNsYXRlUGF0aChvcy5wYXRoLmpvaW4obXlidWlsZHMsICclc19ndWlzZXR0aW5ncy56aXAnICUgZ3VpbmFtZSkpCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoR1VJU0VUVElOR1MpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB6aXBmID0gemlwZmlsZS5aaXBGaWxlKGd1aXppcG5hbWUsIG1vZGU9J3cnKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgdGVtcGd1aXppcG5hbWUgPSBvcy5wYXRoLmpvaW4oUEFDS0FHRVMsICclc19ndWlzZXR0aW5ncy56aXAnICUgZ3VpbmFtZSkKICAgICAgICAgICAgICAgICAgICB6aXBmID0gemlwZmlsZS5aaXBGaWxlKHRlbXBndWl6aXBuYW1lLCBtb2RlPSd3JykKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBsb2coIk5vIGVzIHBvc2libGUgY3JlYXIgJXNfZ3Vpc2V0dGluZ3MuemlwIiAlIGd1aW5hbWUsIHhibWMuTE9HRVJST1IpCiAgICAgICAgICAgICAgICAgICAgaWYgRElBTE9HLnllc25vKEFERE9OVElUTEUsICJbQ09MT1IgJXNdSW1wb3NpYmxlIGVzY3JpYmlyIGVuIGVsIGRpcmVjdG9yaW8gZGUgYmFja3VwcywgcXVpZXJlcyBzZWxlY2Npb25hciBvdHJvP1svQ09MT1JdIiAlIENPTE9SMiwgeWVzbGFiZWw9IltCXVtDT0xPUiBncmVlbl1DYW1iaWFyIGRpcmVjdG9yaW9bL0NPTE9SXVsvQl0iLCBub2xhYmVsPSJbQl1bQ09MT1IgcmVkXUNhbmNlbGFyWy9DT0xPUl1bL0JdIik6CiAgICAgICAgICAgICAgICAgICAgICAgIG9wZW5TKCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHppcGYud3JpdGUoR1VJU0VUVElOR1MsICdndWlzZXR0aW5ncy54bWwnLCB6aXBmaWxlLlpJUF9ERUZMQVRFRCkKICAgICAgICAgICAgICAgIHppcGYud3JpdGUoUFJPRklMRVMsICAgICdwcm9maWxlcy54bWwnLCAgICB6aXBmaWxlLlpJUF9ERUZMQVRFRCkKICAgICAgICAgICAgICAgIG1hdGNoID0gZ2xvYi5nbG9iKG9zLnBhdGguam9pbihBRERPTkQsJ3NraW4uKicsICcnKSkKICAgICAgICAgICAgICAgIGxvZyhzdHIobWF0Y2gpLCB4Ym1jLkxPR05PVElDRSkKICAgICAgICAgICAgICAgIGZvciBmb2xkIGluIG1hdGNoOgogICAgICAgICAgICAgICAgICAgIGZkID0gb3MucGF0aC5zcGxpdChmb2xkWzotMV0pWzFdCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IGZkIGluIFsnc2tpbi5jb25mbHVlbmNlJywgJ3NraW4ucmUtdG91Y2gnLCAnc2tpbi5lc3R1YXJ5JywgJ3NraW4uZXN0b3VjaHknXToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgRElBTE9HLnllc25vKEFERE9OVElUTEUsICJbQ09MT1IgJXNdUXVpZXJlcyBpbmNsdWlyIGxhIHNraW4gc2lndWllbnRlIHkgc3VzIG9wY2lvbmVzIGVuIHVuIGJhY2t1cCByZXN0YXVyYWJsZT9bL0NPTE9SXSIgJSBDT0xPUjIsICJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBmZCksIHllc2xhYmVsPSJbQl1bQ09MT1IgZ3JlZW5dU2lbL0NPTE9SXVsvQl0iLCBub2xhYmVsPSJbQl1bQ09MT1IgcmVkXU5vWy9DT0xPUl1bL0JdIik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgYmFzZSwgZGlycywgZmlsZXMgaW4gb3Mud2Fsayhvcy5wYXRoLmpvaW4oQURET05ELGZvbGQpKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlc1s6XSA9IFtmIGZvciBmIGluIGZpbGVzIGlmIGYgbm90IGluIGV4Y2x1ZGVfZmlsZXNdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGZpbGUgaW4gZmlsZXM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuID0gb3MucGF0aC5qb2luKGJhc2UsIGZpbGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHppcGYud3JpdGUoZm4sIGZuW2xlbihVU0VSREFUQSk6XSwgemlwZmlsZS5aSVBfREVGTEFURUQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCAgPSBwYXJzZURPTShsaW5rLCAnaW1wb3J0JywgcmV0PSdhZGRvbicpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAnc2NyaXB0LnNraW5zaG9ydGN1dHMnIGluIG1hdGNoOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBiYXNlLCBkaXJzLCBmaWxlcyBpbiBvcy53YWxrKG9zLnBhdGguam9pbihBRERPTkQsJ3NjcmlwdC5za2luc2hvcnRjdXRzJykpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlc1s6XSA9IFtmIGZvciBmIGluIGZpbGVzIGlmIGYgbm90IGluIGV4Y2x1ZGVfZmlsZXNdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBmaWxlIGluIGZpbGVzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4gPSBvcy5wYXRoLmpvaW4oYmFzZSwgZmlsZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHppcGYud3JpdGUoZm4sIGZuW2xlbihVU0VSREFUQSk6XSwgemlwZmlsZS5aSVBfREVGTEFURUQpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6IGxvZygiW0JhY2sgVXBdIFR5cGUgPSAnJXMnOiAlcyBpZ25vcmVkIiAlICh0eXBlLCBmb2xkKSwgeGJtYy5MT0dOT1RJQ0UpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24sIGU6CiAgICAgICAgICAgICAgICBsb2coIltCYWNrIFVwXSBUeXBlID0gJyVzJzogJXMiICUgKHR5cGUsIGUpLCB4Ym1jLkxPR05PVElDRSkKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgemlwZi5jbG9zZSgpCiAgICAgICAgICAgIGlmIG5vdCB0ZW1wZ3VpemlwbmFtZSA9PSAnJzoKICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSB4Ym1jdmZzLnJlbmFtZSh0ZW1wZ3VpemlwbmFtZSwgZ3VpemlwbmFtZSkKICAgICAgICAgICAgICAgIGlmIHN1Y2Nlc3MgPT0gMDoKICAgICAgICAgICAgICAgICAgICB4Ym1jdmZzLmNvcHkodGVtcGd1aXppcG5hbWUsIGd1aXppcG5hbWUpCiAgICAgICAgICAgICAgICAgICAgeGJtY3Zmcy5kZWxldGUodGVtcGd1aXppcG5hbWUpCiAgICAgICAgZWxzZTogbG9nKCJbQmFjayBVcF0gVHlwZSA9ICclcyc6IGd1aXNldHRpbmdzLnhtbCBub3QgZm91bmQiICUgdHlwZSwgeGJtYy5MT0dOT1RJQ0UpCiAgICAgICAgaWYgbmFtZSA9PSAiIjoKICAgICAgICAgICAgRElBTE9HLm9rKEFERE9OVElUTEUsICJbQ09MT1IgJXNdQ29waWEgZGUgc2tpbiB5IHN1cyBkYXRvcyBjcmVhZGEgY29uIGV4aXRvOlsvQ09MT1JdIiAlIChDT0xPUjIpLCAiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgZ3VpemlwbmFtZSkpCiAgICBlbGlmIHR5cGUgPT0gInRoZW1lIjoKICAgICAgICBpZiBub3QgRElBTE9HLnllc25vKCdbQ09MT1IgJXNdJXNbL0NPTE9SXVtDT0xPUiAlc106IEJhY2t1cCBkZSB0ZW1hWy9DT0xPUl0nICUgKENPTE9SMSwgQURET05USVRMRSwgQ09MT1IyKSwgIltDT0xPUiAlc11RdWllcmVzIGNyZWFyIHVuYSBjb3BpYSBkZWwgdGVtYSBhY3R1YWw/Wy9DT0xPUl0iICUgQ09MT1IyLCB5ZXNsYWJlbD0iW0JdW0NPTE9SIGdyZWVuXUNvbnRpbnVhclsvQ09MT1JdWy9CXSIsIG5vbGFiZWw9IltCXVtDT0xPUiByZWRdTm8sIENhbmNlbGFyWy9DT0xPUl1bL0JdIik6IExvZ05vdGlmeSgiQ29waWEgZGUgVGVtYSIsICJDYW5jZWxhZG8hIik7IHJldHVybiBGYWxzZQogICAgICAgIGlmIG5hbWUgPT0gIiI6CiAgICAgICAgICAgIHRoZW1lbmFtZSA9IGdldEtleWJvYXJkKCIiLCJQb3IgZmF2b3IsIGludHJvZHV6Y2EgZWwgbm9tYnJlIHBhcmEgJXMgemlwIiAlIHR5cGUpCiAgICAgICAgICAgIGlmIG5vdCB0aGVtZW5hbWU6IHJldHVybiBGYWxzZQogICAgICAgIGVsc2U6IHRoZW1lbmFtZSA9IG5hbWUKICAgICAgICB0aGVtZW5hbWUgPSB1cmxsaWIucXVvdGVfcGx1cyh0aGVtZW5hbWUpOyB0ZW1wemlwbmFtZSA9ICcnCiAgICAgICAgemlwbmFtZSA9IG9zLnBhdGguam9pbihteWJ1aWxkcywgJyVzLnppcCcgJSB0aGVtZW5hbWUpCiAgICAgICAgdHJ5OgogICAgICAgICAgICB6aXBmID0gemlwZmlsZS5aaXBGaWxlKHhibWMudHJhbnNsYXRlUGF0aCh6aXBuYW1lKSwgbW9kZT0ndycpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB0ZW1wemlwbmFtZSA9IG9zLnBhdGguam9pbihQQUNLQUdFUywgJyVzLnppcCcgJSB0aGVtZW5hbWUpCiAgICAgICAgICAgICAgICB6aXBmID0gemlwZmlsZS5aaXBGaWxlKHRlbXB6aXBuYW1lLCBtb2RlPSd3JykKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgbG9nKCJVbmFibGUgdG8gY3JlYXRlICVzLnppcCIgJSB0aGVtZW5hbWUsIHhibWMuTE9HRVJST1IpCiAgICAgICAgICAgICAgICBpZiBESUFMT0cueWVzbm8oQURET05USVRMRSwgIltDT0xPUiAlc11JbXBvc2libGUgZXNjcmliaXIgZW4gZWwgZGlyZWN0b3JpbyBkZSBiYWNrdXBzLCBxdWllcmVzIHNlbGVjY2lvbmFyIG90cm8/Wy9DT0xPUl0iICUgQ09MT1IyLCB5ZXNsYWJlbD0iW0JdW0NPTE9SIGdyZWVuXUNhbWJpYXIgZGlyZWN0b3Jpb1svQ09MT1JdWy9CXSIsIG5vbGFiZWw9IltCXVtDT0xPUiByZWRdQ2FuY2VsYXJbL0NPTE9SXVsvQl0iKToKICAgICAgICAgICAgICAgICAgICBvcGVuUygpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIGNvbnZlcnRTcGVjaWFsKFVTRVJEQVRBLCBUcnVlKQogICAgICAgIGFzY2lpQ2hlY2soVVNFUkRBVEEsIFRydWUpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3QgU0tJTiA9PSAnc2tpbi5jb25mbHVlbmNlJzoKICAgICAgICAgICAgICAgIHNraW5mb2xkID0gb3MucGF0aC5qb2luKEFERE9OUywgU0tJTiwgJ21lZGlhJykKICAgICAgICAgICAgICAgIG1hdGNoMiA9IGdsb2IuZ2xvYihvcy5wYXRoLmpvaW4oc2tpbmZvbGQsJyoueGJ0JykpCiAgICAgICAgICAgICAgICBpZiBsZW4obWF0Y2gyKSA+IDE6CiAgICAgICAgICAgICAgICAgICAgaWYgRElBTE9HLnllc25vKCdbQ09MT1IgJXNdJXNbL0NPTE9SXVtDT0xPUiAlc106IENvcGlhIGRlIFRlbWFbL0NPTE9SXScgJSAoQ09MT1IxLCBBRERPTlRJVExFLCBDT0xPUjIpLCAiW0NPTE9SICVzXVF1aWVyZXMgaW5jbHVpciBlbCBhcmNoaXZvIFRleHR1cmU/Wy9DT0xPUl0iICUgQ09MT1IyLCAiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgU0tJTiksIHllc2xhYmVsPSJbQl1bQ09MT1IgZ3JlZW5dU2lbL0NPTE9SXVsvQl0iLCBub2xhYmVsPSJbQl1bQ09MT1IgcmVkXUNhbmNlbGFyWy9DT0xPUl1bL0JdIik6CiAgICAgICAgICAgICAgICAgICAgICAgIHNraW5mb2xkID0gb3MucGF0aC5qb2luKEFERE9OUywgU0tJTiwgJ21lZGlhJykKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2gyID0gZ2xvYi5nbG9iKG9zLnBhdGguam9pbihza2luZm9sZCwnKi54YnQnKSkKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHhidCBpbiBtYXRjaDI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBESUFMT0cueWVzbm8oJ1tDT0xPUiAlc10lc1svQ09MT1JdW0NPTE9SICVzXTogQ29waWEgZGUgVGVtYVsvQ09MT1JdJyAlIChDT0xPUjEsIEFERE9OVElUTEUsIENPTE9SMiksICJbQ09MT1IgJXNdUXVpZXJlcyBpbmNsdWlyIGVsIGFyY2hpdm8gVGV4dHVyZSBbQ09MT1IgJXNdJXNbL0NPTE9SXT8iICUgKENPTE9SMSwgQ09MT1IyLCB4YnQucmVwbGFjZShza2luZm9sZCwgIiIpWzE6XSksICJkZXNkZSBbQ09MT1IgJXNdJXNbL0NPTE9SXVsvQ09MT1JdIiAlIChDT0xPUjEsIFNLSU4pLCB5ZXNsYWJlbD0iW0JdW0NPTE9SIGdyZWVuXVNpWy9DT0xPUl1bL0JdIiwgbm9sYWJlbD0iW0JdW0NPTE9SIHJlZF1Ob1svQ09MT1JdWy9CXSIpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuICA9IHhidAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuMiA9IGZuLnJlcGxhY2UoSE9NRSwgIiIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgemlwZi53cml0ZShmbiwgZm4yLCB6aXBmaWxlLlpJUF9ERUZMQVRFRCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgZm9yIHhidCBpbiBtYXRjaDI6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIERJQUxPRy55ZXNubygnW0NPTE9SICVzXSVzWy9DT0xPUl1bQ09MT1IgJXNdOiBDb3BpYSBkZSBUZW1hWy9DT0xPUl0nICUgKENPTE9SMSwgQURET05USVRMRSwgQ09MT1IyKSwgIltDT0xPUiAlc11RdWllcmVzIGluY2x1aXIgZWwgYXJjaGl2byBUZXh0dXJlIFtDT0xPUiAlc10lc1svQ09MT1JdPyIgJSAoQ09MT1IyLCBDT0xPUjEsIHhidC5yZXBsYWNlKHNraW5mb2xkLCAiIilbMTpdKSwgImRlc2RlIFtDT0xPUiAlc10lc1svQ09MT1JdWy9DT0xPUl0iICUgKENPTE9SMSwgU0tJTiksIHllc2xhYmVsPSJbQl1bQ09MT1IgZ3JlZW5dU2lbL0NPTE9SXVsvQl0iLCBub2xhYmVsPSJbQl1bQ09MT1IgcmVkXU5vWy9DT0xPUl1bL0JdIik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbiAgPSB4YnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuMiA9IGZuLnJlcGxhY2UoSE9NRSwgIiIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB6aXBmLndyaXRlKGZuLCBmbjIsIHppcGZpbGUuWklQX0RFRkxBVEVEKQogICAgICAgICAgICAgICAgYWRfc2tpbiA9IG9zLnBhdGguam9pbihBRERPTkQsIFNLSU4sICdzZXR0aW5ncy54bWwnKQogICAgICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoYWRfc2tpbik6CiAgICAgICAgICAgICAgICAgICAgaWYgRElBTE9HLnllc25vKCdbQ09MT1IgJXNdJXNbL0NPTE9SXVtDT0xPUiAlc106IENvcGlhIGRlIFRlbWFbL0NPTE9SXScgJSAoQ09MT1IxLCBBRERPTlRJVExFLCBDT0xPUjIpLCAiW0NPTE9SICVzXVF1aWVyZXMgaW5jbHVpciBlbCBhcmNoaXZvIFtDT0xPUiAlc11zZXR0aW5ncy54bWxbL0NPTE9SXSBlbiBbQ09MT1IgJXNdL2FkZG9uX2RhdGEvWy9DT0xPUl0gcGFyYT8iICUgKENPTE9SMiwgQ09MT1IxLCBDT0xPUjEpLCAiW0NPTE9SICVzXSVzWy9DT0xPUl0iICAlIChDT0xPUjEsIFNLSU4pLCB5ZXNsYWJlbD0iW0JdW0NPTE9SIGdyZWVuXVNpWy9DT0xPUl1bL0JdIiwgbm9sYWJlbD0iW0JdW0NPTE9SIHJlZF1Ob1svQ09MT1JdWy9CXSIpOgogICAgICAgICAgICAgICAgICAgICAgICBza2luZm9sZCA9IG9zLnBhdGguam9pbihBRERPTkQsIFNLSU4pCiAgICAgICAgICAgICAgICAgICAgICAgIHppcGYud3JpdGUoYWRfc2tpbiwgYWRfc2tpbi5yZXBsYWNlKEhPTUUsICIiKSwgemlwZmlsZS5aSVBfREVGTEFURUQpCiAgICAgICAgICAgICAgICBmID0gb3Blbihvcy5wYXRoLmpvaW4oQURET05TLCBTS0lOLCAnYWRkb24ueG1sJykpOyByID0gZi5yZWFkKCk7IGYuY2xvc2UoKQogICAgICAgICAgICAgICAgbWF0Y2ggID0gcGFyc2VET00ociwgJ2ltcG9ydCcsIHJldD0nYWRkb24nKQogICAgICAgICAgICAgICAgaWYgJ3NjcmlwdC5za2luc2hvcnRjdXRzJyBpbiBtYXRjaDoKICAgICAgICAgICAgICAgICAgICBpZiBESUFMT0cueWVzbm8oJ1tDT0xPUiAlc10lc1svQ09MT1JdW0NPTE9SICVzXTogQ29waWEgZGUgVGVtYVsvQ09MT1JdJyAlIChDT0xPUjEsIEFERE9OVElUTEUsIENPTE9SMiksICJbQ09MT1IgJXNdUXVpZXJlcyBpbmNsdWlyIGVsIGFyY2hpdm8gW0NPTE9SICVzXXNldHRpbmdzLnhtbFsvQ09MT1JdIHBhcmEgW0NPTE9SICVzXXNjcmlwdC5za2luc2hvcnRjdXRzWy9DT0xPUl0/IiAlIChDT0xPUjIsIENPTE9SMSwgQ09MT1IxKSwgeWVzbGFiZWw9IltCXVtDT0xPUiBncmVlbl1TaVsvQ09MT1JdWy9CXSIsIG5vbGFiZWw9IltCXVtDT0xPUiByZWRdTm9bL0NPTE9SXVsvQl0iKToKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGJhc2UsIGRpcnMsIGZpbGVzIGluIG9zLndhbGsob3MucGF0aC5qb2luKEFERE9ORCwnc2NyaXB0LnNraW5zaG9ydGN1dHMnKSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlc1s6XSA9IFtmIGZvciBmIGluIGZpbGVzIGlmIGYgbm90IGluIGV4Y2x1ZGVfZmlsZXNdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgZmlsZSBpbiBmaWxlczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbiA9IG9zLnBhdGguam9pbihiYXNlLCBmaWxlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHppcGYud3JpdGUoZm4sIGZuW2xlbihIT01FKTpdLCB6aXBmaWxlLlpJUF9ERUZMQVRFRCkKICAgICAgICAgICAgaWYgRElBTE9HLnllc25vKCdbQ09MT1IgJXNdJXNbL0NPTE9SXVtDT0xPUiAlc106IENvcGlhIGRlIFRlbWFbL0NPTE9SXScgJSAoQ09MT1IxLCBBRERPTlRJVExFLCBDT0xPUjIpLCAiW0NPTE9SICVzXVF1aWVyZXMgaW5jbHVpciBsYSBjYXJwZXRhIFtDT0xPUiAlc11CYWNrZ3JvdW5kc1svQ09MT1JdP1svQ09MT1JdIiAlIChDT0xPUjIsIENPTE9SMSksIHllc2xhYmVsPSJbQl1bQ09MT1IgZ3JlZW5dU2ksIGluY2x1aXJbL0NPTE9SXVsvQl0iLCBub2xhYmVsPSJbQl1bQ09MT1IgcmVkXU5vLCBjb250aW51YXJbL0NPTE9SXVsvQl0iKToKICAgICAgICAgICAgICAgIGZuID0gRElBTE9HLmJyb3dzZSgwLCAnU2VsZWN0IGxvY2F0aW9uIG9mIGJhY2tncm91bmRzJywgJ2ZpbGVzJywgJycsIFRydWUsIEZhbHNlLCBIT01FLCBGYWxzZSkKICAgICAgICAgICAgICAgIGlmIG5vdCBmbiA9PSBIT01FOgogICAgICAgICAgICAgICAgICAgIGZvciBiYXNlLCBkaXJzLCBmaWxlcyBpbiBvcy53YWxrKGZuKToKICAgICAgICAgICAgICAgICAgICAgICAgZGlyc1s6XSA9IFtkIGZvciBkIGluIGRpcnMgaWYgZCBub3QgaW4gZXhjbHVkZV9kaXJzXQogICAgICAgICAgICAgICAgICAgICAgICBmaWxlc1s6XSA9IFtmIGZvciBmIGluIGZpbGVzIGlmIGYgbm90IGluIGV4Y2x1ZGVfZmlsZXNdCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBmaWxlIGluIGZpbGVzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuMiA9IG9zLnBhdGguam9pbihiYXNlLCBmaWxlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHppcGYud3JpdGUoZm4yLCBmbjJbbGVuKEhPTUUpOl0sIHppcGZpbGUuWklQX0RFRkxBVEVEKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiwgZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2coIltCYWNrIFVwXSBUeXBlID0gJyVzJzogVW5hYmxlIHRvIGJhY2t1cCAlcyIgJSAodHlwZSwgZmlsZSksIHhibWMuTE9HTk9USUNFKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZygiQmFja3VwIEVycm9yOiAlcyIgJSBzdHIoZSksIHhibWMuTE9HTk9USUNFKQogICAgICAgICAgICAgICAgdGV4dCA9IGxhdGVzdERCKCdUZXh0dXJlcycpCiAgICAgICAgICAgICAgICBpZiBESUFMT0cueWVzbm8oJ1tDT0xPUiAlc10lc1svQ09MT1JdW0NPTE9SICVzXTogQ29waWEgZGUgVGVtYVsvQ09MT1JdJyAlIChDT0xPUjEsIEFERE9OVElUTEUsIENPTE9SMiksICJbQ09MT1IgJXNdUXVpZXJlcyBpbmNsdWlyIGVsIGFkZG9uIFtDT0xPUiAlc10lc1svQ09MT1JdP1svQ09MT1JdIiAlIChDT0xPUjIsIENPTE9SMSwgdGV4dCksIHllc2xhYmVsPSJbQl1bQ09MT1IgZ3JlZW5dU2lbL0NPTE9SXVsvQl0iLCBub2xhYmVsPSJbQl1bQ09MT1IgcmVkXU5vLCBDb250aW51YXJbL0NPTE9SXVsvQl0iKToKICAgICAgICAgICAgICAgICAgICB6aXBmLndyaXRlKG9zLnBhdGguam9pbihEQVRBQkFTRSwgdGV4dCksICcvdXNlcmRhdGEvRGF0YWJhc2UvJXMnICUgdGV4dCwgemlwZmlsZS5aSVBfREVGTEFURUQpCiAgICAgICAgICAgIGlmIERJQUxPRy55ZXNubygnW0NPTE9SICVzXSVzWy9DT0xPUl1bQ09MT1IgJXNdOiBDb3BpYSBkZSBUZW1hWy9DT0xPUl0nICUgKENPTE9SMSwgQURET05USVRMRSwgQ09MT1IyKSwgIltDT0xPUiAlc11UZSBndXN0YXJpYSBpbmNsdWlyIGFsZ3VuIGFkZG9uIGFsIGJhY2t1cD9bL0NPTE9SXSIgJSAoQ09MT1IyKSwgeWVzbGFiZWw9IltCXVtDT0xPUiBncmVlbl1TaVsvQ09MT1JdWy9CXSIsIG5vbGFiZWw9IltCXVtDT0xPUiByZWRdTm8sIENvbnRpbnVhclsvQ09MT1JdWy9CXSIpOgogICAgICAgICAgICAgICAgZm9sZCA9IGdsb2IuZ2xvYihvcy5wYXRoLmpvaW4oQURET05TLCAnKi8nKSkKICAgICAgICAgICAgICAgIGFkZG9ubmFtZXMgPSBbXTsgYWRkb25mb2xkcyA9IFtdCiAgICAgICAgICAgICAgICBmb3IgZm9sZGVyIGluIHNvcnRlZChmb2xkLCBrZXkgPSBsYW1iZGEgeDogeCk6CiAgICAgICAgICAgICAgICAgICAgZm9sZGVybmFtZSA9IG9zLnBhdGguc3BsaXQoZm9sZGVyWzotMV0pWzFdCiAgICAgICAgICAgICAgICAgICAgaWYgZm9sZGVybmFtZSBpbiBFWENMVURFUzogY29udGludWUKICAgICAgICAgICAgICAgICAgICBlbGlmIGZvbGRlcm5hbWUgaW4gREVGQVVMVFBMVUdJTlM6IGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgZWxpZiBmb2xkZXJuYW1lID09ICdwYWNrYWdlcyc6IGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgeG1sID0gb3MucGF0aC5qb2luKGZvbGRlciwgJ2FkZG9uLnhtbCcpCiAgICAgICAgICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoeG1sKToKICAgICAgICAgICAgICAgICAgICAgICAgZiAgICAgID0gb3Blbih4bWwpCiAgICAgICAgICAgICAgICAgICAgICAgIGEgICAgICA9IGYucmVhZCgpCiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoICA9IHBhcnNlRE9NKGEsICdhZGRvbicsIHJldD0nbmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxlbihtYXRjaCkgPiAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkb25uYW1lcy5hcHBlbmQobWF0Y2hbMF0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRvbmZvbGRzLmFwcGVuZChmb2xkZXJuYW1lKQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkb25uYW1lcy5hcHBlbmQoZm9sZGVybmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZG9uZm9sZHMuYXBwZW5kKGZvbGRlcm5hbWUpCiAgICAgICAgICAgICAgICBpZiBLT0RJViA+IDE2OgogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkID0gRElBTE9HLm11bHRpc2VsZWN0KCIlczogU2VsZWNjaW9uYSBsb3MgYWRkb25zIHF1ZSBxdWllcmFzIGluY2x1aXIgZW4gZWwgYmFja3VwLiIgJSBBRERPTlRJVExFLCBhZGRvbm5hbWVzKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZCA9IFtdOyBjaG9pY2UgPSAwCiAgICAgICAgICAgICAgICAgICAgdGVtcGFkZG9ubmFtZXMgPSBbIi0tIENsaWNrIGFxdWkgcGFyYSBjb250aW51YXIgLS0iXSArIGFkZG9ubmFtZXMKICAgICAgICAgICAgICAgICAgICB3aGlsZSBub3QgY2hvaWNlID09IC0xOgogICAgICAgICAgICAgICAgICAgICAgICBjaG9pY2UgPSBESUFMT0cuc2VsZWN0KCIlczogU2VsZWNjaW9uYSBsb3MgYWRkb25zIHF1ZSBxdWllcmFzIGluY2x1aXIgZW4gZWwgYmFja3VwLiIgJSBBRERPTlRJVExFLCB0ZW1wYWRkb25uYW1lcykKICAgICAgICAgICAgICAgICAgICAgICAgaWYgY2hvaWNlID09IC0xOiBicmVhawogICAgICAgICAgICAgICAgICAgICAgICBlbGlmIGNob2ljZSA9PSAwOiBicmVhawogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOiAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZTIgPSAoY2hvaWNlLTEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBjaG9pY2UyIGluIHNlbGVjdGVkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkLnJlbW92ZShjaG9pY2UyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBhZGRvbm5hbWVzW2Nob2ljZV0gPSBhZGRvbm5hbWVzW2Nob2ljZTJdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkLmFwcGVuZChjaG9pY2UyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBhZGRvbm5hbWVzW2Nob2ljZV0gPSAiW0JdW0NPTE9SICVzXSVzWy9DT0xPUl1bL0JdIiAlIChDT0xPUjEsIGFkZG9ubmFtZXNbY2hvaWNlMl0pCiAgICAgICAgICAgICAgICBpZiBsZW4oc2VsZWN0ZWQpID4gMDoKICAgICAgICAgICAgICAgICAgICBmb3IgaXRlbSBpbiBzZWxlY3RlZDoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGJhc2UsIGRpcnMsIGZpbGVzIGluIG9zLndhbGsob3MucGF0aC5qb2luKEFERE9OUyxhZGRvbmZvbGRzW2l0ZW1dKSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlc1s6XSA9IFtmIGZvciBmIGluIGZpbGVzIGlmIGYgbm90IGluIGV4Y2x1ZGVfZmlsZXNdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgZmlsZSBpbiBmaWxlczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBmaWxlLmVuZHN3aXRoKCcucHlvJyk6IGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4gPSBvcy5wYXRoLmpvaW4oYmFzZSwgZmlsZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB6aXBmLndyaXRlKGZuLCBmbltsZW4oSE9NRSk6XSwgemlwZmlsZS5aSVBfREVGTEFURUQpCiAgICAgICAgICAgIGlmIERJQUxPRy55ZXNubygnW0NPTE9SICVzXSVzWy9DT0xPUl1bQ09MT1IgJXNdOiBDb3BpYSBkZSBUZW1hWy9DT0xPUl0nICUgKENPTE9SMSwgQURET05USVRMRSwgQ09MT1IyKSwgIltDT0xPUiAlc11RdWllcmVzIGluY2x1aXIgZWwgYXJjaGl2byBbQ09MT1IgJXNdZ3Vpc2V0dGluZ3MueG1sWy9DT0xPUl0/Wy9DT0xPUl0iICUgKENPTE9SMiwgQ09MT1IxKSwgeWVzbGFiZWw9IltCXVtDT0xPUiBncmVlbl1TaVsvQ09MT1JdWy9CXSIsIG5vbGFiZWw9IltCXVtDT0xPUiByZWRdTm8sIENvbnRpbnVhclsvQ09MT1JdWy9CXSIpOgogICAgICAgICAgICAgICAgemlwZi53cml0ZShHVUlTRVRUSU5HUywgJy91c2VyZGF0YS9ndWlzZXR0aW5ncy54bWwnLCB6aXBmaWxlLlpJUF9ERUZMQVRFRCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uLCBlOgogICAgICAgICAgICB6aXBmLmNsb3NlKCkKICAgICAgICAgICAgbG9nKCJbQmFjayBVcF0gVHlwZSA9ICclcyc6ICVzIiAlICh0eXBlLCBzdHIoZSkpLCB4Ym1jLkxPR05PVElDRSkKICAgICAgICAgICAgRElBTE9HLm9rKEFERE9OVElUTEUsICJbQ09MT1IgJXNdJXNbL0NPTE9SXVtDT0xPUiAlc10gaGEgZmFsbGFkbyBsYSBjcmVhY2lvbiBkZWwgYXJjaGl2byB6aXAgZGVsIHRlbWE6Wy9DT0xPUl0iICUgKENPTE9SMSwgdGhlbWVuYW1lLCBDT0xPUjIpLCAiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgc3RyKGUpKSkKICAgICAgICAgICAgaWYgbm90IHRlbXB6aXBuYW1lID09ICcnOgogICAgICAgICAgICAgICAgdHJ5OiBvcy5yZW1vdmUoeGJtYy50cmFuc2xhdGVQYXRoKHRlbXB6aXBuYW1lKSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24sIGU6IGxvZyhzdHIoZSkpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB0cnk6IG9zLnJlbW92ZSh4Ym1jLnRyYW5zbGF0ZVBhdGgoemlwbmFtZSkpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uLCBlOiBsb2coc3RyKGUpKQogICAgICAgICAgICByZXR1cm4KICAgICAgICB6aXBmLmNsb3NlKCkKICAgICAgICBpZiBub3QgdGVtcHppcG5hbWUgPT0gJyc6CiAgICAgICAgICAgIHN1Y2Nlc3MgPSB4Ym1jdmZzLnJlbmFtZSh0ZW1wemlwbmFtZSwgemlwbmFtZSkKICAgICAgICAgICAgaWYgc3VjY2VzcyA9PSAwOgogICAgICAgICAgICAgICAgeGJtY3Zmcy5jb3B5KHRlbXB6aXBuYW1lLCB6aXBuYW1lKQogICAgICAgICAgICAgICAgeGJtY3Zmcy5kZWxldGUodGVtcHppcG5hbWUpCiAgICAgICAgRElBTE9HLm9rKEFERE9OVElUTEUsICJbQ09MT1IgJXNdJXNbL0NPTE9SXVtDT0xPUiAlc10gc2UgaGEgY3JlcmFkbyBjb24gZXhpdG8gZWwgYXJjaGl2byB6aXAgZGVsIHRlbWE6Wy9DT0xPUl0iICUgKENPTE9SMSwgdGhlbWVuYW1lLCBDT0xPUjIpLCAiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgemlwbmFtZSkpCiAgICBlbGlmIHR5cGUgPT0gImFkZG9uZGF0YSI6CiAgICAgICAgaWYgRElBTE9HLnllc25vKEFERE9OVElUTEUsICJbQ09MT1IgJXNdUXVpZXJlcyBpbmNsdWlyIGxvcyBkYXRvcyBkZWwgYWRkb24sIGVzIGRlY2lyLCBsYSBjYXJwZXRhIGFkZG9uX2RhdGE/Wy9DT0xPUl0iICUgQ09MT1IyLCBub2xhYmVsPSJbQl1bQ09MT1IgcmVkXUNhbmNlbGFyWy9DT0xPUl1bL0JdIiwgeWVzbGFiZWw9IltCXVtDT0xPUiBncmVlbl1TaSwgaW5jbHVpciBBZGRvbl9EYXRhWy9DT0xPUl1bL0JdIik6CiAgICAgICAgICAgIGlmIG5hbWUgPT0gIiI6CiAgICAgICAgICAgICAgICBuYW1lID0gZ2V0S2V5Ym9hcmQoIiIsIlBvciBmYXZvciwgaW50cm9kdXpjYSBlbCBub21icmUgcGFyYSAlcyB6aXAiICUgdHlwZSkKICAgICAgICAgICAgICAgIGlmIG5vdCBuYW1lOiByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIG5hbWUgPSB1cmxsaWIucXVvdGVfcGx1cyhuYW1lKQogICAgICAgICAgICBuYW1lID0gJyVzX2FkZG9uZGF0YS56aXAnICUgbmFtZTsgdGVtcHppcG5hbWUgPSAnJwogICAgICAgICAgICB6aXBuYW1lID0gb3MucGF0aC5qb2luKG15YnVpbGRzLCBuYW1lKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB6aXBmID0gemlwZmlsZS5aaXBGaWxlKHhibWMudHJhbnNsYXRlUGF0aCh6aXBuYW1lKSwgbW9kZT0ndycpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB0ZW1wemlwbmFtZSA9IG9zLnBhdGguam9pbihQQUNLQUdFUywgJyVzLnppcCcgJSBuYW1lKQogICAgICAgICAgICAgICAgICAgIHppcGYgPSB6aXBmaWxlLlppcEZpbGUodGVtcHppcG5hbWUsIG1vZGU9J3cnKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIGxvZygiVW5hYmxlIHRvIGNyZWF0ZSAlc19hZGRvbmRhdGEuemlwIiAlIG5hbWUsIHhibWMuTE9HRVJST1IpCiAgICAgICAgICAgICAgICAgICAgaWYgRElBTE9HLnllc25vKEFERE9OVElUTEUsICJbQ09MT1IgJXNdSW1wb3NpYmxlIGVzY3JpYmlyIGVuIGVsIGRpcmVjdG9yaW8gZGUgYmFja3VwcywgcXVpZXJlcyBzZWxlY2Npb25hciBvdHJvP1svQ09MT1JdIiAlIENPTE9SMiwgeWVzbGFiZWw9IltCXVtDT0xPUiBncmVlbl1DYW1iaWFyIERpcmVjdG9yaW9bL0NPTE9SXVsvQl0iLCBub2xhYmVsPSJbQl1bQ09MT1IgcmVkXUNhbmNlbGFyWy9DT0xPUl1bL0JdIik6CiAgICAgICAgICAgICAgICAgICAgICAgIG9wZW5TKCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIGZvcl9wcm9ncmVzcyAgPSAwCiAgICAgICAgICAgIElURU0gICAgICAgICAgPSBbXQogICAgICAgICAgICBjb252ZXJ0U3BlY2lhbChBRERPTkQsIFRydWUpCiAgICAgICAgICAgIGFzY2lpQ2hlY2soQURET05ELCBUcnVlKQogICAgICAgICAgICBEUC5jcmVhdGUoIltDT0xPUiAlc10lc1svQ09MT1JdW0NPTE9SICVzXTogQ3JlYW5kbyB6aXBbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFLENPTE9SMiksICJbQ09MT1IgJXNdQ3JlYW5kbyB6aXAiICUgQ09MT1IyLCAiIiwgIlBvciBmYXZvciwgZXNwZXJhLi4uWy9DT0xPUl0iKQogICAgICAgICAgICBmb3IgYmFzZSwgZGlycywgZmlsZXMgaW4gb3Mud2FsayhBRERPTkQpOgogICAgICAgICAgICAgICAgZGlyc1s6XSA9IFtkIGZvciBkIGluIGRpcnMgaWYgZCBub3QgaW4gZXhjbHVkZV9kaXJzXQogICAgICAgICAgICAgICAgZmlsZXNbOl0gPSBbZiBmb3IgZiBpbiBmaWxlcyBpZiBmIG5vdCBpbiBleGNsdWRlX2ZpbGVzXQogICAgICAgICAgICAgICAgZm9yIGZpbGUgaW4gZmlsZXM6CiAgICAgICAgICAgICAgICAgICAgSVRFTS5hcHBlbmQoZmlsZSkKICAgICAgICAgICAgTl9JVEVNID0gbGVuKElURU0pCiAgICAgICAgICAgIGZvciBiYXNlLCBkaXJzLCBmaWxlcyBpbiBvcy53YWxrKEFERE9ORCk6CiAgICAgICAgICAgICAgICBkaXJzWzpdID0gW2QgZm9yIGQgaW4gZGlycyBpZiBkIG5vdCBpbiBleGNsdWRlX2RpcnNdCiAgICAgICAgICAgICAgICBmaWxlc1s6XSA9IFtmIGZvciBmIGluIGZpbGVzIGlmIGYgbm90IGluIGV4Y2x1ZGVfZmlsZXNdCiAgICAgICAgICAgICAgICBmb3IgZmlsZSBpbiBmaWxlczoKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcl9wcm9ncmVzcyArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzID0gcGVyY2VudGFnZShmb3JfcHJvZ3Jlc3MsIE5fSVRFTSkgCiAgICAgICAgICAgICAgICAgICAgICAgIERQLnVwZGF0ZShpbnQocHJvZ3Jlc3MpLCAnW0NPTE9SICVzXUNyZWFuZG8gemlwOiBbQ09MT1Ilc10lc1svQ09MT1JdIC8gW0NPTE9SJXNdJXNbL0NPTE9SXScgJSAoQ09MT1IyLCBDT0xPUjEsIGZvcl9wcm9ncmVzcywgQ09MT1IxLCBOX0lURU0pLCAnW0NPTE9SICVzXSVzWy9DT0xPUl0nICUgKENPTE9SMSwgZmlsZSksICcnKQogICAgICAgICAgICAgICAgICAgICAgICBmbiA9IG9zLnBhdGguam9pbihiYXNlLCBmaWxlKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBmaWxlIGluIExPR0ZJTEVTOiBsb2coIltCYWNrIFVwXSBUeXBlID0gJyVzJzogSWdub3JlICVzIiAlICh0eXBlLCBmaWxlKSwgeGJtYy5MT0dOT1RJQ0UpOyBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICAgICBlbGlmIG9zLnBhdGguam9pbihiYXNlLCBmaWxlKSBpbiBiYWRfZmlsZXM6IGxvZygiW0JhY2sgVXBdIFR5cGUgPSAnJXMnOiBJZ25vcmUgJXMiICUgKHR5cGUsIGZpbGUpLCB4Ym1jLkxPR05PVElDRSk7IGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgb3MucGF0aC5qb2luKCdhZGRvbnMnLCAncGFja2FnZXMnKSBpbiBmbjogbG9nKCJbQmFjayBVcF0gVHlwZSA9ICclcyc6IElnbm9yZSAlcyIgJSAodHlwZSwgZmlsZSksIHhibWMuTE9HTk9USUNFKTsgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiBmaWxlLmVuZHN3aXRoKCcuY3N2Jyk6IGxvZygiW0JhY2sgVXBdIFR5cGUgPSAnJXMnOiBJZ25vcmUgJXMiICUgKHR5cGUsIGZpbGUpLCB4Ym1jLkxPR05PVElDRSk7IGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgZmlsZS5lbmRzd2l0aCgnLmRiJykgYW5kICdEYXRhYmFzZScgaW4gYmFzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXAgPSBmaWxlLnJlcGxhY2UoJy5kYicsICcnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcCA9ICcnLmpvaW4oW2kgZm9yIGkgaW4gdGVtcCBpZiBub3QgaS5pc2RpZ2l0KCldKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdGVtcCBpbiBbJ0FkZG9ucycsICdBRFNQJywgJ0VwZycsICdNeU11c2ljJywgJ015VmlkZW9zJywgJ1RleHR1cmVzJywgJ1RWJywgJ1ZpZXdNb2RlcyddOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBmaWxlID09IGxhdGVzdERCKHRlbXApOiAgbG9nKCJbQmFjayBVcF0gVHlwZSA9ICclcyc6IElnbm9yZSAlcyIgJSAodHlwZSwgZmlsZSksIHhibWMuTE9HTk9USUNFKTsgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgemlwZi53cml0ZShmbiwgZm5bbGVuKEFERE9ORCk6XSwgemlwZmlsZS5aSVBfREVGTEFURUQpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24sIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2coIltCYWNrIFVwXSBUeXBlID0gJyVzJzogVW5hYmxlIHRvIGJhY2t1cCAlcyIgJSAodHlwZSwgZmlsZSksIHhibWMuTE9HTk9USUNFKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nKCJCYWNrdXAgRXJyb3I6ICVzIiAlIHN0cihlKSwgeGJtYy5MT0dOT1RJQ0UpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiwgZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nKCJbQmFjayBVcF0gVHlwZSA9ICclcyc6IFVuYWJsZSB0byBiYWNrdXAgJXMiICUgKHR5cGUsIGZpbGUpLCB4Ym1jLkxPR05PVElDRSkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nKCJCYWNrdXAgRXJyb3I6ICVzIiAlIHN0cihlKSwgeGJtYy5MT0dOT1RJQ0UpCiAgICAgICAgICAgIHppcGYuY2xvc2UoKQogICAgICAgICAgICBpZiBub3QgdGVtcHppcG5hbWUgPT0gJyc6CiAgICAgICAgICAgICAgICBzdWNjZXNzID0geGJtY3Zmcy5yZW5hbWUodGVtcHppcG5hbWUsIHppcG5hbWUpCiAgICAgICAgICAgICAgICBpZiBzdWNjZXNzID09IDA6CiAgICAgICAgICAgICAgICAgICAgeGJtY3Zmcy5jb3B5KHRlbXB6aXBuYW1lLCB6aXBuYW1lKQogICAgICAgICAgICAgICAgICAgIHhibWN2ZnMuZGVsZXRlKHRlbXB6aXBuYW1lKQogICAgICAgICAgICBEUC5jbG9zZSgpCiAgICAgICAgICAgIERJQUxPRy5vayhBRERPTlRJVExFLCAiW0NPTE9SICVzXSVzWy9DT0xPUl0gW0NPTE9SICVzXUNvcGlhIGNyZWFkYSBjb24gZXhpdG86Wy9DT0xPUl0iICUgKENPTE9SMSwgbmFtZSwgQ09MT1IyKSwgIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIHppcG5hbWUpKQoKZGVmIHJlc3RvcmVMb2NhbCh0eXBlKToKICAgIGJhY2t1cCAgID0geGJtYy50cmFuc2xhdGVQYXRoKEJBQ0tVUExPQ0FUSU9OKQogICAgbXlidWlsZHMgPSB4Ym1jLnRyYW5zbGF0ZVBhdGgoTVlCVUlMRFMpCiAgICB0cnk6CiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGJhY2t1cCk6IHhibWN2ZnMubWtkaXJzKGJhY2t1cCkKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMobXlidWlsZHMpOiB4Ym1jdmZzLm1rZGlycyhteWJ1aWxkcykKICAgIGV4Y2VwdCBFeGNlcHRpb24sIGU6CiAgICAgICAgRElBTE9HLm9rKEFERE9OVElUTEUsICJbQ09MT1IgJXNdRXJyb3IgY3JlYW5kbyBkaXJlY3RvcmlvIHBhcmEgQmFja3VwOlsvQ09MT1JdIiAlIChDT0xPUjIpLCAiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgc3RyKGUpKSkKICAgICAgICByZXR1cm4KICAgIGZpbGUgPSBESUFMT0cuYnJvd3NlKDEsICdbQ09MT1IgJXNdU2VsZWNjaW9uYSBlbCBCYWNrdXAgcXVlIHF1aWVyZXMgcmVzdGF1cmFyWy9DT0xPUl0nICUgQ09MT1IyLCAnZmlsZXMnLCAnLnppcCcsIEZhbHNlLCBGYWxzZSwgbXlidWlsZHMpCiAgICBsb2coIltSRVNUT1JFIEJBQ0tVUCAlc10gRmlsZTogJXMgIiAlICh0eXBlLnVwcGVyKCksIGZpbGUpLCB4Ym1jLkxPR05PVElDRSkKICAgIGlmIGZpbGUgPT0gIiIgb3Igbm90IGZpbGUuZW5kc3dpdGgoJy56aXAnKToKICAgICAgICBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCAiW0NPTE9SICVzXVJlc3RhdXJhY2lvbiBsb2NhbDogQ2FuY2VsYWRhWy9DT0xPUl0iICUgQ09MT1IyKQogICAgICAgIHJldHVybgogICAgRFAuY3JlYXRlKEFERE9OVElUTEUsJ1tDT0xPUiAlc11SZXN0YXVyYW5kbyBCYWNrdXAgbG9jYWwnICUgQ09MT1IyLCcnLCAnUG9yIGZhdm9yLCBlc3BlcmVbL0NPTE9SXScpCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoVVNFUkRBVEEpOiBvcy5tYWtlZGlycyhVU0VSREFUQSkKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhBRERPTkQpOiBvcy5tYWtlZGlycyhBRERPTkQpCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoUEFDS0FHRVMpOiBvcy5tYWtlZGlycyhQQUNLQUdFUykKICAgIGlmIHR5cGUgPT0gImd1aSI6IGxvYyA9IFVTRVJEQVRBCiAgICBlbGlmIHR5cGUgPT0gImFkZG9uZGF0YSI6IAogICAgICAgIGxvYyA9IEFERE9ORAogICAgZWxzZSA6IGxvYyA9IEhPTUUKICAgIGxvZygiUmVzdG9yaW5nIHRvICVzIiAlIGxvYywgeGJtYy5MT0dOT1RJQ0UpCiAgICBkaXNwbGF5ID0gb3MucGF0aC5zcGxpdChmaWxlKQogICAgZm4gPSBkaXNwbGF5WzFdCiAgICB0cnk6CiAgICAgICAgemlwZmlsZS5aaXBGaWxlKGZpbGUsICAncicpCiAgICBleGNlcHQ6CiAgICAgICAgRFAudXBkYXRlKDAsICdbQ09MT1IgJXNdSW1wb3NpYmxlIGxlZXIgZWwgemlwIHNlbGVjY2lvbmFkby4nICUgQ09MT1IyLCAnQ29waWFuZG8gYXJjaGl2b3MgYSBQYXF1ZXRlcycpCiAgICAgICAgcGFjayA9IG9zLnBhdGguam9pbignc3BlY2lhbDovL2hvbWUnLCAnYWRkb25zJywgJ3BhY2thZ2VzJywgZm4pCiAgICAgICAgeGJtY3Zmcy5jb3B5KGZpbGUsIHBhY2spCiAgICAgICAgZmlsZSA9IHhibWMudHJhbnNsYXRlUGF0aChwYWNrKQogICAgICAgIERQLnVwZGF0ZSgwLCAnJywgJ0NvcGlhbmRvIGFyY2hpdm9zIGEgUGFxdWV0ZXM6IENvbXBsZXRhZG8nKQogICAgICAgIHppcGZpbGUuWmlwRmlsZShmaWxlLCAncicpCiAgICBwZXJjZW50LCBlcnJvcnMsIGVycm9yID0gZXh0cmFjdC5hbGwoZmlsZSxsb2MsRFApCiAgICBmaXhtZXRhcygpCiAgICBjbGVhclMoJ2J1aWxkJykKICAgIERQLmNsb3NlKCkKICAgIGRlZmF1bHRTa2luKCkKICAgIGxvb2thbmRGZWVsRGF0YSgnc2F2ZScpCiAgICBpZiBub3QgZmlsZS5maW5kKCdwYWNrYWdlcycpID09IC0xOgogICAgICAgIHRyeTogb3MucmVtb3ZlKGZpbGUpCiAgICAgICAgZXhjZXB0OiBwYXNzCiAgICBpZiBpbnQoZXJyb3JzKSA+PSAxOgogICAgICAgIHllcz1ESUFMT0cueWVzbm8oQURET05USVRMRSwgJ1tDT0xPUiAlc11bQ09MT1IgJXNdJXNbL0NPTE9SXScgJSAoQ09MT1IyLCBDT0xPUjEsIGZuKSwgJ0NvbXBsZXRhZG86IFtDT0xPUiAlc10lcyVzWy9DT0xPUl0gW0Vycm9yZXM6W0NPTE9SICVzXSVzWy9DT0xPUl1dJyAlIChDT0xPUjEsIHBlcmNlbnQsICclJywgQ09MT1IxLCBlcnJvcnMpLCAnUXVpZXJlcyB2ZXIgbG9zIGVycm9yZXM/Wy9DT0xPUl0nLCBub2xhYmVsPSdbQl1bQ09MT1IgcmVkXU5vWy9DT0xPUl1bL0JdJyx5ZXNsYWJlbD0nW0JdW0NPTE9SIGdyZWVuXVZlciBlcnJvcmVzWy9CXScpCiAgICAgICAgaWYgeWVzOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGVycm9ycywgdW5pY29kZSk6CiAgICAgICAgICAgICAgICBlcnJvciA9IGVycm9yLmVuY29kZSgndXRmLTgnKQogICAgICAgICAgICBUZXh0Qm94KEFERE9OVElUTEUsIGVycm9yLnJlcGxhY2UoJ1x0JywnJykpCiAgICBzZXRTKCdpbnN0YWxsZWQnLCAndHJ1ZScpCiAgICBzZXRTKCdleHRyYWN0Jywgc3RyKHBlcmNlbnQpKQogICAgc2V0UygnZXJyb3JzJywgc3RyKGVycm9ycykpCiAgICBpZiBJTlNUQUxMTUVUSE9EID09IDE6IHRvZG8gPSAxCiAgICBlbGlmIElOU1RBTExNRVRIT0QgPT0gMjogdG9kbyA9IDAKICAgIGVsc2U6IHRvZG8gPSBESUFMT0cueWVzbm8oQURET05USVRMRSwgIltDT0xPUiAlc11RdWllcmVzIFtDT0xPUiAlc11Gb3J6YXIgZWwgY2llcnJlWy9DT0xPUl0gZGUga29kaSBvIFtDT0xPUiAlc11SZWNhcmdhciBQZXJmaWwgYWN0dWFsWy9DT0xPUl0/Wy9DT0xPUl0iICUgKENPTE9SMiwgQ09MT1IxLCBDT0xPUjEpLCB5ZXNsYWJlbD0iW0JdW0NPTE9SIHJlZF1SZWNhcmdhciBwZXJmaWxbL0NPTE9SXVsvQl0iLCBub2xhYmVsPSJbQl1bQ09MT1IgZ3JlZW5dRm9yemFyIGNpZXJyZVsvQ09MT1JdWy9CXSIpCiAgICBpZiB0b2RvID09IDE6IHJlbG9hZEZpeCgpCiAgICBlbHNlOiBraWxseGJtYyhUcnVlKQoKZGVmIHJlc3RvcmVFeHRlcm5hbCh0eXBlKToKICAgIHNvdXJjZSA9IERJQUxPRy5icm93c2UoMSwgJ1tDT0xPUiAlc11TZWxlY2Npb25hIGVsIEJhY2t1cCBxdWUgcXVpZXJlcyByZXN0YXVyYXJbL0NPTE9SXScgJSBDT0xPUjIsICdmaWxlcycsICcuemlwJywgRmFsc2UsIEZhbHNlKQogICAgaWYgc291cmNlID09ICIiIG9yIG5vdCBzb3VyY2UuZW5kc3dpdGgoJy56aXAnKToKICAgICAgICBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCAiW0NPTE9SICVzXVJlc3RhdXJhY2lvbiBlbiBsYSBudWJlOiBDYW5jZWxhZGFbL0NPTE9SXSIgJSBDT0xPUjIpCiAgICAgICAgcmV0dXJuCiAgICBpZiBub3Qgc291cmNlLnN0YXJ0c3dpdGgoJ2h0dHAnKToKICAgICAgICBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCAiW0NPTE9SICVzXVJlc3RhdXJhY2lvbiBlbiBsYSBudWJlOiBVUkwgbm8gdmFsaWRhWy9DT0xPUl0iICUgQ09MT1IyKQogICAgICAgIHJldHVybgogICAgdHJ5OiAKICAgICAgICB3b3JrID0gd29ya2luZ1VSTChzb3VyY2UpCiAgICBleGNlcHQ6CiAgICAgICAgTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgIltDT0xPUiAlc11SZXN0YXVyYWNpb24gZW4gbGEgbnViZTogVVJMIG5vIHZhbGlkYVsvQ09MT1JdIiAlIENPTE9SMikKICAgICAgICBsb2coIk5vdCBhIHdvcmtpbmcgdXJsLCBpZiBzb3VyY2Ugd2FzIGxvY2FsIHRoZW4gdXNlIGxvY2FsIHJlc3RvcmUgb3B0aW9uIiwgeGJtYy5MT0dOT1RJQ0UpCiAgICAgICAgbG9nKCJFeHRlcm5hbCBTb3VyY2U6ICVzIiAlIHNvdXJjZSwgeGJtYy5MT0dOT1RJQ0UpCiAgICAgICAgcmV0dXJuCiAgICBsb2coIltSRVNUT1JFIEVYVCBCQUNLVVAgJXNdIEZpbGU6ICVzICIgJSAodHlwZS51cHBlcigpLCBzb3VyY2UpLCB4Ym1jLkxPR05PVElDRSkKICAgIHppcGl0ID0gb3MucGF0aC5zcGxpdChzb3VyY2UpOyB6bmFtZSA9IHppcGl0WzFdCiAgICBEUC5jcmVhdGUoQURET05USVRMRSwnW0NPTE9SICVzXURlc2NhcmdhbmRvIGFyY2hpdm8gemlwJyAlIENPTE9SMiwnJywgJ1BvciBmYXZvciwgZXNwZXJlWy9DT0xPUl0nKQogICAgaWYgdHlwZSA9PSAiZ3VpIjogbG9jID0gVVNFUkRBVEEKICAgIGVsaWYgdHlwZSA9PSAiYWRkb25kYXRhIjogbG9jID0gQURET05ECiAgICBlbHNlIDogbG9jID0gSE9NRQogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKFVTRVJEQVRBKTogb3MubWFrZWRpcnMoVVNFUkRBVEEpCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoQURET05EKTogb3MubWFrZWRpcnMoQURET05EKQogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKFBBQ0tBR0VTKTogb3MubWFrZWRpcnMoUEFDS0FHRVMpCiAgICBmaWxlID0gb3MucGF0aC5qb2luKFBBQ0tBR0VTLCB6bmFtZSkKICAgIGRvd25sb2FkZXIuZG93bmxvYWQoc291cmNlLCBmaWxlLCBEUCkKICAgIERQLnVwZGF0ZSgwLCdJbnN0YWxsaW5nIEJhY2t1cCBkZSBsYSBudWJlJywnJywgJ1BvciBmYXZvciwgZXNwZXJlJykKICAgIHBlcmNlbnQsIGVycm9ycywgZXJyb3IgPSBleHRyYWN0LmFsbChmaWxlLGxvYyxEUCkKICAgIGZpeG1ldGFzKCkKICAgIGNsZWFyUygnYnVpbGQnKQogICAgRFAuY2xvc2UoKQogICAgZGVmYXVsdFNraW4oKQogICAgbG9va2FuZEZlZWxEYXRhKCdzYXZlJykKICAgIGlmIGludChlcnJvcnMpID49IDE6CiAgICAgICAgeWVzPURJQUxPRy55ZXNubyhBRERPTlRJVExFLCAnW0NPTE9SICVzXVtDT0xPUiAlc10lc1svQ09MT1JdJyAlIChDT0xPUjIsIENPTE9SMSwgem5hbWUpLCAnQ29tcGxldGFkbzogW0NPTE9SICVzXSVzJXNbL0NPTE9SXSBbRXJyb3JlczpbQ09MT1IgJXNdJXNbL0NPTE9SXV0nICUgKENPTE9SMSwgcGVyY2VudCwgJyUnLCBDT0xPUjEsIGVycm9ycyksICdRdWllcmVzIHZlciBsb3MgZXJyb3Jlcz9bL0NPTE9SXScsIG5vbGFiZWw9J1tCXVtDT0xPUiByZWRdTm9bL0NPTE9SXVsvQl0nLHllc2xhYmVsPSdbQl1bQ09MT1IgZ3JlZW5dVmVyIGVycm9yZXNbL0NPTE9SXVsvQl0nKQogICAgICAgIGlmIHllczoKICAgICAgICAgICAgVGV4dEJveChBRERPTlRJVExFLCBlcnJvci5yZXBsYWNlKCdcdCcsJycpKQogICAgc2V0UygnaW5zdGFsbGVkJywgJ3RydWUnKQogICAgc2V0UygnZXh0cmFjdCcsIHN0cihwZXJjZW50KSkKICAgIHNldFMoJ2Vycm9ycycsIHN0cihlcnJvcnMpKQogICAgdHJ5OiBvcy5yZW1vdmUoZmlsZSkKICAgIGV4Y2VwdDogcGFzcwogICAgaWYgSU5TVEFMTE1FVEhPRCA9PSAxOiB0b2RvID0gMQogICAgZWxpZiBJTlNUQUxMTUVUSE9EID09IDI6IHRvZG8gPSAwCiAgICBlbHNlOiB0b2RvID0gRElBTE9HLnllc25vKEFERE9OVElUTEUsICJbQ09MT1IgJXNdUXVpZXJlcyBbQ09MT1IgJXNdRm9yemFyIGVsIGNpZXJyZVsvQ09MT1JdIGRlIGtvZGkgbyBbQ09MT1IgJXNdUmVjYXJnYXIgUGVyZmlsWy9DT0xPUl0/Wy9DT0xPUl0iICUgKENPTE9SMiwgQ09MT1IxLCBDT0xPUjEpLCB5ZXNsYWJlbD0iW0JdW0NPTE9SIHJlZF1SZWNhcmdhciBQZXJmaWxbL0NPTE9SXVsvQl0iLCBub2xhYmVsPSJbQl1bQ09MT1IgZ3JlZW5dRm9yemFyIGNpZXJyZVsvQ09MT1JdWy9CXSIpCiAgICBpZiB0b2RvID09IDE6IHJlbG9hZEZpeCgpCiAgICBlbHNlOiBraWxseGJtYyhUcnVlKQoKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyNERVRFUk1JTkFSIFBMQVRGT1JNQSMjIyMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCmRlZiBwbGF0Zm9ybSgpOgogICAgaWYgeGJtYy5nZXRDb25kVmlzaWJpbGl0eSgnc3lzdGVtLnBsYXRmb3JtLmFuZHJvaWQnKTogICAgICAgICAgICAgcmV0dXJuICdhbmRyb2lkJwogICAgZWxpZiB4Ym1jLmdldENvbmRWaXNpYmlsaXR5KCdzeXN0ZW0ucGxhdGZvcm0ubGludXgnKTogICAgICAgICAgICAgcmV0dXJuICdsaW51eCcKICAgIGVsaWYgeGJtYy5nZXRDb25kVmlzaWJpbGl0eSgnc3lzdGVtLnBsYXRmb3JtLmxpbnV4LlJhc3BiZXJyeXBpJyk6IHJldHVybiAnbGludXgnCiAgICBlbGlmIHhibWMuZ2V0Q29uZFZpc2liaWxpdHkoJ3N5c3RlbS5wbGF0Zm9ybS53aW5kb3dzJyk6ICAgICAgICAgICByZXR1cm4gJ3dpbmRvd3MnCiAgICBlbGlmIHhibWMuZ2V0Q29uZFZpc2liaWxpdHkoJ3N5c3RlbS5wbGF0Zm9ybS5vc3gnKTogICAgICAgICAgICAgICByZXR1cm4gJ29zeCcKICAgIGVsaWYgeGJtYy5nZXRDb25kVmlzaWJpbGl0eSgnc3lzdGVtLnBsYXRmb3JtLmF0djInKTogICAgICAgICAgICAgIHJldHVybiAnYXR2MicKICAgIGVsaWYgeGJtYy5nZXRDb25kVmlzaWJpbGl0eSgnc3lzdGVtLnBsYXRmb3JtLmlvcycpOiAgICAgICAgICAgICAgIHJldHVybiAnaW9zJwogICAgZWxpZiB4Ym1jLmdldENvbmRWaXNpYmlsaXR5KCdzeXN0ZW0ucGxhdGZvcm0uZGFyd2luJyk6ICAgICAgICAgICAgcmV0dXJuICdpb3MnCgpkZWYgR3JhYl9Mb2coZmlsZT1GYWxzZSwgb2xkPUZhbHNlLCB3aXphcmQ9RmFsc2UpOgogICAgaWYgd2l6YXJkID09IFRydWU6CiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKFdJWkxPRyk6IHJldHVybiBGYWxzZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIGZpbGUgPT0gVHJ1ZToKICAgICAgICAgICAgICAgIHJldHVybiBXSVpMT0cKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGZpbGVuYW1lICAgID0gb3BlbihXSVpMT0csICdyJykKICAgICAgICAgICAgICAgIGxvZ3RleHQgICAgID0gZmlsZW5hbWUucmVhZCgpCiAgICAgICAgICAgICAgICBmaWxlbmFtZS5jbG9zZSgpCiAgICAgICAgICAgICAgICByZXR1cm4gbG9ndGV4dAogICAgZmluYWxmaWxlICAgPSAwCiAgICBsb2dmaWxlcGF0aCA9IG9zLmxpc3RkaXIoTE9HKQogICAgbG9nc2ZvdW5kICAgPSBbXQoKICAgIGZvciBpdGVtIGluIGxvZ2ZpbGVwYXRoOgogICAgICAgIGlmIG9sZCA9PSBUcnVlIGFuZCBpdGVtLmVuZHN3aXRoKCcub2xkLmxvZycpOiBsb2dzZm91bmQuYXBwZW5kKG9zLnBhdGguam9pbihMT0csIGl0ZW0pKQogICAgICAgIGVsaWYgb2xkID09IEZhbHNlIGFuZCBpdGVtLmVuZHN3aXRoKCcubG9nJykgYW5kIG5vdCBpdGVtLmVuZHN3aXRoKCcub2xkLmxvZycpOiBsb2dzZm91bmQuYXBwZW5kKG9zLnBhdGguam9pbihMT0csIGl0ZW0pKQoKICAgIGlmIGxlbihsb2dzZm91bmQpID4gMDoKICAgICAgICBsb2dzZm91bmQuc29ydChrZXk9bGFtYmRhIGY6IG9zLnBhdGguZ2V0bXRpbWUoZikpCiAgICAgICAgaWYgZmlsZSA9PSBUcnVlOiByZXR1cm4gbG9nc2ZvdW5kWy0xXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGZpbGVuYW1lICAgID0gb3Blbihsb2dzZm91bmRbLTFdLCAncicpCiAgICAgICAgICAgIGxvZ3RleHQgICAgID0gZmlsZW5hbWUucmVhZCgpCiAgICAgICAgICAgIGZpbGVuYW1lLmNsb3NlKCkKICAgICAgICAgICAgcmV0dXJuIGxvZ3RleHQKICAgIGVsc2U6IAogICAgICAgIHJldHVybiBGYWxzZQoKZGVmIHdoaXRlTGlzdChkbyk6CiAgICBiYWNrdXAgICA9IHhibWMudHJhbnNsYXRlUGF0aChCQUNLVVBMT0NBVElPTikKICAgIG15YnVpbGRzID0geGJtYy50cmFuc2xhdGVQYXRoKE1ZQlVJTERTKQogICAgaWYgICBkbyA9PSAnZWRpdCc6CiAgICAgICAgZm9sZCA9IGdsb2IuZ2xvYihvcy5wYXRoLmpvaW4oQURET05TLCAnKi8nKSkKICAgICAgICBhZGRvbm5hbWVzID0gW107IGFkZG9uaWRzID0gW107IGFkZG9uZm9sZHMgPSBbXQogICAgICAgIGZvciBmb2xkZXIgaW4gc29ydGVkKGZvbGQsIGtleSA9IGxhbWJkYSB4OiB4KToKICAgICAgICAgICAgZm9sZGVybmFtZSA9IG9zLnBhdGguc3BsaXQoZm9sZGVyWzotMV0pWzFdCiAgICAgICAgICAgIGlmIGZvbGRlcm5hbWUgaW4gRVhDTFVERVM6IGNvbnRpbnVlCiAgICAgICAgICAgIGVsaWYgZm9sZGVybmFtZSBpbiBERUZBVUxUUExVR0lOUzogY29udGludWUKICAgICAgICAgICAgZWxpZiBmb2xkZXJuYW1lID09ICdwYWNrYWdlcyc6IGNvbnRpbnVlCiAgICAgICAgICAgIHhtbCA9IG9zLnBhdGguam9pbihmb2xkZXIsICdhZGRvbi54bWwnKQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyh4bWwpOgogICAgICAgICAgICAgICAgZiAgICAgICA9IG9wZW4oeG1sKQogICAgICAgICAgICAgICAgYSAgICAgICA9IGYucmVhZCgpCiAgICAgICAgICAgICAgICBmLmNsb3NlKCkKICAgICAgICAgICAgICAgIGdldGlkICAgPSBwYXJzZURPTShhLCAnYWRkb24nLCByZXQ9J2lkJykKICAgICAgICAgICAgICAgIGdldG5hbWUgPSBwYXJzZURPTShhLCAnYWRkb24nLCByZXQ9J25hbWUnKQogICAgICAgICAgICAgICAgYWRkaWQgICA9IGZvbGRlcm5hbWUgaWYgbGVuKGdldGlkKSA9PSAwIGVsc2UgZ2V0aWRbMF0KICAgICAgICAgICAgICAgIHRpdGxlICAgPSBmb2xkZXJuYW1lIGlmIGxlbihnZXRuYW1lKSA9PSAwIGVsc2UgZ2V0bmFtZVswXQogICAgICAgICAgICAgICAgdGVtcCAgICA9IHRpdGxlLnJlcGxhY2UoJ1snLCAnPCcpLnJlcGxhY2UoJ10nLCAnPicpCiAgICAgICAgICAgICAgICB0ZW1wICAgID0gcmUuc3ViKCc8W148XSs/PicsICcnLCB0ZW1wKQogICAgICAgICAgICAgICAgYWRkb25uYW1lcy5hcHBlbmQodGVtcCkKICAgICAgICAgICAgICAgIGFkZG9uaWRzLmFwcGVuZChhZGRpZCkKICAgICAgICAgICAgICAgIGFkZG9uZm9sZHMuYXBwZW5kKGZvbGRlcm5hbWUpCiAgICAgICAgZm9sZDIgPSBnbG9iLmdsb2Iob3MucGF0aC5qb2luKEFERE9ORCwgJyovJykpCiAgICAgICAgZm9yIGZvbGRlciBpbiBzb3J0ZWQoZm9sZDIsIGtleSA9IGxhbWJkYSB4OiB4KToKICAgICAgICAgICAgZm9sZGVybmFtZSA9IG9zLnBhdGguc3BsaXQoZm9sZGVyWzotMV0pWzFdCiAgICAgICAgICAgIGlmIGZvbGRlcm5hbWUgaW4gYWRkb25mb2xkczogY29udGludWUKICAgICAgICAgICAgaWYgZm9sZGVybmFtZSBpbiBFWENMVURFUzogY29udGludWUKICAgICAgICAgICAgeG1sICA9IG9zLnBhdGguam9pbihBRERPTlMsIGZvbGRlcm5hbWUsICdhZGRvbi54bWwnKQogICAgICAgICAgICB4bWwyID0gb3MucGF0aC5qb2luKFhCTUMsICdhZGRvbnMnLCBmb2xkZXJuYW1lLCAnYWRkb24ueG1sJykKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoeG1sKToKICAgICAgICAgICAgICAgIGYgICAgICAgPSBvcGVuKHhtbCkKICAgICAgICAgICAgZWxpZiBvcy5wYXRoLmV4aXN0cyh4bWwyKToKICAgICAgICAgICAgICAgIGYgICAgICAgPSBvcGVuKHhtbDIpCiAgICAgICAgICAgIGVsc2U6IGNvbnRpbnVlCiAgICAgICAgICAgIGEgICAgICAgPSBmLnJlYWQoKQogICAgICAgICAgICBmLmNsb3NlKCkKICAgICAgICAgICAgZ2V0aWQgICA9IHBhcnNlRE9NKGEsICdhZGRvbicsIHJldD0naWQnKQogICAgICAgICAgICBnZXRuYW1lID0gcGFyc2VET00oYSwgJ2FkZG9uJywgcmV0PSduYW1lJykKICAgICAgICAgICAgYWRkaWQgICA9IGZvbGRlcm5hbWUgaWYgbGVuKGdldGlkKSA9PSAwIGVsc2UgZ2V0aWRbMF0KICAgICAgICAgICAgdGl0bGUgICA9IGZvbGRlcm5hbWUgaWYgbGVuKGdldG5hbWUpID09IDAgZWxzZSBnZXRuYW1lWzBdCiAgICAgICAgICAgIHRlbXAgICAgPSB0aXRsZS5yZXBsYWNlKCdbJywgJzwnKS5yZXBsYWNlKCddJywgJz4nKQogICAgICAgICAgICB0ZW1wICAgID0gcmUuc3ViKCc8W148XSs/PicsICcnLCB0ZW1wKQogICAgICAgICAgICBhZGRvbm5hbWVzLmFwcGVuZCh0ZW1wKQogICAgICAgICAgICBhZGRvbmlkcy5hcHBlbmQoYWRkaWQpCiAgICAgICAgICAgIGFkZG9uZm9sZHMuYXBwZW5kKGZvbGRlcm5hbWUpCiAgICAgICAgc2VsZWN0ZWQgPSBbXTsgY2hvaWNlID0gMAogICAgICAgIHRlbXBhZGRvbm5hbWVzID0gWyItLSBDbGljayBhcXVpIHBhcmEgQ29udGludWFyIC0tIl0gKyBhZGRvbm5hbWVzCiAgICAgICAgY3VycmVudFdoaXRlID0gd2hpdGVMaXN0KCdyZWFkJykKICAgICAgICBmb3IgaXRlbSBpbiBjdXJyZW50V2hpdGU6CiAgICAgICAgICAgIGxvZyhzdHIoaXRlbSksIHhibWMuTE9HREVCVUcpCiAgICAgICAgICAgIHRyeTogbmFtZSwgaWQsIGZvbGQgPSBpdGVtCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24sIGU6IGxvZyhzdHIoZSkpCiAgICAgICAgICAgIGlmIGlkIGluIGFkZG9uaWRzOgogICAgICAgICAgICAgICAgcG9zID0gYWRkb25pZHMuaW5kZXgoaWQpKzEKICAgICAgICAgICAgICAgIHNlbGVjdGVkLmFwcGVuZChwb3MtMSkKICAgICAgICAgICAgICAgIHRlbXBhZGRvbm5hbWVzW3Bvc10gPSAiW0JdW0NPTE9SICVzXSVzWy9DT0xPUl1bL0JdIiAlIChDT0xPUjEsIG5hbWUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBhZGRvbmlkcy5hcHBlbmQoaWQpCiAgICAgICAgICAgICAgICBhZGRvbm5hbWVzLmFwcGVuZChuYW1lKQogICAgICAgICAgICAgICAgdGVtcGFkZG9ubmFtZXMuYXBwZW5kKCJbQl1bQ09MT1IgJXNdJXNbL0NPTE9SXVsvQl0iICUgKENPTE9SMSwgbmFtZSkpCiAgICAgICAgY2hvaWNlID0gMQogICAgICAgIHdoaWxlIG5vdCBjaG9pY2UgaW4gWy0xLCAwXToKICAgICAgICAgICAgY2hvaWNlID0gRElBTE9HLnNlbGVjdCgiJXM6IFNlbGVjY2lvbmEgbG9zIGFkZG9ucyBxdWUgcXVpZXJhcyBwYXJhIGxhIFdoaXRlIExpc3QuIiAlIEFERE9OVElUTEUsIHRlbXBhZGRvbm5hbWVzKQogICAgICAgICAgICBpZiBjaG9pY2UgPT0gLTE6IGJyZWFrCiAgICAgICAgICAgIGVsaWYgY2hvaWNlID09IDA6IGJyZWFrCiAgICAgICAgICAgIGVsc2U6IAogICAgICAgICAgICAgICAgY2hvaWNlMiA9IChjaG9pY2UtMSkKICAgICAgICAgICAgICAgIGlmIGNob2ljZTIgaW4gc2VsZWN0ZWQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQucmVtb3ZlKGNob2ljZTIpCiAgICAgICAgICAgICAgICAgICAgdGVtcGFkZG9ubmFtZXNbY2hvaWNlXSA9IGFkZG9ubmFtZXNbY2hvaWNlMl0KICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQuYXBwZW5kKGNob2ljZTIpCiAgICAgICAgICAgICAgICAgICAgdGVtcGFkZG9ubmFtZXNbY2hvaWNlXSA9ICJbQl1bQ09MT1IgJXNdJXNbL0NPTE9SXVsvQl0iICUgKENPTE9SMSwgYWRkb25uYW1lc1tjaG9pY2UyXSkKICAgICAgICB3aGl0ZWxpc3QgPSBbXQogICAgICAgIGlmIGxlbihzZWxlY3RlZCkgPiAwOgogICAgICAgICAgICBmb3IgYWRkb24gaW4gc2VsZWN0ZWQ6CiAgICAgICAgICAgICAgICB3aGl0ZWxpc3QuYXBwZW5kKCJbJyVzJywgJyVzJywgJyVzJ10iICUgKGFkZG9ubmFtZXNbYWRkb25dLCBhZGRvbmlkc1thZGRvbl0sIGFkZG9uZm9sZHNbYWRkb25dKSkKICAgICAgICAgICAgd3JpdGluZyA9ICdcbicuam9pbih3aGl0ZWxpc3QpCiAgICAgICAgICAgIGYgPSBvcGVuKFdISVRFTElTVCwgJ3cnKTsgZi53cml0ZSh3cml0aW5nKTsgZi5jbG9zZSgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdHJ5OiBvcy5yZW1vdmUoV0hJVEVMSVNUKQogICAgICAgICAgICBleGNlcHQ6IHBhc3MKICAgICAgICBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCAiW0NPTE9SICVzXSVzIEFkZG9ucyBlbiBsYSBXaGl0ZSBMaXN0Wy9DT0xPUl0iICUgKENPTE9SMiwgbGVuKHNlbGVjdGVkKSkpCiAgICBlbGlmIGRvID09ICdyZWFkJyA6CiAgICAgICAgd2hpdGUgPSBbXQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKFdISVRFTElTVCk6IAogICAgICAgICAgICBmID0gb3BlbihXSElURUxJU1QpCiAgICAgICAgICAgIGEgPSBmLnJlYWQoKQogICAgICAgICAgICBmLmNsb3NlKCkKICAgICAgICAgICAgbGluZXMgPSBhLnNwbGl0KCdcbicpCiAgICAgICAgICAgIGZvciBpdGVtIGluIGxpbmVzOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG5hbWUsIGlkLCBmb2xkID0gZXZhbChpdGVtKQogICAgICAgICAgICAgICAgICAgIHdoaXRlLmFwcGVuZChldmFsKGl0ZW0pKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gd2hpdGUKICAgIGVsaWYgZG8gPT0gJ3ZpZXcnIDoKICAgICAgICBsaXN0ID0gd2hpdGVMaXN0KCdyZWFkJykKICAgICAgICBpZiBsZW4obGlzdCkgPiAwOgogICAgICAgICAgICBtc2cgPSAiQXF1aSBlc3RhIHVuYSBsaXN0YSBjb24gdHVzIGFkZG9ucyBlbiBsYSBXaGl0ZSBMaXN0LCBlc3RhIGxpc3RhICh5IHN1cyBkZXBlbmRlbmNpYXMpIG5vIHNlIGVsaW1pbmFyYW4gY3VhbmRvIGluc3RhbGVzIGFjdHVhbGl6YWNpb25lcyBvIGluc3RhbGFjaW9uZXMgbGltcGlhcy5bQ1JdW0NSXSIKICAgICAgICAgICAgZm9yIGl0ZW0gaW4gbGlzdDoKICAgICAgICAgICAgICAgIHRyeTogbmFtZSwgaWQsIGZvbGQgPSBpdGVtCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uLCBlOiBsb2coc3RyKGUpKQogICAgICAgICAgICAgICAgbXNnICs9ICJbQ09MT1IgJXNdJXNbL0NPTE9SXSBbQ09MT1IgJXNdXCIlc1wiWy9DT0xPUl1bQ1JdIiAlIChDT0xPUjEsIG5hbWUsIENPTE9SMiwgaWQpIAogICAgICAgICAgICBUZXh0Qm94KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgbXNnKQogICAgICAgIGVsc2U6IExvZ05vdGlmeSgiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgQURET05USVRMRSksICJbQ09MT1IgJXNdTm8gaGF5IGl0ZW1zIGVuIGxhIFdoaXRlIExpc3RbL0NPTE9SXSIgJSBDT0xPUjIpCiAgICBlbGlmIGRvID09ICdpbXBvcnQnOgogICAgICAgIHNvdXJjZSA9IERJQUxPRy5icm93c2UoMSwgJ1tDT0xPUiAlc11TZWxlY2Npb25hIHVuYSBXaGl0ZSBsaXN0IHBhcmEgcmVzdGF1cmFyWy9DT0xPUl0nICUgQ09MT1IyLCAnZmlsZXMnLCAnLnR4dCcsIEZhbHNlLCBGYWxzZSwgSE9NRSkKICAgICAgICBsb2coc3RyKHNvdXJjZSkpCiAgICAgICAgaWYgbm90IHNvdXJjZS5lbmRzd2l0aCgnLnR4dCcpOgogICAgICAgICAgICBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCAiW0NPTE9SICVzXUltcG9ydGFjaW9uIENhbmNlbGFkYSFbL0NPTE9SXSIgJSBDT0xPUjIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGYgICAgICAgPSB4Ym1jdmZzLkZpbGUoc291cmNlKQogICAgICAgIGEgICAgICAgPSBmLnJlYWQoKQogICAgICAgIGYuY2xvc2UoKQogICAgICAgIGN1cnJlbnQgPSB3aGl0ZUxpc3QoJ3JlYWQnKTsgaWRMaXN0ID0gW107IGNvdW50ID0gMAogICAgICAgIGZvciBpdGVtIGluIGN1cnJlbnQ6CiAgICAgICAgICAgIG5hbWUsIGlkLCBmb2xkID0gaXRlbQogICAgICAgICAgICBpZExpc3QuYXBwZW5kKGlkKQogICAgICAgIGxpbmVzID0gYS5zcGxpdCgnXG4nKQogICAgICAgIHdpdGggb3BlbihXSElURUxJU1QsICdhJykgYXMgZjoKICAgICAgICAgICAgZm9yIGl0ZW0gaW4gbGluZXM6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgbmFtZSwgaWQsIGZvbGRlciA9IGV2YWwoaXRlbSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24sIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nKCJFcnJvciBBZGRpbmc6ICclcycgLyAlcyIgJSAoaXRlbSwgc3RyKGUpKSwgeGJtYy5MT0dFUlJPUikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgbG9nKCIlcyAvICVzIC8gJXMiICUgKG5hbWUsIGlkLCBmb2xkZXIpLCB4Ym1jLkxPR0RFQlVHKQogICAgICAgICAgICAgICAgaWYgbm90IGlkIGluIGlkTGlzdDoKICAgICAgICAgICAgICAgICAgICBjb3VudCArPSAxCiAgICAgICAgICAgICAgICAgICAgd3JpdGluZyA9ICJbJyVzJywgJyVzJywgJyVzJ10iICUgKG5hbWUsIGlkLCBmb2xkZXIpCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKGlkTGlzdCkgKyBjb3VudCA+IDE6IHdyaXRpbmcgPSAiXG4lcyIgJSB3cml0aW5nCiAgICAgICAgICAgICAgICAgICAgZi53cml0ZSh3cml0aW5nKQogICAgICAgICAgICBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCAiW0NPTE9SICVzXSVzIEl0ZW0ocykgQWdyZWdhZG9zWy9DT0xPUl0iICUgKENPTE9SMiwgY291bnQpKQogICAgZWxpZiBkbyA9PSAnZXhwb3J0JzoKICAgICAgICBzb3VyY2UgPSBESUFMT0cuYnJvd3NlKDMsICdbQ09MT1IgJXNdU2VsZWNjaW9uYSBkb25kZSBxdWllcmVzIGd1YXJkYXIgbGEgV2hpdGUgTGlzdFsvQ09MT1JdJyAlIENPTE9SMiwgJ2ZpbGVzJywgJy50eHQnLCBGYWxzZSwgRmFsc2UsIEhPTUUpCiAgICAgICAgbG9nKHN0cihzb3VyY2UpLCB4Ym1jLkxPR0RFQlVHKQogICAgICAgIHRyeToKICAgICAgICAgICAgeGJtY3Zmcy5jb3B5KFdISVRFTElTVCwgb3MucGF0aC5qb2luKHNvdXJjZSwgJ3doaXRlbGlzdC50eHQnKSkKICAgICAgICAgICAgRElBTE9HLm9rKEFERE9OVElUTEUsICJbQ09MT1IgJXNdTGEgV2hpdGVsaXN0IHNlIGhhIGV4cG9ydGFkbyBhOlsvQ09MT1JdIiAlIChDT0xPUjIpLCAiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgb3MucGF0aC5qb2luKHNvdXJjZSwgJ3doaXRlbGlzdC50eHQnKSkpCiAgICAgICAgICAgIExvZ05vdGlmeSgiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgQURET05USVRMRSksICJbQ09MT1IgJXNdV2hpdGVsaXN0IEV4cG9ydGFkYVsvQ09MT1JdIiAlIChDT0xPUjIpKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24sIGU6CiAgICAgICAgICAgIGxvZygiRXhwb3J0IEVycm9yOiAlcyIgJSBzdHIoZSksIHhibWMuTE9HRVJST1IpCiAgICAgICAgICAgIGlmIG5vdCBESUFMT0cueWVzbm8oQURET05USVRMRSwgIltDT0xPUiAlc11JbXBvc2libGUgZXNjcmliaXIgZW4gZWwgZGlyZWN0b3JpbywgcXVpZXJlcyBzZWxlY2Npb25hciBvdHJvP1svQ09MT1JdIiAlIENPTE9SMiwgeWVzbGFiZWw9IltCXVtDT0xPUiBncmVlbl1DYW1iaWFyIGRpcmVjdG9yaW9bL0NPTE9SXVsvQl0iLCBub2xhYmVsPSJbQl1bQ09MT1IgcmVkXU5vLCBDYW5jZWxhclsvQ09MT1JdWy9CXSIpOgogICAgICAgICAgICAgICAgTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgIltDT0xPUiAlc11FeHBvcnRhY2lvbiBkZSBXaGl0ZWxpc3QgQ2FuY2VsYWRvWy9DT0xPUl0iICUgKENPTE9SMiwgZSkpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB3aGl0ZWxpc3QoZXhwb3J0KQogICAgZWxpZiBkbyA9PSAnY2xlYXInOgogICAgICAgIGlmIG5vdCBESUFMT0cueWVzbm8oQURET05USVRMRSwgIltDT0xPUiAlc11TZWd1cm8gcXVlIHF1aWVyZXMgZWxpbWluYXIgdHUgd2hpdGVsaXN0PyIgJSBDT0xPUjIsICJFc3RlIHByb2Nlc28gZXMgaXJyZXZlcnNpYmxlLlsvQ09MT1JdIiwgeWVzbGFiZWw9IltCXVtDT0xPUiBncmVlbl1TaSwgZWxpbWluYXJbL0NPTE9SXVsvQl0iLCBub2xhYmVsPSJbQl1bQ09MT1IgcmVkXU5vLCBDYW5jZWxhclsvQ09MT1JdWy9CXSIpOgogICAgICAgICAgICBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCAiW0NPTE9SICVzXUxpbXBpYXIgV2hpdGVsaXN0OiBDYW5jZWxhZG9bL0NPTE9SXSIgJSAoQ09MT1IyKSkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgdHJ5OiAKICAgICAgICAgICAgb3MucmVtb3ZlKFdISVRFTElTVCkKICAgICAgICAgICAgTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgIltDT0xPUiAlc11XaGl0ZWxpc3Q6IGxpbXBpYWRvWy9DT0xPUl0iICUgKENPTE9SMikpCiAgICAgICAgZXhjZXB0OiAKICAgICAgICAgICAgTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgIltDT0xPUiAlc11FcnJvciBsaW1waWFuZG8gV2hpdGVsaXN0IVsvQ09MT1JdIiAlIChDT0xPUjIpKQoKZGVmIGNsZWFyUGFja2FnZXMob3Zlcj1Ob25lKToKICAgIGlmIG9zLnBhdGguZXhpc3RzKFBBQ0tBR0VTKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZvciByb290LCBkaXJzLCBmaWxlcyBpbiBvcy53YWxrKFBBQ0tBR0VTKToKICAgICAgICAgICAgICAgIGZpbGVfY291bnQgPSAwCiAgICAgICAgICAgICAgICBmaWxlX2NvdW50ICs9IGxlbihmaWxlcykKICAgICAgICAgICAgICAgIGlmIGZpbGVfY291bnQgPiAwOgogICAgICAgICAgICAgICAgICAgIHNpemUgPSBjb252ZXJ0U2l6ZShnZXRTaXplKFBBQ0tBR0VTKSkKICAgICAgICAgICAgICAgICAgICBpZiBvdmVyOiB5ZXM9MQogICAgICAgICAgICAgICAgICAgIGVsc2U6IHllcz1ESUFMT0cueWVzbm8oIltDT0xPUiAlc11EZWxldGUgUGFja2FnZSBGaWxlcyIgJSBDT0xPUjIsICJbQ09MT1IgJXNdJXNbL0NPTE9SXSBmaWxlcyBmb3VuZCAvIFtDT0xPUiAlc10lc1svQ09MT1JdIGluIHNpemUuIiAlIChDT0xPUjEsIHN0cihmaWxlX2NvdW50KSwgQ09MT1IxLCBzaXplKSwgIkRvIHlvdSB3YW50IHRvIGRlbGV0ZSB0aGVtP1svQ09MT1JdIiwgbm9sYWJlbD0nW0JdW0NPTE9SIHJlZF1Eb25cJ3QgQ2xlYXJbL0NPTE9SXVsvQl0nLHllc2xhYmVsPSdbQl1bQ09MT1IgZ3JlZW5dQ2xlYXIgUGFja2FnZXNbL0NPTE9SXVsvQl0nKQogICAgICAgICAgICAgICAgICAgIGlmIHllczoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGYgaW4gZmlsZXM6IG9zLnVubGluayhvcy5wYXRoLmpvaW4ocm9vdCwgZikpCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBkIGluIGRpcnM6IHNodXRpbC5ybXRyZWUob3MucGF0aC5qb2luKHJvb3QsIGQpKQogICAgICAgICAgICAgICAgICAgICAgICBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCdbQ09MT1IgJXNdTGltcGlhbmRvIHBhcXVldGVzOiBPa1svQ09MT1JdJyAlIENPTE9SMikKICAgICAgICAgICAgICAgIGVsc2U6IExvZ05vdGlmeSgiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgQURET05USVRMRSksJ1tDT0xPUiAlc11MaW1waWFuZG8gcGFxdWV0ZXM6IE5pbmd1bm8gZW5jb250cmFkbyFbL0NPTE9SXScgJSBDT0xPUjIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiwgZToKICAgICAgICAgICAgTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwnW0NPTE9SICVzXUxpbXBpYW5kbyBwYXF1ZXRlczogRXJyb3IhWy9DT0xPUl0nICUgQ09MT1IyKQogICAgICAgICAgICBsb2coIkNsZWFyIFBhY2thZ2VzIEVycm9yOiAlcyIgJSBzdHIoZSksIHhibWMuTE9HRVJST1IpCiAgICBlbHNlOiBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCdbQ09MT1IgJXNdTGltcGlhbmRvIHBhcXVldGVzOiBOaW5ndW5vIGVuY29udHJhZG8hWy9DT0xPUl0nICUgQ09MT1IyKQoKZGVmIGNsZWFyUGFja2FnZXNTdGFydHVwKCk6CiAgICBzdGFydCA9IGRhdGV0aW1lLnV0Y25vdygpIC0gdGltZWRlbHRhKG1pbnV0ZXM9MykKICAgIGZpbGVfY291bnQgPSAwOyBjbGVhbnVwc2l6ZSA9IDAKICAgIGlmIG9zLnBhdGguZXhpc3RzKFBBQ0tBR0VTKToKICAgICAgICBwYWNrID0gb3MubGlzdGRpcihQQUNLQUdFUykKICAgICAgICBwYWNrLnNvcnQoa2V5PWxhbWJkYSBmOiBvcy5wYXRoLmdldG10aW1lKG9zLnBhdGguam9pbihQQUNLQUdFUywgZikpKQogICAgICAgIHRyeToKICAgICAgICAgICAgZm9yIGl0ZW0gaW4gcGFjazoKICAgICAgICAgICAgICAgIGZpbGUgPSBvcy5wYXRoLmpvaW4oUEFDS0FHRVMsIGl0ZW0pCiAgICAgICAgICAgICAgICBsYXN0ZWRpdCA9IGRhdGV0aW1lLnV0Y2Zyb210aW1lc3RhbXAob3MucGF0aC5nZXRtdGltZShmaWxlKSkKICAgICAgICAgICAgICAgIGlmIGxhc3RlZGl0IDw9IHN0YXJ0OgogICAgICAgICAgICAgICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKGZpbGUpOgogICAgICAgICAgICAgICAgICAgICAgICBmaWxlX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYW51cHNpemUgKz0gb3MucGF0aC5nZXRzaXplKGZpbGUpCiAgICAgICAgICAgICAgICAgICAgICAgIG9zLnVubGluayhmaWxlKQogICAgICAgICAgICAgICAgICAgIGVsaWYgb3MucGF0aC5pc2RpcihmaWxlKTogCiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFudXBzaXplICs9IGdldFNpemUoZmlsZSkKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYW5maWxlcywgY2xlYW5mb2xkID0gY2xlYW5Ib3VzZShmaWxlKQogICAgICAgICAgICAgICAgICAgICAgICBmaWxlX2NvdW50ICs9IGNsZWFuZmlsZXMgKyBjbGVhbmZvbGQKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2h1dGlsLnJtdHJlZShmaWxlKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uLCBlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nKCJFcnJvciBhbCBlbGltaW5hciAlczogJXMiICUgKGZpbGUsIHN0cihlKSwgeGJtYy5MT0dFUlJPUikpCiAgICAgICAgICAgIGlmIGZpbGVfY291bnQgPiAwOiBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCAnW0NPTE9SICVzXUxpbXBpYW5kbyBwYXF1ZXRlczogT2s6ICVzWy9DT0xPUl0nICUgKENPTE9SMiwgY29udmVydFNpemUoY2xlYW51cHNpemUpKSkKICAgICAgICAgICAgZWxzZTogTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgJ1tDT0xPUiAlc11MaW1waWFuZG8gcGFxdWV0ZXM6IE5pbmd1bm8gZW5jb250cmFkbyFbL0NPTE9SXScgJSBDT0xPUjIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiwgZToKICAgICAgICAgICAgTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgJ1tDT0xPUiAlc11MaW1waWFuZG8gcGFxdWV0ZXM6IEVycm9yIVsvQ09MT1JdJyAlIENPTE9SMikKICAgICAgICAgICAgbG9nKCJDbGVhciBQYWNrYWdlcyBFcnJvcjogJXMiICUgc3RyKGUpLCB4Ym1jLkxPR0VSUk9SKQogICAgZWxzZTogTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgJ1tDT0xPUiAlc11MaW1waWFuZG8gcGFxdWV0ZXM6IE5pbmd1bm8gZW5jb250cmFkbyFbL0NPTE9SXScgJSBDT0xPUjIpCgpkZWYgY2xlYXJDYWNoZShvdmVyPU5vbmUpOgogICAgUFJPRklMRUFERE9OREFUQSA9IG9zLnBhdGguam9pbihQUk9GSUxFLCdhZGRvbl9kYXRhJykKICAgIGRiZmlsZXMgICA9IFsKICAgICAgICAob3MucGF0aC5qb2luKEFERE9OREFUQSwgJ3BsdWdpbi52aWRlby5waHN0cmVhbXMnLCAnY2FjaGUuZGInKSksCiAgICAgICAgKG9zLnBhdGguam9pbihBRERPTkRBVEEsICdwbHVnaW4udmlkZW8uYm9iJywgJ2NhY2hlLmRiJykpLAogICAgICAgIChvcy5wYXRoLmpvaW4oQURET05EQVRBLCAncGx1Z2luLnZpZGVvLnNwZWN0bycsICdjYWNoZS5kYicpKSwKICAgICAgICAob3MucGF0aC5qb2luKEFERE9OREFUQSwgJ3BsdWdpbi52aWRlby5nZW5lc2lzJywgJ2NhY2hlLmRiJykpLAogICAgICAgIChvcy5wYXRoLmpvaW4oQURET05EQVRBLCAncGx1Z2luLnZpZGVvLmV4b2R1cycsICdjYWNoZS5kYicpKSwKICAgICAgICAob3MucGF0aC5qb2luKERBVEFCQVNFLCAgJ29uZWNoYW5uZWxjYWNoZS5kYicpKSwKICAgICAgICAob3MucGF0aC5qb2luKERBVEFCQVNFLCAgJ3NhbHRzY2FjaGUuZGInKSksCiAgICAgICAgKG9zLnBhdGguam9pbihEQVRBQkFTRSwgICdzYWx0c2hkLmxpdGUuZGInKSldCiAgICAgICAgCiAgICBjYWNoZWxpc3QgPSBbCiAgICAgICAgKFBST0ZJTEVBRERPTkRBVEEpLAogICAgICAgIChBRERPTkRBVEEpLAogICAgICAgIChvcy5wYXRoLmpvaW4oSE9NRSwnY2FjaGUnKSksCiAgICAgICAgKG9zLnBhdGguam9pbihIT01FLCd0ZW1wJykpLAogICAgICAgIChvcy5wYXRoLmpvaW4oJy9wcml2YXRlL3Zhci9tb2JpbGUvTGlicmFyeS9DYWNoZXMvQXBwbGVUVi9WaWRlby8nLCAnT3RoZXInKSksCiAgICAgICAgKG9zLnBhdGguam9pbignL3ByaXZhdGUvdmFyL21vYmlsZS9MaWJyYXJ5L0NhY2hlcy9BcHBsZVRWL1ZpZGVvLycsICdMb2NhbEFuZFJlbnRhbCcpKSwKICAgICAgICAob3MucGF0aC5qb2luKEFERE9OREFUQSwnc2NyaXB0Lm1vZHVsZS5zaW1wbGUuZG93bmxvYWRlcicpKSwKICAgICAgICAob3MucGF0aC5qb2luKEFERE9OREFUQSwncGx1Z2luLnZpZGVvLml0dicsJ0ltYWdlcycpKSwKICAgICAgICAob3MucGF0aC5qb2luKFBST0ZJTEVBRERPTkRBVEEsJ3NjcmlwdC5tb2R1bGUuc2ltcGxlLmRvd25sb2FkZXInKSksCiAgICAgICAgKG9zLnBhdGguam9pbihQUk9GSUxFQURET05EQVRBLCdwbHVnaW4udmlkZW8uaXR2JywnSW1hZ2VzJykpXQogICAgICAgIAogICAgZGVsZmlsZXMgPSAwCiAgICBleGNsdWRlcyA9IFsnbWV0YV9jYWNoZScsICdhcmNoaXZlX2NhY2hlJ10KICAgIGZvciBpdGVtIGluIGNhY2hlbGlzdDoKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhpdGVtKSBhbmQgbm90IGl0ZW0gaW4gW0FERE9OREFUQSwgUFJPRklMRUFERE9OREFUQV06CiAgICAgICAgICAgIGZvciByb290LCBkaXJzLCBmaWxlcyBpbiBvcy53YWxrKGl0ZW0pOgogICAgICAgICAgICAgICAgZGlyc1s6XSA9IFtkIGZvciBkIGluIGRpcnMgaWYgZCBub3QgaW4gZXhjbHVkZXNdCiAgICAgICAgICAgICAgICBmaWxlX2NvdW50ID0gMAogICAgICAgICAgICAgICAgZmlsZV9jb3VudCArPSBsZW4oZmlsZXMpCiAgICAgICAgICAgICAgICBpZiBmaWxlX2NvdW50ID4gMDoKICAgICAgICAgICAgICAgICAgICBmb3IgZiBpbiBmaWxlczoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IGYgaW4gTE9HRklMRVM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3MudW5saW5rKG9zLnBhdGguam9pbihyb290LCBmKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2coIltXaXBlZF0gJXMiICUgb3MucGF0aC5qb2luKHJvb3QsIGYpLCB4Ym1jLkxPR05PVElDRSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxmaWxlcyArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOiBsb2coJ0lnbm9yZSBMb2cgRmlsZTogJXMnICUgZiwgeGJtYy5MT0dOT1RJQ0UpCiAgICAgICAgICAgICAgICAgICAgZm9yIGQgaW4gZGlyczoKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2h1dGlsLnJtdHJlZShvcy5wYXRoLmpvaW4ocm9vdCwgZCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxmaWxlcyArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2coIltTdWNjZXNzXSBjbGVhcmVkICVzIGZpbGVzIGZyb20gJXMiICUgKHN0cihmaWxlX2NvdW50KSwgb3MucGF0aC5qb2luKGl0ZW0sZCkpLCB4Ym1jLkxPR05PVElDRSkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nKCJbRmFpbGVkXSB0byB3aXBlIGNhY2hlIGluOiAlcyIgJSBvcy5wYXRoLmpvaW4oaXRlbSxkKSwgeGJtYy5MT0dOT1RJQ0UpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZm9yIHJvb3QsIGRpcnMsIGZpbGVzIGluIG9zLndhbGsoaXRlbSk6CiAgICAgICAgICAgICAgICBkaXJzWzpdID0gW2QgZm9yIGQgaW4gZGlycyBpZiBkIG5vdCBpbiBleGNsdWRlc10KICAgICAgICAgICAgICAgIGZvciBkIGluIGRpcnM6CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHN0cihkLmxvd2VyKCkpLmZpbmQoJ2NhY2hlJykgPT0gLTE6CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNodXRpbC5ybXRyZWUob3MucGF0aC5qb2luKHJvb3QsIGQpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZmlsZXMgKz0gMQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nKCJbU3VjY2Vzc10gd2lwZWQgJXMgIiAlIG9zLnBhdGguam9pbihyb290LGQpLCB4Ym1jLkxPR05PVElDRSkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nKCJbRmFpbGVkXSB0byB3aXBlIGNhY2hlIGluOiAlcyIgJSBvcy5wYXRoLmpvaW4oaXRlbSxkKSwgeGJtYy5MT0dOT1RJQ0UpCiAgICBpZiBJTkNMVURFVklERU8gPT0gJ3RydWUnIGFuZCBvdmVyID09IE5vbmU6CiAgICAgICAgZmlsZXMgPSBbXQogICAgICAgIGlmIElOQ0xVREVBTEwgPT0gJ3RydWUnOiBmaWxlcyA9IGRiZmlsZXMKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBJTkNMVURFQk9CID09ICd0cnVlJzogICAgIGZpbGVzLmFwcGVuZChvcy5wYXRoLmpvaW4oQURET05EQVRBLCAncGx1Z2luLnZpZGVvLmJvYicsICdjYWNoZS5kYicpKQogICAgICAgICAgICBpZiBJTkNMVURFUEhPRU5JWCA9PSAndHJ1ZSc6IGZpbGVzLmFwcGVuZChvcy5wYXRoLmpvaW4oQURET05EQVRBLCAncGx1Z2luLnZpZGVvLnBoc3RyZWFtcycsICdjYWNoZS5kYicpKQogICAgICAgICAgICBpZiBJTkNMVURFU1BFQ1RPID09ICd0cnVlJzogIGZpbGVzLmFwcGVuZChvcy5wYXRoLmpvaW4oQURET05EQVRBLCAncGx1Z2luLnZpZGVvLnNwZWN0bycsICdjYWNoZS5kYicpKQogICAgICAgICAgICBpZiBJTkNMVURFR0VORVNJUyA9PSAndHJ1ZSc6IGZpbGVzLmFwcGVuZChvcy5wYXRoLmpvaW4oQURET05EQVRBLCAncGx1Z2luLnZpZGVvLmdlbmVzaXMnLCAnY2FjaGUuZGInKSkKICAgICAgICAgICAgaWYgSU5DTFVERUVYT0RVUyA9PSAndHJ1ZSc6ICBmaWxlcy5hcHBlbmQob3MucGF0aC5qb2luKEFERE9OREFUQSwgJ3BsdWdpbi52aWRlby5leG9kdXMnLCAnY2FjaGUuZGInKSkKICAgICAgICAgICAgaWYgSU5DTFVERU9ORUNIQU4gPT0gJ3RydWUnOiBmaWxlcy5hcHBlbmQob3MucGF0aC5qb2luKERBVEFCQVNFLCAgJ29uZWNoYW5uZWxjYWNoZS5kYicpKQogICAgICAgICAgICBpZiBJTkNMVURFU0FMVFMgPT0gJ3RydWUnOiAgIGZpbGVzLmFwcGVuZChvcy5wYXRoLmpvaW4oREFUQUJBU0UsICAnc2FsdHNjYWNoZS5kYicpKQogICAgICAgICAgICBpZiBJTkNMVURFU0FMVFNIRCA9PSAndHJ1ZSc6IGZpbGVzLmFwcGVuZChvcy5wYXRoLmpvaW4oREFUQUJBU0UsICAnc2FsdHNoZC5saXRlLmRiJykpCiAgICAgICAgaWYgbGVuKGZpbGVzKSA+IDA6CiAgICAgICAgICAgIGZvciBpdGVtIGluIGZpbGVzOgogICAgICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoaXRlbSk6CiAgICAgICAgICAgICAgICAgICAgZGVsZmlsZXMgKz0gMQogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dGRiID0gZGF0YWJhc2UuY29ubmVjdChpdGVtKQogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ZXhlID0gdGV4dGRiLmN1cnNvcigpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiwgZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nKCJEQiBDb25uZWN0aW9uIGVycm9yOiAlcyIgJSBzdHIoZSksIHhibWMuTE9HRVJST1IpCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgaWYgJ0RhdGFiYXNlJyBpbiBpdGVtOgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ZXhlLmV4ZWN1dGUoIkRFTEVURSBGUk9NIHVybF9jYWNoZSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ZXhlLmV4ZWN1dGUoIlZBQ1VVTSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ZGIuY29tbWl0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHRleGUuY2xvc2UoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nKCJbU3VjY2Vzc10gd2lwZWQgJXMiICUgaXRlbSwgeGJtYy5MT0dOT1RJQ0UpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24sIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2coIltGYWlsZWRdIHdpcGVkICVzOiAlcyIgJSAoaXRlbSwgc3RyKGUpKSwgeGJtYy5MT0dOT1RJQ0UpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dGV4ZS5leGVjdXRlKCJTRUxFQ1QgbmFtZSBGUk9NIHNxbGl0ZV9tYXN0ZXIgV0hFUkUgdHlwZSA9ICd0YWJsZSciKQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgdGFibGUgaW4gdGV4dGV4ZS5mZXRjaGFsbCgpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHRleGUuZXhlY3V0ZSgiREVMRVRFIEZST00gJXMiICUgdGFibGVbMF0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dGV4ZS5leGVjdXRlKCJWQUNVVU0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHRkYi5jb21taXQoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZygiW1N1Y2Nlc3NdIHdpcGVkICVzIGluICVzIiAlICh0YWJsZSwgaXRlbSksIHhibWMuTE9HTk9USUNFKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiwgZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2coIltGYWlsZWRdIHdpcGVkICVzIGluICVzOiAlcyIgJSAodGFibGUsIGl0ZW0sIHN0cihlKSksIHhibWMuTE9HTk9USUNFKQogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ZXhlLmNsb3NlKCkKICAgICAgICBlbHNlOiBsb2coIkNsZWFyIENhY2hlOiBDbGVhciBWaWRlbyBDYWNoZSBOb3QgRW5hYmxlZCIsIHhibWMuTE9HTk9USUNFKQogICAgTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgJ1tDT0xPUiAlc11MaW1waWFuZG8gY2FjaGU6IEVsaW1pbmFkby9zICVzIGFyY2hpdm9zWy9DT0xPUl0nICUgKENPTE9SMiwgZGVsZmlsZXMpKQoKZGVmIGNoZWNrU291cmNlcygpOgogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKFNPVVJDRVMpOgogICAgICAgIExvZ05vdGlmeSgiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgQURET05USVRMRSksICJbQ09MT1IgJXNdTm8gc2UgaGEgZW5jb250cmFkbyBlbCBhcmNoaXZvIFNvdXJjZXMueG1sIiAlIENPTE9SMikKICAgICAgICByZXR1cm4gRmFsc2UKICAgIHggICAgICA9IDAKICAgIGJhZCAgICA9IFtdCiAgICByZW1vdmUgPSBbXQogICAgZiAgICAgID0gb3BlbihTT1VSQ0VTKQogICAgYSAgICAgID0gZi5yZWFkKCkKICAgIHRlbXAgICA9IGEucmVwbGFjZSgnXHInLCcnKS5yZXBsYWNlKCdcbicsJycpLnJlcGxhY2UoJ1x0JywnJykKICAgIG1hdGNoICA9IHJlLmNvbXBpbGUoJzxmaWxlcz4uKz88L2ZpbGVzPicpLmZpbmRhbGwodGVtcCkKICAgIGYuY2xvc2UoKQogICAgaWYgbGVuKG1hdGNoKSA+IDA6CiAgICAgICAgbWF0Y2gyICA9IHJlLmNvbXBpbGUoJzxzb3VyY2U+Lis/PG5hbWU+KC4rPyk8L25hbWU+Lis/PHBhdGggcGF0aHZlcnNpb249IjEiPiguKz8pPC9wYXRoPi4rPzxhbGxvd3NoYXJpbmc+KC4rPyk8L2FsbG93c2hhcmluZz4uKz88L3NvdXJjZT4nKS5maW5kYWxsKG1hdGNoWzBdKQogICAgICAgIERQLmNyZWF0ZShBRERPTlRJVExFLCAiW0NPTE9SICVzXUVzY2FuZWFuZG8gZnVlbnRlcyBwYXJhIGVuY29udHJhciBsaW5rcyByb3Rvc1svQ09MT1JdIiAlIENPTE9SMikKICAgICAgICBmb3IgbmFtZSwgcGF0aCwgc2hhcmluZyBpbiBtYXRjaDI6CiAgICAgICAgICAgIHggICAgICs9IDEKICAgICAgICAgICAgcGVyYyAgID0gaW50KHBlcmNlbnRhZ2UoeCwgbGVuKG1hdGNoMikpKQogICAgICAgICAgICBEUC51cGRhdGUocGVyYywgJycsICJbQ09MT1IgJXNdQ29tcHJvYmFuZG8gW0NPTE9SICVzXSVzWy9DT0xPUl06Wy9DT0xPUl0iICUgKENPTE9SMiwgQ09MT1IxLCBuYW1lKSwgIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIHBhdGgpKQogICAgICAgICAgICBpZiAnaHR0cCcgaW4gcGF0aDoKICAgICAgICAgICAgICAgIHdvcmtpbmcgPSB3b3JraW5nVVJMKHBhdGgpCiAgICAgICAgICAgICAgICBpZiBub3Qgd29ya2luZyA9PSBUcnVlOgogICAgICAgICAgICAgICAgICAgIGJhZC5hcHBlbmQoW25hbWUsIHBhdGgsIHNoYXJpbmcsIHdvcmtpbmddKQoKICAgICAgICBsb2coIkJhZCBTb3VyY2VzOiAlcyIgJSBsZW4oYmFkKSwgeGJtYy5MT0dOT1RJQ0UpCiAgICAgICAgaWYgbGVuKGJhZCkgPiAwOgogICAgICAgICAgICBjaG9pY2UgPSBESUFMT0cueWVzbm8oQURET05USVRMRSwgIltDT0xPUiAlc10lc1svQ09MT1JdW0NPTE9SICVzXSBVbmEgbyB2YXJpYXMgZnVlbnRlKHMpIHNlIGhhbiBlbmNvbnRyYWRvIHJvdGFzIiAlIChDT0xPUjEsIGxlbihiYWQpLCBDT0xPUjIpLCJRdWllcmVzIGVsaW1pbmFybGFzIHRvZGFzIG8gdW5hIGEgdW5hP1svQ09MT1JdIiwgeWVzbGFiZWw9IltCXVtDT0xPUiBncmVlbl1Ub2Rhc1svQ09MT1JdWy9CXSIsIG5vbGFiZWw9IltCXVtDT0xPUiByZWRdVW5hIGEgdW5hWy9DT0xPUl1bL0JdIikKICAgICAgICAgICAgaWYgY2hvaWNlID09IDE6CiAgICAgICAgICAgICAgICByZW1vdmUgPSBiYWQKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGZvciBuYW1lLCBwYXRoLCBzaGFyaW5nLCB3b3JraW5nIGluIGJhZDogCiAgICAgICAgICAgICAgICAgICAgbG9nKCIlcyBzb3VyY2VzOiAlcywgJXMiICUgKG5hbWUsIHBhdGgsIHdvcmtpbmcpLCB4Ym1jLkxPR05PVElDRSkKICAgICAgICAgICAgICAgICAgICBpZiBESUFMT0cueWVzbm8oQURET05USVRMRSwgIltDT0xPUiAlc10lc1svQ09MT1JdW0NPTE9SICVzXSBoYSBlbmNvbnRyYWRvIHVuYSBkZSBsYShzKSBmdWVudGUocykgcm90YShzKSIgJSAoQ09MT1IxLCBuYW1lLCBDT0xPUjIpLCAiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgcGF0aCksICJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCB3b3JraW5nKSwgeWVzbGFiZWw9IltCXVtDT0xPUiBncmVlbl1FbGltaW5hciBmdWVudGVbL0NPTE9SXVsvQl0iLCBub2xhYmVsPSJbQl1bQ09MT1IgcmVkXU1hbnRlbmVyIGZ1ZW50ZVsvQ09MT1JdWy9CXSIpOgogICAgICAgICAgICAgICAgICAgICAgICByZW1vdmUuYXBwZW5kKFtuYW1lLCBwYXRoLCBzaGFyaW5nLCB3b3JraW5nXSkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nKCJSZW1vdmluZyBTb3VyY2UgJXMiICUgbmFtZSwgeGJtYy5MT0dOT1RJQ0UpCiAgICAgICAgICAgICAgICAgICAgZWxzZTogbG9nKCJTb3VyY2UgJXMgd2FzIG5vdCByZW1vdmVkIiAlIG5hbWUsIHhibWMuTE9HTk9USUNFKQogICAgICAgICAgICBpZiBsZW4ocmVtb3ZlKSA+IDA6CiAgICAgICAgICAgICAgICBmb3IgbmFtZSwgcGF0aCwgc2hhcmluZywgd29ya2luZyBpbiByZW1vdmU6IAogICAgICAgICAgICAgICAgICAgIGEgPSBhLnJlcGxhY2UoJ1xuICAgICAgICA8c291cmNlPlxuICAgICAgICAgICAgPG5hbWU+JXM8L25hbWU+XG4gICAgICAgICAgICA8cGF0aCBwYXRodmVyc2lvbj0iMSI+JXM8L3BhdGg+XG4gICAgICAgICAgICA8YWxsb3dzaGFyaW5nPiVzPC9hbGxvd3NoYXJpbmc+XG4gICAgICAgIDwvc291cmNlPicgJSAobmFtZSwgcGF0aCwgc2hhcmluZyksICcnKQogICAgICAgICAgICAgICAgICAgIGxvZygiUmVtb3ZpbmcgU291cmNlICVzIiAlIG5hbWUsIHhibWMuTE9HTk9USUNFKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmID0gb3BlbihTT1VSQ0VTLCBtb2RlPSd3JykKICAgICAgICAgICAgICAgIGYud3JpdGUoc3RyKGEpKQogICAgICAgICAgICAgICAgZi5jbG9zZSgpCiAgICAgICAgICAgICAgICBhbGl2ZSA9IGxlbihtYXRjaCkgLSBsZW4oYmFkKQogICAgICAgICAgICAgICAga2VwdCA9IGxlbihiYWQpIC0gbGVuKHJlbW92ZSkKICAgICAgICAgICAgICAgIHJlbW92ZWQgPSBsZW4ocmVtb3ZlKQogICAgICAgICAgICAgICAgRElBTE9HLm9rKEFERE9OVElUTEUsICJbQ09MT1IgJXNdRXNjYW5lYW5kbyBmdWVudGVzIHBhcmEgZW5jb250cmFyIGxpbmtzIHJvdG9zOiBjb21wbGV0YWRvIiAlIENPTE9SMiwgIkZ1bmNpb25hbmRvOiBbQ09MT1IgJXNdJXNbL0NPTE9SXSB8IE1hbnRlbmlkb3M6IFtDT0xPUiAlc10lc1svQ09MT1JdIHwgRWxpbWluYWRvczogW0NPTE9SICVzXSVzWy9DT0xPUl1bL0NPTE9SXSIgJSAoQ09MT1IyLCBDT0xPUjEsIGFsaXZlLCBDT0xPUjEsIGtlcHQsIENPTE9SMSwgcmVtb3ZlZCkpCiAgICAgICAgICAgIGVsc2U6IGxvZygiTm8gQmFkIFNvdXJjZXMgdG8gYmUgcmVtb3ZlZC4iLCB4Ym1jLkxPR05PVElDRSkKICAgICAgICBlbHNlOiBMb2dOb3RpZnkoIltDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIEFERE9OVElUTEUpLCAiW0NPTE9SICVzXVRvZGFzIGxhcyBmdWVudGVzIHNvbiBjb3JyZWN0YXNbL0NPTE9SXSIgJSBDT0xPUjIpCiAgICBlbHNlOiBsb2coIk5vIFNvdXJjZXMgRm91bmQiLCB4Ym1jLkxPR05PVElDRSkKCmRlZiBjaGVja1JlcG9zKCk6CiAgICBEUC5jcmVhdGUoQURET05USVRMRSwgJ1tDT0xPUiAlc11Db21wcm9iYW5kbyByZXBvc2l0b3Jpb3MuLi5bL0NPTE9SXScgJSBDT0xPUjIpCiAgICBiYWRyZXBvcyA9IFtdCiAgICBlYmkoJ1VwZGF0ZUFkZG9uUmVwb3MnKQogICAgcmVwb2xpc3QgPSBnbG9iLmdsb2Iob3MucGF0aC5qb2luKEFERE9OUywncmVwbyonKSkKICAgIGlmIGxlbihyZXBvbGlzdCkgPT0gMDoKICAgICAgICBEUC5jbG9zZSgpCiAgICAgICAgTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgIltDT0xPUiAlc11ObyBzZSBoYW4gZW5jb250cmFkbyByZXBvc2l0b3Jpb3MhWy9DT0xPUl0iICUgQ09MT1IyKQogICAgICAgIHJldHVybgogICAgc2xlZXB0aW1lID0gbGVuKHJlcG9saXN0KTsgc3RhcnQgPSAwOwogICAgd2hpbGUgc3RhcnQgPCBzbGVlcHRpbWU6CiAgICAgICAgc3RhcnQgKz0gMQogICAgICAgIGlmIERQLmlzY2FuY2VsZWQoKTogYnJlYWsKICAgICAgICBwZXJjID0gaW50KHBlcmNlbnRhZ2Uoc3RhcnQsIHNsZWVwdGltZSkpCiAgICAgICAgRFAudXBkYXRlKHBlcmMsICcnLCAnW0NPTE9SICVzXUNvbXByb2JhbmRvOiBbL0NPTE9SXVtDT0xPUiAlc10lc1svQ09MT1JdJyAlIChDT0xPUjIsIENPTE9SMSwgcmVwb2xpc3Rbc3RhcnQtMV0ucmVwbGFjZShBRERPTlMsICcnKVsxOl0pKQogICAgICAgIHhibWMuc2xlZXAoMTAwMCkKICAgIGlmIERQLmlzY2FuY2VsZWQoKTogCiAgICAgICAgRFAuY2xvc2UoKQogICAgICAgIExvZ05vdGlmeSgiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgQURET05USVRMRSksICJbQ09MT1IgJXNdQWN0aXZhciBBZGRvbnM6IENhbmNlbGFkb1svQ09MT1JdIiAlIENPTE9SMikKICAgICAgICBzeXMuZXhpdCgpCiAgICBEUC5jbG9zZSgpCiAgICBsb2dmaWxlID0gR3JhYl9Mb2coRmFsc2UpCiAgICBmYWlscyA9IHJlLmNvbXBpbGUoJ0NSZXBvc2l0b3J5VXBkYXRlSm9iKC4rPylmYWlsZWQnKS5maW5kYWxsKGxvZ2ZpbGUpCiAgICBmb3IgaXRlbSBpbiBmYWlsczoKICAgICAgICBsb2coIkJhZCBSZXBvc2l0b3J5OiAlcyAiICUgaXRlbSwgeGJtYy5MT0dOT1RJQ0UpCiAgICAgICAgYnJva2VucmVwbyA9IGl0ZW0ucmVwbGFjZSgnWycsJycpLnJlcGxhY2UoJ10nLCcnKS5yZXBsYWNlKCcgJywnJykucmVwbGFjZSgnLycsJycpLnJlcGxhY2UoJ1xcJywnJykKICAgICAgICBpZiBub3QgYnJva2VucmVwbyBpbiBiYWRyZXBvczoKICAgICAgICAgICAgYmFkcmVwb3MuYXBwZW5kKGJyb2tlbnJlcG8pCiAgICBpZiBsZW4oYmFkcmVwb3MpID4gMDoKICAgICAgICBtc2cgID0gIltDT0xPUiAlc11Fc3RvIGVzIHVuYSBsaXN0YSBkZSByZXBvc2l0b3Jpb3MgcXVlIG5vIGZ1bmNpb25hbi4gRXNvIG5vIHNpZ25pZmljYSBxdWUgZXN0ZW4gcm90b3MsIHlhIHF1ZSBhbGd1bmFzIHZlY2VzIGRlIGZvcm1hIHB1bnR1YWwgcHVlZGUgZGVqYXIgZGUgZnVuY2lvbmFyIGVsIHNlcnZpZG9yIGRvbmRlIHNlIGFsb2phbi4gUG9yIGZhdm9yLCBoYXogdmFyaWFzIGNvbXByb2JhY2lvbmVzIGFudGVzIGRlIGVsaW1pbmFybG9zIHBhcmEgYXNlZ3VyYXJ0ZSBxdWUgZXN0YW4gcm90b3MuWy9DT0xPUl1bQ1JdW0NSXVtDT0xPUiAlc10iICUgKENPTE9SMiwgQ09MT1IxKQogICAgICAgIG1zZyArPSAnW0NSXScuam9pbihiYWRyZXBvcykKICAgICAgICBtc2cgKz0gJ1svQ09MT1JdJwogICAgICAgIFRleHRCb3goIiVzOiBSZXBvc2l0b3Jpb3Mgbm8gZnVuY2lvbmFsZXMiICUgQURET05USVRMRSwgbXNnKQogICAgZWxzZTogCiAgICAgICAgTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgIltDT0xPUiAlc11Ub2RvcyBsb3MgcmVwb3NpdG9yaW9zIGZ1bmNpb25hbmRvIVsvQ09MT1JdIiAlIENPTE9SMikKCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMjIyMgTUFUQVIgS09ESSAjIyMjIyMjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCgpkZWYga2lsbHhibWMob3Zlcj1Ob25lKToKICAgIGlmIG92ZXI6IGNob2ljZSA9IDEKICAgIGVsc2U6IGNob2ljZSA9IERJQUxPRy55ZXNubygnRm96YXIgY2llcnJlIGRlIEtvZGknLCAnW0NPTE9SICVzXVZhcyBhIGNlcnJhciBLb2RpJyAlIENPTE9SMiwgJ1F1aWVyZXMgY29udGludWFyP1svQ09MT1JdJywgbm9sYWJlbD0nW0JdW0NPTE9SIHJlZF1ObywgQ2FuY2VsWy9DT0xPUl1bL0JdJyx5ZXNsYWJlbD0nW0JdW0NPTE9SIGdyZWVuXUZvcnphciBjaWVycmVbL0NPTE9SXVsvQl0nKQogICAgaWYgY2hvaWNlID09IDE6CiAgICAgICAgbG9nKCJGb3JjZSBDbG9zaW5nIEtvZGk6IFBsYXRmb3JtWyVzXSIgJSBzdHIocGxhdGZvcm0oKSksIHhibWMuTE9HTk9USUNFKQogICAgICAgIG9zLl9leGl0KDEpCgpkZWYgcmVkb1RodW1icygpOgogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKFRIVU1CUyk6IG9zLm1ha2VkaXJzKFRIVU1CUykKICAgIHRodW1iZm9sZGVycyA9ICcwMTIzNDU2Nzg5YWJjZGVmJwogICAgdmlkZW9zID0gb3MucGF0aC5qb2luKFRIVU1CUywgJ1ZpZGVvJywgJ0Jvb2ttYXJrcycpCiAgICBmb3IgaXRlbSBpbiB0aHVtYmZvbGRlcnM6CiAgICAgICAgZm9sZG5hbWUgPSBvcy5wYXRoLmpvaW4oVEhVTUJTLCBpdGVtKQogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmb2xkbmFtZSk6IG9zLm1ha2VkaXJzKGZvbGRuYW1lKQogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKHZpZGVvcyk6IG9zLm1ha2VkaXJzKHZpZGVvcykKCmRlZiByZWxvYWRGaXgoZGVmYXVsdD1Ob25lKToKICAgIERJQUxPRy5vayhBRERPTlRJVExFLCAiW0NPTE9SICVzXUFWSVNPOiBBIHZlY2VzIGFsIHJlY2FyZ2FyIGVsIHBlcmZpbCwgS29kaSBzZSBjaWVycmEuICBNaWVudHJhcyBLb2RpIHJlY2FyZ2EgZWwgcGVmaWwsIHBvciBmYXZvciwgbm8gdG9xdWVzIG5pbmd1biBib3RvbiFbL0NPTE9SXSIgJSBDT0xPUjIpCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoUEFDS0FHRVMpOiBvcy5tYWtlZGlycyhQQUNLQUdFUykKICAgIGlmIGRlZmF1bHQgPT0gTm9uZToKICAgICAgICBsb29rYW5kRmVlbERhdGEoJ3NhdmUnKQogICAgcmVkb1RodW1icygpCiAgICBlYmkoJ0FjdGl2YXRlV2luZG93KEhvbWUpJykKICAgIHJlbG9hZFByb2ZpbGUoKQogICAgeGJtYy5zbGVlcCgxMDAwMCkKICAgIGlmIEtPRElWID49IDE3OiBrb2RpMTdGaXgoKQogICAgaWYgZGVmYXVsdCA9PSBOb25lOgogICAgICAgIGxvZygiU3dpdGNoaW5nIHRvOiAlcyIgJSBnZXRTKCdkZWZhdWx0c2tpbicpKQogICAgICAgIGdvdG9za2luID0gZ2V0UygnZGVmYXVsdHNraW4nKQogICAgICAgIHNraW5Td2l0Y2guc3dhcFNraW5zKGdvdG9za2luKQogICAgICAgIHggPSAwCiAgICAgICAgd2hpbGUgbm90IHhibWMuZ2V0Q29uZFZpc2liaWxpdHkoIldpbmRvdy5pc1Zpc2libGUoeWVzbm9kaWFsb2cpIikgYW5kIHggPCAxNTA6CiAgICAgICAgICAgIHggKz0gMQogICAgICAgICAgICB4Ym1jLnNsZWVwKDIwMCkKICAgICAgICBpZiB4Ym1jLmdldENvbmRWaXNpYmlsaXR5KCJXaW5kb3cuaXNWaXNpYmxlKHllc25vZGlhbG9nKSIpOgogICAgICAgICAgICBlYmkoJ1NlbmRDbGljaygxMSknKQogICAgICAgIGxvb2thbmRGZWVsRGF0YSgncmVzdG9yZScpCiAgICBhZGRvblVwZGF0ZXMoJ3Jlc2V0JykKICAgIGZvcmNlVXBkYXRlKCkKICAgIGViaSgiUmVsb2FkU2tpbigpIikKCmRlZiBza2luVG9EZWZhdWx0KCk6CiAgICBpZiBub3QgY3VyclNraW4oKSBpbiBbJ3NraW4uY29uZmx1ZW5jZScsICdza2luLmVzdHVhcnknXToKICAgICAgICBza2luID0gJ3NraW4uY29uZmx1ZW5jZScgaWYgS09ESVYgPCAxNyBlbHNlICdza2luLmVzdHVhcnknCiAgICBzd2FwU2tpbnMoc2tpbikKCmRlZiBzd2FwU2tpbnMoZ290byk6CiAgICBza2luU3dpdGNoLnN3YXBTa2lucyhnb3RvKQogICAgeCA9IDAKICAgIHhibWMuc2xlZXAoMTAwMCkKICAgIHdoaWxlIG5vdCB4Ym1jLmdldENvbmRWaXNpYmlsaXR5KCJXaW5kb3cuaXNWaXNpYmxlKHllc25vZGlhbG9nKSIpIGFuZCB4IDwgMTUwOgogICAgICAgIHggKz0gMQogICAgICAgIHhibWMuc2xlZXAoMTAwKQogICAgICAgIGViaSgnU2VuZEFjdGlvbihTZWxlY3QpJykKICAgIAogICAgaWYgeGJtYy5nZXRDb25kVmlzaWJpbGl0eSgiV2luZG93LmlzVmlzaWJsZSh5ZXNub2RpYWxvZykiKToKICAgICAgICBlYmkoJ1NlbmRDbGljaygxMSknKQogICAgZWxzZTogTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgJ1tDT0xPUiAlc11JbnN0YWxhY2lvbiBsaW1waWE6IFRpZW1wbyBwYXJhIGNhbWJpYXIgbGEgc2tpbiBhZ290YWRvIVsvQ09MT1JdJyAlIENPTE9SMik7IHJldHVybiBGYWxzZQogICAgeGJtYy5zbGVlcCg1MDApCgpkZWYgbWVkaWFDZW50ZXIoKToKICAgIGlmIHN0cihIT01FKS5sb3dlcigpLmZpbmQoJ2tvZGknKToKICAgICAgICByZXR1cm4gJ0tvZGknCiAgICBlbGlmIHN0cihIT01FKS5sb3dlcigpLmZpbmQoJ3NwbWMnKToKICAgICAgICByZXR1cm4gJ1NQTUMnCiAgICBlbHNlOiAKICAgICAgICByZXR1cm4gJ1Vua25vd24gRm9yaycKCmRlZiBrb2RpMTdGaXgoKToKICAgIGFkZG9ubGlzdCA9IGdsb2IuZ2xvYihvcy5wYXRoLmpvaW4oQURET05TLCAnKi8nKSkKICAgIGRpc2FibGVkQWRkb25zID0gW10KICAgIGZvciBmb2xkZXIgaW4gc29ydGVkKGFkZG9ubGlzdCwga2V5ID0gbGFtYmRhIHg6IHgpOgogICAgICAgIGFkZG9ueG1sID0gb3MucGF0aC5qb2luKGZvbGRlciwgJ2FkZG9uLnhtbCcpCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoYWRkb254bWwpOgogICAgICAgICAgICBmb2xkICAgPSBmb2xkZXIucmVwbGFjZShBRERPTlMsICcnKVsxOi0xXQogICAgICAgICAgICBmICAgICAgPSBvcGVuKGFkZG9ueG1sKQogICAgICAgICAgICBhICAgICAgPSBmLnJlYWQoKQogICAgICAgICAgICBhaWQgICAgPSBwYXJzZURPTShhLCAnYWRkb24nLCByZXQ9J2lkJykKICAgICAgICAgICAgZi5jbG9zZSgpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGFkZCAgICA9IHhibWNhZGRvbi5BZGRvbihpZD1haWRbMF0pCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBsb2coIiVzIHdhcyBkaXNhYmxlZCIgJSBhaWRbMF0sIHhibWMuTE9HREVCVUcpCiAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWRBZGRvbnMuYXBwZW5kKGFpZFswXSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZygiJXMgd2FzIGRpc2FibGVkIiAlIGZvbGQsIHhibWMuTE9HREVCVUcpCiAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkQWRkb25zLmFwcGVuZChmb2xkKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKGFpZCkgPT0gMDogbG9nKCJJbXBvc2libGUgYWN0aXZhcjogJXMoTm8gc2UgcHVlZGUgZGV0ZXJtaW5hciBlbCBBZGRvbiBJRCkiICUgZm9sZCwgeGJtYy5MT0dFUlJPUikKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZTogbG9nKCJVbmFibGVkIHRvIGVuYWJsZTogJXMiICUgZm9sZGVyLCB4Ym1jLkxPR0VSUk9SKQogICAgaWYgbGVuKGRpc2FibGVkQWRkb25zKSA+IDA6CiAgICAgICAgeCA9IDAKICAgICAgICBEUC5jcmVhdGUoQURET05USVRMRSwnW0NPTE9SICVzXUFjdGl2YW5kbyBhZGRvbnMgZGVzYWN0aXZhZG9zJyAlIENPTE9SMiwnJywgJ1BvciBmYXZvciwgZXNwZXJlWy9DT0xPUl0nKQogICAgICAgIGZvciBpdGVtIGluIGRpc2FibGVkQWRkb25zOgogICAgICAgICAgICB4ICs9IDEKICAgICAgICAgICAgcHJvZyA9IGludChwZXJjZW50YWdlKHgsIGxlbihkaXNhYmxlZEFkZG9ucykpKQogICAgICAgICAgICBEUC51cGRhdGUocHJvZywgIiIsICJBY3RpdmFuZG86IFtDT0xPUiAlc10lc1svQ09MT1JdIiAlIChDT0xPUjEsIGl0ZW0pKQogICAgICAgICAgICBhZGRvbkRhdGFiYXNlKGl0ZW0sIDEpCiAgICAgICAgICAgIGlmIERQLmlzY2FuY2VsZWQoKTogYnJlYWsKICAgICAgICBpZiBEUC5pc2NhbmNlbGVkKCk6IAogICAgICAgICAgICBEUC5jbG9zZSgpCiAgICAgICAgICAgIExvZ05vdGlmeSgiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgQURET05USVRMRSksICJbQ09MT1IgJXNdQWN0aXZhbmRvIGFkZG9ucyBkZXNhY3RpdmFkb3M6IENhbmNlbGFkbyFbL0NPTE9SXSIgJSBDT0xPUjIpCiAgICAgICAgICAgIHN5cy5leGl0KCkKICAgICAgICBEUC5jbG9zZSgpCiAgICBmb3JjZVVwZGF0ZSgpCiAgICBlYmkoIlJlbG9hZFNraW4oKSIpCgpkZWYgYWRkb25EYXRhYmFzZShhZGRvbj1Ob25lLCBzdGF0ZT0xKToKICAgIGRiZmlsZSA9IGxhdGVzdERCKCdBZGRvbnMnKQogICAgZGJmaWxlID0gb3MucGF0aC5qb2luKERBVEFCQVNFLCBkYmZpbGUpCiAgICBpbnN0YWxsZWR0aW1lID0gc3RyKGRhdGV0aW1lLm5vdygpKVs6LTddCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhkYmZpbGUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgdGV4dGRiID0gZGF0YWJhc2UuY29ubmVjdChkYmZpbGUpCiAgICAgICAgICAgIHRleHRleGUgPSB0ZXh0ZGIuY3Vyc29yKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uLCBlOgogICAgICAgICAgICBsb2coIkRCIENvbm5lY3Rpb24gRXJyb3I6ICVzIiAlIHN0cihlKSwgeGJtYy5MT0dFUlJPUikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICBlbHNlOiByZXR1cm4gRmFsc2UKICAgIGlmIHN0YXRlID09IDI6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB0ZXh0ZXhlLmV4ZWN1dGUoIkRFTEVURSBGUk9NIGluc3RhbGxlZCBXSEVSRSBhZGRvbklEID0gPyIsIChhZGRvbiwpKQogICAgICAgICAgICB0ZXh0ZGIuY29tbWl0KCkKICAgICAgICAgICAgdGV4dGV4ZS5jbG9zZSgpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiwgZToKICAgICAgICAgICAgbG9nKCJFcnJvciBSZW1vdmluZyAlcyBmcm9tIERCIiAlIGFkZG9uKQogICAgICAgIHJldHVybiBUcnVlCiAgICB0cnk6CiAgICAgICAgdGV4dGV4ZS5leGVjdXRlKCJTRUxFQ1QgaWQsIGFkZG9uSUQsIGVuYWJsZWQgRlJPTSBpbnN0YWxsZWQgV0hFUkUgYWRkb25JRCA9ID8iLCAoYWRkb24sKSkKICAgICAgICBmb3VuZCA9IHRleHRleGUuZmV0Y2hvbmUoKQogICAgICAgIGlmIGZvdW5kID09IE5vbmU6CiAgICAgICAgICAgIHRleHRleGUuZXhlY3V0ZSgnSU5TRVJUIElOVE8gaW5zdGFsbGVkIChhZGRvbklEICwgZW5hYmxlZCwgaW5zdGFsbERhdGUpIFZBTFVFUyAoPyw/LD8pJywgKGFkZG9uLCBzdGF0ZSwgaW5zdGFsbGVkdGltZSwpKQogICAgICAgICAgICBsb2coIkluc2VydCAlcyBpbnRvIGRiIiAlIGFkZG9uKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRpZCwgdGFkZG9uaWQsIHRlbmFibGVkID0gZm91bmQKICAgICAgICAgICAgdGV4dGV4ZS5leGVjdXRlKCdVUERBVEUgaW5zdGFsbGVkIFNFVCBlbmFibGVkID0gPyBXSEVSRSBpZCA9ID8gJywgKHN0YXRlLCB0aWQsKSkKICAgICAgICAgICAgbG9nKCJVcGRhdGVkICVzIGluIGRiIiAlIGFkZG9uKQogICAgICAgIHRleHRkYi5jb21taXQoKQogICAgICAgIHRleHRleGUuY2xvc2UoKQogICAgZXhjZXB0IEV4Y2VwdGlvbiwgZToKICAgICAgICBsb2coIkVycm9yaW5nIGVuYWJsaW5nIGFkZG9uOiAlcyIgJSBhZGRvbikKCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIFBVUkdBUiBCQVNFIERFIERBVE9TICMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCmRlZiBwdXJnZURiKG5hbWUpOgogICAgI2RiZmlsZSA9IG5hbWUucmVwbGFjZSgnLmRiJywnJykudHJhbnNsYXRlKE5vbmUsIGRpZ2l0cykKICAgICNpZiBkYmZpbGUgbm90IGluIFsnQWRkb25zJywgJ0FEU1AnLCAnRXBnJywgJ015TXVzaWMnLCAnTXlWaWRlb3MnLCAnVGV4dHVyZXMnLCAnVFYnLCAnVmlld01vZGVzJ106IHJldHVybiBGYWxzZQogICAgI3RleHRmaWxlID0gb3MucGF0aC5qb2luKERBVEFCQVNFLCBuYW1lKQogICAgbG9nKCdQdXJnaW5nIERCICVzLicgJSBuYW1lLCB4Ym1jLkxPR05PVElDRSkKICAgIGlmIG9zLnBhdGguZXhpc3RzKG5hbWUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgdGV4dGRiID0gZGF0YWJhc2UuY29ubmVjdChuYW1lKQogICAgICAgICAgICB0ZXh0ZXhlID0gdGV4dGRiLmN1cnNvcigpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiwgZToKICAgICAgICAgICAgbG9nKCJEQiBDb25uZWN0aW9uIEVycm9yOiAlcyIgJSBzdHIoZSksIHhibWMuTE9HRVJST1IpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgZWxzZTogbG9nKCclcyBub3QgZm91bmQuJyAlIG5hbWUsIHhibWMuTE9HRVJST1IpOyByZXR1cm4gRmFsc2UKICAgIHRleHRleGUuZXhlY3V0ZSgiU0VMRUNUIG5hbWUgRlJPTSBzcWxpdGVfbWFzdGVyIFdIRVJFIHR5cGUgPSAndGFibGUnIikKICAgIGZvciB0YWJsZSBpbiB0ZXh0ZXhlLmZldGNoYWxsKCk6CiAgICAgICAgaWYgdGFibGVbMF0gPT0gJ3ZlcnNpb24nOiAKICAgICAgICAgICAgbG9nKCdEYXRhIGZyb20gdGFibGUgYCVzYCBza2lwcGVkLicgJSB0YWJsZVswXSwgeGJtYy5MT0dERUJVRykKICAgICAgICBlbHNlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB0ZXh0ZXhlLmV4ZWN1dGUoIkRFTEVURSBGUk9NICVzIiAlIHRhYmxlWzBdKQogICAgICAgICAgICAgICAgdGV4dGRiLmNvbW1pdCgpCiAgICAgICAgICAgICAgICBsb2coJ0RhdGEgZnJvbSB0YWJsZSBgJXNgIGNsZWFyZWQuJyAlIHRhYmxlWzBdLCB4Ym1jLkxPR0RFQlVHKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uLCBlOiBsb2coIkRCIFJlbW92ZSBUYWJsZSBgJXNgIEVycm9yOiAlcyIgJSAodGFibGVbMF0sIHN0cihlKSksIHhibWMuTE9HRVJST1IpCiAgICB0ZXh0ZXhlLmNsb3NlKCkKICAgIGxvZygnJXMgREIgUHVyZ2luZyBDb21wbGV0ZS4nICUgbmFtZSwgeGJtYy5MT0dOT1RJQ0UpCiAgICBzaG93ID0gbmFtZS5yZXBsYWNlKCdcXCcsICcvJykuc3BsaXQoJy8nKQogICAgTG9nTm90aWZ5KCJbQ09MT1IgJXNdUHVyZ2EgZGUgQmFzZSBkZSBkYXRvc1svQ09MT1JdIiAlIENPTE9SMSwgIltDT0xPUiAlc10lcyBDb21wbGV0YWRvWy9DT0xPUl0iICUgKENPTE9SMiwgc2hvd1tsZW4oc2hvdyktMV0pKQoKZGVmIG9sZFRodW1icygpOgogICAgZGJmaWxlID0gb3MucGF0aC5qb2luKERBVEFCQVNFLCBsYXRlc3REQignVGV4dHVyZXMnKSkKICAgIHVzZSAgICA9IDEwCiAgICB3ZWVrICAgPSBUT0RBWSAtIHRpbWVkZWx0YShkYXlzPTcpCiAgICBpZHMgICAgPSBbXQogICAgaW1hZ2VzID0gW10KICAgIHNpemUgICA9IDAKICAgIGlmIG9zLnBhdGguZXhpc3RzKGRiZmlsZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB0ZXh0ZGIgPSBkYXRhYmFzZS5jb25uZWN0KGRiZmlsZSkKICAgICAgICAgICAgdGV4dGV4ZSA9IHRleHRkYi5jdXJzb3IoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24sIGU6CiAgICAgICAgICAgIGxvZygiREIgQ29ubmVjdGlvbiBFcnJvcjogJXMiICUgc3RyKGUpLCB4Ym1jLkxPR0VSUk9SKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIGVsc2U6IGxvZygnJXMgbm90IGZvdW5kLicgJSBkYmZpbGUsIHhibWMuTE9HRVJST1IpOyByZXR1cm4gRmFsc2UKICAgIHRleHRleGUuZXhlY3V0ZSgiU0VMRUNUIGlkdGV4dHVyZSBGUk9NIHNpemVzIFdIRVJFIHVzZWNvdW50IDwgPyBBTkQgbGFzdHVzZXRpbWUgPCA/IiwgKHVzZSwgc3RyKHdlZWspKSkKICAgIGZvdW5kID0gdGV4dGV4ZS5mZXRjaGFsbCgpCiAgICBmb3Igcm93cyBpbiBmb3VuZDoKICAgICAgICBpZGZvdW5kID0gcm93c1swXQogICAgICAgIGlkcy5hcHBlbmQoaWRmb3VuZCkKICAgICAgICB0ZXh0ZXhlLmV4ZWN1dGUoIlNFTEVDVCBjYWNoZWR1cmwgRlJPTSB0ZXh0dXJlIFdIRVJFIGlkID0gPyIsIChpZGZvdW5kLCApKQogICAgICAgIGZvdW5kMiA9IHRleHRleGUuZmV0Y2hhbGwoKQogICAgICAgIGZvciByb3dzMiBpbiBmb3VuZDI6CiAgICAgICAgICAgIGltYWdlcy5hcHBlbmQocm93czJbMF0pCiAgICBsb2coIiVzIHRvdGFsIHRodW1icyBjbGVhbmVkIHVwLiIgJSBzdHIobGVuKGltYWdlcykpLCB4Ym1jLkxPR05PVElDRSkKICAgIGZvciBpZCBpbiBpZHM6ICAgICAgIAogICAgICAgIHRleHRleGUuZXhlY3V0ZSgiREVMRVRFIEZST00gc2l6ZXMgICBXSEVSRSBpZHRleHR1cmUgPSA/IiwgKGlkLCApKQogICAgICAgIHRleHRleGUuZXhlY3V0ZSgiREVMRVRFIEZST00gdGV4dHVyZSBXSEVSRSBpZCAgICAgICAgPSA/IiwgKGlkLCApKQogICAgdGV4dGV4ZS5leGVjdXRlKCJWQUNVVU0iKQogICAgdGV4dGRiLmNvbW1pdCgpCiAgICB0ZXh0ZXhlLmNsb3NlKCkKICAgIGZvciBpbWFnZSBpbiBpbWFnZXM6CiAgICAgICAgcGF0aCA9IG9zLnBhdGguam9pbihUSFVNQlMsIGltYWdlKQogICAgICAgIHRyeToKICAgICAgICAgICAgaW1hZ2VzaXplID0gb3MucGF0aC5nZXRzaXplKHBhdGgpCiAgICAgICAgICAgIG9zLnJlbW92ZShwYXRoKQogICAgICAgICAgICBzaXplICs9IGltYWdlc2l6ZQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwogICAgcmVtb3ZlZCA9IGNvbnZlcnRTaXplKHNpemUpCiAgICBpZiBsZW4oaW1hZ2VzKSA+IDA6IExvZ05vdGlmeSgiW0NPTE9SICVzXSVzWy9DT0xPUl0iICUgKENPTE9SMSwgQURET05USVRMRSksICdbQ09MT1IgJXNdTGltcGlhciBtaW5pYXR1cmFzOiAlcyBBcmNoaXZvcyAvICVzIE1CWy9DT0xPUl0hJyAlIChDT0xPUjIsIHN0cihsZW4oaW1hZ2VzKSksIHJlbW92ZWQpKQogICAgZWxzZTogTG9nTm90aWZ5KCJbQ09MT1IgJXNdJXNbL0NPTE9SXSIgJSAoQ09MT1IxLCBBRERPTlRJVExFKSwgJ1tDT0xPUiAlc11MaW1waWFyIG1pbmlhdHVyYXM6IE5vIHNlIGhhIGVuY29udHJhZG8gbmluZ3VubyFbL0NPTE9SXScgJSBDT0xPUjIpCgpkZWYgcGFyc2VET00oaHRtbCwgbmFtZT11IiIsIGF0dHJzPXt9LCByZXQ9RmFsc2UpOgoKICAgIGlmIGlzaW5zdGFuY2UoaHRtbCwgc3RyKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGh0bWwgPSBbaHRtbC5kZWNvZGUoInV0Zi04IildCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBodG1sID0gW2h0bWxdCiAgICBlbGlmIGlzaW5zdGFuY2UoaHRtbCwgdW5pY29kZSk6CiAgICAgICAgaHRtbCA9IFtodG1sXQogICAgZWxpZiBub3QgaXNpbnN0YW5jZShodG1sLCBsaXN0KToKICAgICAgICByZXR1cm4gdSIiCgogICAgaWYgbm90IG5hbWUuc3RyaXAoKToKICAgICAgICByZXR1cm4gdSIiCgogICAgcmV0X2xzdCA9IFtdCiAgICBmb3IgaXRlbSBpbiBodG1sOgogICAgICAgIHRlbXBfaXRlbSA9IHJlLmNvbXBpbGUoJyg8W14+XSo/XG5bXj5dKj8+KScpLmZpbmRhbGwoaXRlbSkKICAgICAgICBmb3IgbWF0Y2ggaW4gdGVtcF9pdGVtOgogICAgICAgICAgICBpdGVtID0gaXRlbS5yZXBsYWNlKG1hdGNoLCBtYXRjaC5yZXBsYWNlKCJcbiIsICIgIikpCgogICAgICAgIGxzdCA9IFtdCiAgICAgICAgZm9yIGtleSBpbiBhdHRyczoKICAgICAgICAgICAgbHN0MiA9IHJlLmNvbXBpbGUoJyg8JyArIG5hbWUgKyAnW14+XSo/KD86JyArIGtleSArICc9W1wnIl0nICsgYXR0cnNba2V5XSArICdbXCciXS4qPz4pKScsIHJlLk0gfCByZS5TKS5maW5kYWxsKGl0ZW0pCiAgICAgICAgICAgIGlmIGxlbihsc3QyKSA9PSAwIGFuZCBhdHRyc1trZXldLmZpbmQoIiAiKSA9PSAtMToKICAgICAgICAgICAgICAgIGxzdDIgPSByZS5jb21waWxlKCcoPCcgKyBuYW1lICsgJ1tePl0qPyg/OicgKyBrZXkgKyAnPScgKyBhdHRyc1trZXldICsgJy4qPz4pKScsIHJlLk0gfCByZS5TKS5maW5kYWxsKGl0ZW0pCgogICAgICAgICAgICBpZiBsZW4obHN0KSA9PSAwOgogICAgICAgICAgICAgICAgbHN0ID0gbHN0MgogICAgICAgICAgICAgICAgbHN0MiA9IFtdCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB0ZXN0ID0gcmFuZ2UobGVuKGxzdCkpCiAgICAgICAgICAgICAgICB0ZXN0LnJldmVyc2UoKQogICAgICAgICAgICAgICAgZm9yIGkgaW4gdGVzdDoKICAgICAgICAgICAgICAgICAgICBpZiBub3QgbHN0W2ldIGluIGxzdDI6CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbChsc3RbaV0pCgogICAgICAgIGlmIGxlbihsc3QpID09IDAgYW5kIGF0dHJzID09IHt9OgogICAgICAgICAgICBsc3QgPSByZS5jb21waWxlKCcoPCcgKyBuYW1lICsgJz4pJywgcmUuTSB8IHJlLlMpLmZpbmRhbGwoaXRlbSkKICAgICAgICAgICAgaWYgbGVuKGxzdCkgPT0gMDoKICAgICAgICAgICAgICAgIGxzdCA9IHJlLmNvbXBpbGUoJyg8JyArIG5hbWUgKyAnIC4qPz4pJywgcmUuTSB8IHJlLlMpLmZpbmRhbGwoaXRlbSkKCiAgICAgICAgaWYgaXNpbnN0YW5jZShyZXQsIHN0cik6CiAgICAgICAgICAgIGxzdDIgPSBbXQogICAgICAgICAgICBmb3IgbWF0Y2ggaW4gbHN0OgogICAgICAgICAgICAgICAgYXR0cl9sc3QgPSByZS5jb21waWxlKCc8JyArIG5hbWUgKyAnLio/JyArIHJldCArICc9KFtcJyJdLltePl0qP1tcJyJdKT4nLCByZS5NIHwgcmUuUykuZmluZGFsbChtYXRjaCkKICAgICAgICAgICAgICAgIGlmIGxlbihhdHRyX2xzdCkgPT0gMDoKICAgICAgICAgICAgICAgICAgICBhdHRyX2xzdCA9IHJlLmNvbXBpbGUoJzwnICsgbmFtZSArICcuKj8nICsgcmV0ICsgJz0oLltePl0qPyk+JywgcmUuTSB8IHJlLlMpLmZpbmRhbGwobWF0Y2gpCiAgICAgICAgICAgICAgICBmb3IgdG1wIGluIGF0dHJfbHN0OgogICAgICAgICAgICAgICAgICAgIGNvbnRfY2hhciA9IHRtcFswXQogICAgICAgICAgICAgICAgICAgIGlmIGNvbnRfY2hhciBpbiAiJ1wiIjoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wLmZpbmQoJz0nICsgY29udF9jaGFyLCB0bXAuZmluZChjb250X2NoYXIsIDEpKSA+IC0xOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gdG1wWzp0bXAuZmluZCgnPScgKyBjb250X2NoYXIsIHRtcC5maW5kKGNvbnRfY2hhciwgMSkpXQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdG1wLnJmaW5kKGNvbnRfY2hhciwgMSkgPiAtMToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcCA9IHRtcFsxOnRtcC5yZmluZChjb250X2NoYXIpXQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRtcC5maW5kKCIgIikgPiAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gdG1wWzp0bXAuZmluZCgiICIpXQogICAgICAgICAgICAgICAgICAgICAgICBlbGlmIHRtcC5maW5kKCIvIikgPiAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gdG1wWzp0bXAuZmluZCgiLyIpXQogICAgICAgICAgICAgICAgICAgICAgICBlbGlmIHRtcC5maW5kKCI+IikgPiAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gdG1wWzp0bXAuZmluZCgiPiIpXQoKICAgICAgICAgICAgICAgICAgICBsc3QyLmFwcGVuZCh0bXAuc3RyaXAoKSkKICAgICAgICAgICAgbHN0ID0gbHN0MgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxzdDIgPSBbXQogICAgICAgICAgICBmb3IgbWF0Y2ggaW4gbHN0OgogICAgICAgICAgICAgICAgZW5kc3RyID0gdSI8LyIgKyBuYW1lCgogICAgICAgICAgICAgICAgc3RhcnQgPSBpdGVtLmZpbmQobWF0Y2gpCiAgICAgICAgICAgICAgICBlbmQgPSBpdGVtLmZpbmQoZW5kc3RyLCBzdGFydCkKICAgICAgICAgICAgICAgIHBvcyA9IGl0ZW0uZmluZCgiPCIgKyBuYW1lLCBzdGFydCArIDEgKQoKICAgICAgICAgICAgICAgIHdoaWxlIHBvcyA8IGVuZCBhbmQgcG9zICE9IC0xOgogICAgICAgICAgICAgICAgICAgIHRlbmQgPSBpdGVtLmZpbmQoZW5kc3RyLCBlbmQgKyBsZW4oZW5kc3RyKSkKICAgICAgICAgICAgICAgICAgICBpZiB0ZW5kICE9IC0xOgogICAgICAgICAgICAgICAgICAgICAgICBlbmQgPSB0ZW5kCiAgICAgICAgICAgICAgICAgICAgcG9zID0gaXRlbS5maW5kKCI8IiArIG5hbWUsIHBvcyArIDEpCgogICAgICAgICAgICAgICAgaWYgc3RhcnQgPT0gLTEgYW5kIGVuZCA9PSAtMToKICAgICAgICAgICAgICAgICAgICB0ZW1wID0gdSIiCiAgICAgICAgICAgICAgICBlbGlmIHN0YXJ0ID4gLTEgYW5kIGVuZCA+IC0xOgogICAgICAgICAgICAgICAgICAgIHRlbXAgPSBpdGVtW3N0YXJ0ICsgbGVuKG1hdGNoKTplbmRdCiAgICAgICAgICAgICAgICBlbGlmIGVuZCA+IC0xOgogICAgICAgICAgICAgICAgICAgIHRlbXAgPSBpdGVtWzplbmRdCiAgICAgICAgICAgICAgICBlbGlmIHN0YXJ0ID4gLTE6CiAgICAgICAgICAgICAgICAgICAgdGVtcCA9IGl0ZW1bc3RhcnQgKyBsZW4obWF0Y2gpOl0KCiAgICAgICAgICAgICAgICBpZiByZXQ6CiAgICAgICAgICAgICAgICAgICAgZW5kc3RyID0gaXRlbVtlbmQ6aXRlbS5maW5kKCI+IiwgaXRlbS5maW5kKGVuZHN0cikpICsgMV0KICAgICAgICAgICAgICAgICAgICB0ZW1wID0gbWF0Y2ggKyB0ZW1wICsgZW5kc3RyCgogICAgICAgICAgICAgICAgaXRlbSA9IGl0ZW1baXRlbS5maW5kKHRlbXAsIGl0ZW0uZmluZChtYXRjaCkpICsgbGVuKHRlbXApOl0KICAgICAgICAgICAgICAgIGxzdDIuYXBwZW5kKHRlbXApCiAgICAgICAgICAgIGxzdCA9IGxzdDIKICAgICAgICByZXRfbHN0ICs9IGxzdAoKICAgIHJldHVybiByZXRfbHN0CgoKZGVmIHJlcGxhY2VIVE1MQ29kZXModHh0KToKICAgIHR4dCA9IHJlLnN1YigiKCYjWzAtOV0rKShbXjteMC05XSspIiwgIlxcMTtcXDIiLCB0eHQpCiAgICB0eHQgPSBIVE1MUGFyc2VyLkhUTUxQYXJzZXIoKS51bmVzY2FwZSh0eHQpCiAgICB0eHQgPSB0eHQucmVwbGFjZSgiJnF1b3Q7IiwgIlwiIikKICAgIHR4dCA9IHR4dC5yZXBsYWNlKCImYW1wOyIsICImIikKICAgIHJldHVybiB0eHQKCmltcG9ydCBvcwpmcm9tIHNodXRpbCBpbXBvcnQgKgpkZWYgY29weXRyZWUoc3JjLCBkc3QsIHN5bWxpbmtzPUZhbHNlLCBpZ25vcmU9Tm9uZSk6CiAgICBuYW1lcyA9IG9zLmxpc3RkaXIoc3JjKQogICAgaWYgaWdub3JlIGlzIG5vdCBOb25lOgogICAgICAgIGlnbm9yZWRfbmFtZXMgPSBpZ25vcmUoc3JjLCBuYW1lcykKICAgIGVsc2U6CiAgICAgICAgaWdub3JlZF9uYW1lcyA9IHNldCgpCiAgICBpZiBub3Qgb3MucGF0aC5pc2Rpcihkc3QpOgogICAgICAgIG9zLm1ha2VkaXJzKGRzdCkKICAgIGVycm9ycyA9IFtdCiAgICBmb3IgbmFtZSBpbiBuYW1lczoKICAgICAgICBpZiBuYW1lIGluIGlnbm9yZWRfbmFtZXM6CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgc3JjbmFtZSA9IG9zLnBhdGguam9pbihzcmMsIG5hbWUpCiAgICAgICAgZHN0bmFtZSA9IG9zLnBhdGguam9pbihkc3QsIG5hbWUpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzeW1saW5rcyBhbmQgb3MucGF0aC5pc2xpbmsoc3JjbmFtZSk6CiAgICAgICAgICAgICAgICBsaW5rdG8gPSBvcy5yZWFkbGluayhzcmNuYW1lKQogICAgICAgICAgICAgICAgb3Muc3ltbGluayhsaW5rdG8sIGRzdG5hbWUpCiAgICAgICAgICAgIGVsaWYgb3MucGF0aC5pc2RpcihzcmNuYW1lKToKICAgICAgICAgICAgICAgIGNvcHl0cmVlKHNyY25hbWUsIGRzdG5hbWUsIHN5bWxpbmtzLCBpZ25vcmUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBjb3B5MihzcmNuYW1lLCBkc3RuYW1lKQogICAgICAgIGV4Y2VwdCBFcnJvciwgZXJyOgogICAgICAgICAgICBlcnJvcnMuZXh0ZW5kKGVyci5hcmdzWzBdKQogICAgICAgIGV4Y2VwdCBFbnZpcm9ubWVudEVycm9yLCB3aHk6CiAgICAgICAgICAgIGVycm9ycy5hcHBlbmQoKHNyY25hbWUsIGRzdG5hbWUsIHN0cih3aHkpKSkKICAgIHRyeToKICAgICAgICBjb3B5c3RhdChzcmMsIGRzdCkKICAgIGV4Y2VwdCBPU0Vycm9yLCB3aHk6CiAgICAgICAgZXJyb3JzLmV4dGVuZCgoc3JjLCBkc3QsIHN0cih3aHkpKSkKICAgIGlmIGVycm9yczoKICAgICAgICByYWlzZSBFcnJvciwgZXJyb3Jz"))
